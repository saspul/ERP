--------------------------------------------------------
--  File created - Monday-June-01-2020   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Package PMS_PURCHASE_ORDER
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE "PMS_PURCHASE_ORDER" AS 

PROCEDURE SP_READ_MODE_OF_SUPPLY(
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_PROJECTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_DIVID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_WAREHOUSE(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VENDORS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VENDORCNTCTPRSN(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_VENDORID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_DOCUMNT_WRKFLOW(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_DIVISION(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_CUSTOMERS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_DIVSNID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_POCONTACTPRSNS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CUSTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_PRODUCTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VEHICLES(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_EMPLOYEEDTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_EMPID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE READ_PRODUCT_TAX_DTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PRDCTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USRID IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_REF IN VARCHAR2,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
);

PROCEDURE SP_INSERT_PRODUCT_DTLS(
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
);

PROCEDURE SP_READ_PURCHASE_ORDER_LIST(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SUPLIR_ID IN NUMBER,
P_STRTDATE IN DATE,
P_ENDDATE IN DATE,
P_WRKFLW_ID IN NUMBER,
P_STATUS IN NUMBER,
P_CNCLSTS IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_PRCHSORDR_REFNO IN VARCHAR2,
P_SEARCH_PRCHSORDR_VENDOR IN VARCHAR2,
P_SEARCH_PRCHSORDR_DOCMNT IN VARCHAR2,
P_SEARCH_PRCHSORDR_DLVRYDT IN VARCHAR2,
P_SEARCH_PRCHSORDR_AMNT IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_CANCEL_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CNCLREASON IN VARCHAR2,
P_USRID IN NUMBER
);

PROCEDURE SP_READ_PURCHS_ORDER_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_PURCHS_ORDER_DTLS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_UPDATE_PURCHASE_ORDER(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
);

PROCEDURE SP_UPDATE_PRODUCT_DTLS(
P_DTLID IN NUMBER,
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
);

PROCEDURE SP_CANCEL_PRODUCT_DTLS_ORATTCH(
P_DTLID IN NUMBER,
P_USRID IN NUMBER,
P_MODE IN NUMBER
);

PROCEDURE SP_CONFIRM_REOPEN_PRCHS_ORDER(
P_ID IN NUMBER,
P_STATUS IN NUMBER,
P_USRID IN NUMBER
);

PROCEDURE SP_READ_CHARGEHEADS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CHRGHDID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_INSERT_CHARGE_HEADS(
P_ID IN NUMBER,
P_CHRGHD_ID IN NUMBER,
P_PRCHSORDR_CHRGAMNT IN DECIMAL
);

PROCEDURE SP_INSERT_ATTCHMNTS(
P_ID IN NUMBER,
P_PRCHSORDRATCH_FILE_NAME IN VARCHAR2,
P_PRCHSORDRATCH_FILE_ACTNM IN VARCHAR2,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
);

PROCEDURE SP_DELETE_CHRGHEAD(
P_ID IN NUMBER,
P_MODE IN NUMBER
);

PROCEDURE SP_READ_ATTACHMENTS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_CHARGEHEADS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_UPDATE_ATTCHMNTS(
P_DTLID IN NUMBER,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
);

PROCEDURE SP_INSERT_COMMENTDTLS(
P_PRCHSORDR_ID IN NUMBER,
P_PRCHSORDRCMNT_VISBLSTS IN NUMBER,
P_PRCHSORDRCMNT_COMMENT IN VARCHAR2,
P_PRCHSORDRCMNT_INS_USR_ID IN NUMBER
);

PROCEDURE SP_READ_COMMENTDTLS(
P_PRCHSORDR_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_PRCHSORDRNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_NOTEID OUT NUMBER
);

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_PRCHSORDRATCHNT_FILENM IN VARCHAR2,
P_PRCHSORDRATCHNT_FILEACTNM IN VARCHAR2,
P_PRCHSORDRATCHNT_TYPE IN NUMBER
);

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_PRCHSORDRNOTE_REPLY_MSG IN VARCHAR2
);

PROCEDURE SP_INSERT_SUPPLIER_CONTACT(
L_SUPLIER_ID IN NUMBER,
L_CONTACTNAME IN VARCHAR2,
L_CONTACTADDRESS IN VARCHAR2,
L_CONTACTMOBILE IN VARCHAR2,
L_CONTACTPHONE IN VARCHAR2,
L_CONTACTWEBSITE IN VARCHAR2,
L_CONTACTEMAIL IN VARCHAR2,
L_ID IN NUMBER
);

PROCEDURE SP_DELETE_SUPPLIER_CONTACT(
L_ID IN NUMBER
);

PROCEDURE SP_READ_CONTACTDTLS_BYID(
P_MODE IN NUMBER,
P_CONTACT_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

END PMS_PURCHASE_ORDER;

/
--------------------------------------------------------
--  DDL for Package Body PMS_PURCHASE_ORDER
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PMS_PURCHASE_ORDER" AS

PROCEDURE SP_READ_MODE_OF_SUPPLY(
P_OUT OUT SYS_REFCURSOR) AS
BEGIN
OPEN P_OUT FOR
SELECT * FROM PMS_MODE_OF_SUPPLY;
END SP_READ_MODE_OF_SUPPLY;

PROCEDURE SP_READ_PROJECTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_DIVID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_DIVID=0) THEN
OPEN P_OUT FOR
SELECT PROJECT_ID,PROJECT_NAME FROM GN_PROJECTS WHERE PROJECT_CNCL_USR_ID IS NULL AND PROJECT_STATUS=1
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID IN (SELECT CPRDIV_ID FROM GN_USER_DIVISION WHERE USER_ID=P_USERID);
ELSE
OPEN P_OUT FOR
SELECT PROJECT_ID,PROJECT_NAME FROM GN_PROJECTS WHERE PROJECT_CNCL_USR_ID IS NULL AND PROJECT_STATUS=1
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID=P_DIVID;
END IF;
END SP_READ_PROJECTS;

PROCEDURE SP_READ_WAREHOUSE(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_PROJECTID=0) THEN
OPEN P_OUT FOR
SELECT WRHS_ID,WRHS_NAME,null "PROJECTS_WAREHOUSE_PRIMARY_ID" FROM PMS_WAREHOUSE_MSTR WHERE WRHS_CNCL_USR_ID IS NULL AND WRHS_STATUS=1
AND PMS_WAREHOUSE_MSTR.CORPRT_ID=P_CORPID AND PMS_WAREHOUSE_MSTR.ORG_ID=P_ORGID;
ELSE
OPEN P_OUT FOR
SELECT WRHS_ID,WRHS_NAME,PROJECTS_WAREHOUSE_PRIMARY_ID FROM PMS_WAREHOUSE_MSTR
LEFT JOIN GN_PROJECTS ON PMS_WAREHOUSE_MSTR.WRHS_ID IN 
(select regexp_substr(PROJECTS_WAREHOUSE_IDS,'[^,]+', 1, level) from dual
connect by regexp_substr(PROJECTS_WAREHOUSE_IDS, '[^,]+', 1, level) is not null) 
AND PROJECT_ID=P_PROJECTID
WHERE WRHS_CNCL_USR_ID IS NULL AND WRHS_STATUS=1
AND PMS_WAREHOUSE_MSTR.CORPRT_ID=P_CORPID AND PMS_WAREHOUSE_MSTR.ORG_ID=P_ORGID;
END IF;
END SP_READ_WAREHOUSE;

PROCEDURE SP_READ_VENDORS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT SUPLIR_ID,SUPLIR_NAME FROM FMS_SUPPLIER_MASTER WHERE SUPLIR_CNCL_USR_ID IS NULL AND SUPLIR_STS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND UPPER(SUPLIR_NAME) LIKE UPPER('%'||P_SEARCHSTRING||'%') ;
END SP_READ_VENDORS;

PROCEDURE SP_READ_VENDORCNTCTPRSN(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_VENDORID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT SUPLIR_CNTCT_ID,SUPLIR_CNTCT_NAME,SUPLIR_CNTCT_ADDRESS,SUPLIR_CNTCT_MOBILE,SUPLIR_CNTCT_PHONE,SUPLIR_CNTCT_WEBSITE,SUPLIR_CNTCT_EMAIL,
FMS_SUPPLIER_MASTER.SUPLIR_RATING,FMS_SUPPLIER_MASTER.VNDRCTGRY_ID,VNDRCTGRY_NAME,SUPLIR_CONTACTNO
FROM FMS_SUPPLIER_MASTER
LEFT JOIN FMS_SUPPLIER_CONTACT ON FMS_SUPPLIER_MASTER.SUPLIR_ID=FMS_SUPPLIER_CONTACT.SUPLIR_ID
LEFT JOIN PMS_VENDOR_CATGRY ON FMS_SUPPLIER_MASTER.VNDRCTGRY_ID=PMS_VENDOR_CATGRY.VNDRCTGRY_ID
WHERE SUPLIR_CNCL_USR_ID IS NULL AND SUPLIR_STS=1 
AND FMS_SUPPLIER_MASTER.CORPRT_ID=P_CORPID AND FMS_SUPPLIER_MASTER.ORG_ID=P_ORGID AND FMS_SUPPLIER_MASTER.SUPLIR_ID=P_VENDORID;
END SP_READ_VENDORCNTCTPRSN;

PROCEDURE SP_READ_DOCUMNT_WRKFLOW(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT WRKFLW_ID,WRKFLW_NAME FROM PMS_DOCUMNT_WRKFLW 
--INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_DOCUMNT_WRKFLW.DOC_ID
WHERE WRKFLW_STATUS=1 AND WRKFLW_CONFRM_STS=1 AND WRKFLW_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID --AND PMS_DOCUMNT_WRKFLW.DOC_ID=1
;
END SP_READ_DOCUMNT_WRKFLOW;

PROCEDURE SP_READ_DIVISION(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_USERID!=0)THEN
OPEN P_OUT FOR
SELECT CPRDIV_ID,CPRDIV_NAME FROM GN_CORP_DIVISIONS WHERE CPRDIV_CNCL_USR_ID IS NULL AND CPRDIV_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID IN (SELECT CPRDIV_ID FROM GN_USER_DIVISION WHERE USER_ID=P_USERID);
ELSE
OPEN P_OUT FOR
SELECT CPRDIV_ID,CPRDIV_NAME FROM GN_CORP_DIVISIONS WHERE CPRDIV_CNCL_USR_ID IS NULL AND CPRDIV_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID;
END IF;
END SP_READ_DIVISION;

PROCEDURE SP_READ_CUSTOMERS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_DIVSNID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT GN_CUSTOMER_MASTER.CSTMR_ID,CSTMR_NAME,GN_PROJECTS.CSTMR_ID "PRJCT_CSTMRID" FROM GN_CUSTOMER_MASTER 
LEFT JOIN GN_PROJECTS ON GN_PROJECTS.CSTMR_ID=GN_CUSTOMER_MASTER.CSTMR_ID AND GN_PROJECTS.PROJECT_ID=P_PROJECTID
WHERE CSTMR_CNCL_USR_ID IS NULL AND CSTMR_STATUS=1 
AND GN_CUSTOMER_MASTER.CORPRT_ID=P_CORPID AND GN_CUSTOMER_MASTER.ORG_ID=P_ORGID;
END SP_READ_CUSTOMERS;

PROCEDURE SP_READ_POCONTACTPRSNS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CUSTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT CSTMRCNT_ID,CSTMRCNT_NAME,CSTMRCNT_ADDRESS,CSTMRCNT_MOBILE,CSTMRCNT_PHONE,CSTMRCNT_EMAIL,CSTMRCNT_WEBSITE,
CSTMRCNT_MAIL_ALWD,CSTMR_MOBILE 
FROM GN_CUSTOMER_CONTACT 
INNER JOIN GN_CUSTOMER_MASTER ON GN_CUSTOMER_MASTER.CSTMR_ID=GN_CUSTOMER_CONTACT.CSTMR_ID
WHERE CSTMR_CNCL_USR_ID IS NULL AND CSTMR_STATUS=1 
AND GN_CUSTOMER_MASTER.CORPRT_ID=P_CORPID AND GN_CUSTOMER_MASTER.ORG_ID=P_ORGID AND GN_CUSTOMER_CONTACT.CSTMR_ID=P_CUSTID;
END SP_READ_POCONTACTPRSNS;

PROCEDURE SP_READ_PRODUCTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT PRDT_ID,(CASE WHEN (PRDT_CODE is not null) THEN PRDT_CODE || '-' ||upper( PRDT_NAME) ELSE upper(PRDT_NAME) END) as PRDT_NAME
FROM GN_PRODUCT_MASTER WHERE PRDT_CNCL_USR_ID IS NULL AND PRDT_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND UPPER(PRDT_NAME) LIKE UPPER('%'||P_SEARCHSTRING||'%');
END SP_READ_PRODUCTS;

PROCEDURE SP_READ_VEHICLES(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT FLT_VEHICLES.VHCL_ID "PRDT_ID",VHCL_NUMBR || '-' || VHCLCLS_NAME "PRDT_NAME" FROM FLT_VEHICLES
INNER JOIN FLT_VEHICLE_CLASS ON FLT_VEHICLE_CLASS.VHCLCLS_ID=FLT_VEHICLES.VHCLCLS_ID
WHERE VHCL_CNCL_USR_ID IS NULL AND VHCL_STATUS=1 
AND FLT_VEHICLES.CORPRT_ID=P_CORPID AND FLT_VEHICLES.ORG_ID=P_ORGID AND UPPER(VHCL_NUMBR) LIKE UPPER('%'||P_SEARCHSTRING||'%');
END SP_READ_VEHICLES;

PROCEDURE SP_READ_EMPLOYEEDTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_EMPID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT USR_CODE,
(SELECT 
TO_CHAR(SYS_XMLAGG (XMLELEMENT (CPRDIV_NAME, CPRDIV_NAME || ',')).EXTRACT ('/ROWSET/CPRDIV_NAME/text()').getclobval ())
FROM GN_USER_DIVISION 
INNER JOIN GN_CORP_DIVISIONS ON GN_CORP_DIVISIONS.CPRDIV_ID=GN_USER_DIVISION.CPRDIV_ID
WHERE GN_USER_DIVISION.ORG_ID=P_ORGID AND USER_ID=P_EMPID AND USRDIV_PRIMARY_STS=1
) "CPRDIV_NAME"
FROM GN_USERS 
WHERE CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND USR_ID=P_EMPID;
END SP_READ_EMPLOYEEDTLS;

PROCEDURE READ_PRODUCT_TAX_DTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PRDCTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS
MONEY_DECIMALCOUNT NUMBER(16);
BEGIN
SELECT GN_MNEY_DECIMAL_CNT INTO MONEY_DECIMALCOUNT FROM GN_CORP_GLOBAL WHERE CORPRT_ID=P_CORPID;
OPEN P_OUT FOR
SELECT FORMAT_DECIMAL(PRDT_COST_PRICE ,MONEY_DECIMALCOUNT) "PRDT_COST_PRICE",
GN_TAX_MASTER.TAX_ID,GN_TAX_MASTER.TAX_NAME,GN_TAX_MASTER.TAX_PERCENTAGE
FROM GN_PRODUCT_MASTER
LEFT JOIN GN_TAX_MASTER ON GN_PRODUCT_MASTER.TAX_ID=GN_TAX_MASTER.TAX_ID
WHERE GN_PRODUCT_MASTER.PRDT_ID=P_PRDCTID;
END READ_PRODUCT_TAX_DTLS;

PROCEDURE SP_INSERT_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USRID IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_REF IN VARCHAR2,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_MASTER
(
PRCHSORDR_ID,
PRCHSORDR_TYPE,
WRKFLW_ID,
PRCHSORDR_REF,
PRCHSORDR_DATE,
PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME,
PRCHSORDR_ENDCSTMRNAME,
PRCHSORDR_DLVRYTO_STS,
WRHS_ID,
PRCHSORDR_DLVRLCTN_WRHS,
PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO,
PRCHSORDR_QTNDATE,
SUPLIR_ID,
PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID,
PRCHSORDR_VENDOR_CONTCTNAME,
PRCHSORDR_VENDOR_ADDRSS,
PRCHSORDR_VENDOR_MOBILE,
PRCHSORDR_VENDOR_PHONE,
PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL,
PRCHSORDR_VENDOR_FUTUREUSE,
PRCHSORDR_VENDOR_COMMNTS,
CPRDIV_ID,
PROJECT_ID,
CSTMR_ID,
PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY,
PRCHSORDR_PO_CONTACTPRSN_ID,
PRCHSORDR_PO_MOBILE,
PRCHSORDR_PO_REQSTNNO,
PRCHSORDR_PO_REQSTNDATE,
PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY,
PRCHSORDR_JOBCODE,
PRCHSORDR_JOBDESCRPTN,
CRNCMST_ID,
PRCHSORDR_EXCHNG_RATE,
PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL,
PRCHSORDR_TAX_TOTAL,
PRCHSORDR_DISCOUNT,
PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM,
PRCHSORDR_TERM_CNDTNS,
PRCHSORDR_FRGHT_TERM,
CORPRT_ID,
ORG_ID,
PRCHSORDR_INS_USR_ID,
PRCHSORDR_INS_DATE
)
VALUES
(
P_ID,
P_PRCHSORDR_TYPE,
P_WRKFLW_ID,
P_PRCHSORDR_REF,
P_PRCHSORDR_DATE,
P_PRCHSORDR_DLVRYDT,
P_PRCHSORDR_CLIENTNAME,
P_PRCHSORDR_ENDCSTMRNAME,
P_PRCHSORDR_DLVRYTO_STS,
P_WRHS_ID,
P_PRCHSORDR_DLVRLCTN_WRHS,
P_PRCHSORDR_DLVRLCTN_PRJCT,
P_PRCHSORDR_QTNNO,
P_PRCHSORDR_QTNDATE,
P_SUPLIR_ID,
P_PRCHSORDR_VENDOR_REFNO,
P_PRCHSORDR_VENDOR_CONTCT_ID,
P_PRCHSORDR_VENDOR_CONTCTNAME,
P_PRCHSORDR_VENDOR_ADDRSS,
P_PRCHSORDR_VENDOR_MOBILE,
P_PRCHSORDR_VENDOR_PHONE,
P_PRCHSORDR_VENDOR_FAX,
P_PRCHSORDR_VENDOR_EMAIL,
P_PRCHSORDR_VENDOR_FUTUREUSE,
P_PRCHSORDR_VENDOR_COMMNTS,
P_CPRDIV_ID,
P_PROJECT_ID,
P_CSTMR_ID,
P_PRCHSORDR_REQRMNTDATE,
P_PRCHSORDR_MODOFSUPPLY,
P_PRCHSORDR_PO_CONTACTPRSN_ID,
P_PRCHSORDR_PO_MOBILE,
P_PRCHSORDR_PO_REQSTNNO,
P_PRCHSORDR_PO_REQSTNDATE,
P_PRCHSORDR_PO_APPRVLDATE,
P_PRCHSORDR_PRIORTY,
P_PRCHSORDR_JOBCODE,
P_PRCHSORDR_JOBDESCRPTN,
P_CRNCMST_ID,
P_PRCHSORDR_EXCHNG_RATE,
P_PRCHSORDR_AMNT_EXCNG,
P_PRCHSORDR_GROSS_TOTAL,
P_PRCHSORDR_TAX_TOTAL,
P_PRCHSORDR_DISCOUNT,
P_PRCHSORDR_NET_TOTAL,
P_PRCHSORDR_PAYMT_TERM,
P_PRCHSORDR_TERM_CNDTNS,
P_PRCHSORDR_FRGHT_TERM,
P_CORPID,
P_ORGID,
P_USRID,
SYSDATE
);
END SP_INSERT_PURCHASE_ORDER;

PROCEDURE SP_INSERT_PRODUCT_DTLS(
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_DTLS
(
PRCHSORDR_DTL_ID,
PRCHSORDR_ID,
PRCHSORDR_DTL_QNTY,
PRCHSORDR_DTL_RATE,
PRCHSORDR_DTL_TOTLAMNT,
PRDT_ID,
PRCHSORDR_DTL_DISCNTPCNT,
PRCHSORDR_DTL_DISCNTAMT,
PRCHSORDR_DTL_TAXID,
PRCHSORDR_DTL_TAXPRCNT,
VHCL_ID,
PRCHSORDR_DTL_STRTDATE,
PRCHSORDR_DTL_ENDDATE,
USR_ID,
PRCHSORDR_DTL_PNRNO,
PRCHSORDR_DTL_SECTOR,
PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS,
PRCHSORDR_DTL_SLNO
)
VALUES
(
SEQ_PMS_PRCHSORDRDTL_ID.NEXTVAL,
P_ID,
P_PRCHSORDR_DTL_QNTY,
P_PRCHSORDR_DTL_RATE,
P_PRCHSORDR_DTL_TOTLAMNT,
P_PRDT_ID,
P_PRCHSORDR_DTL_DISCNTPCNT,
P_PRCHSORDR_DTL_DISCNTAMT,
P_PRCHSORDR_DTL_TAXID,
P_PRCHSORDR_DTL_TAXPRCNT,
P_VHCL_ID,
P_PRCHSORDR_DTL_STRTDATE,
P_PRCHSORDR_DTL_ENDDATE,
P_USR_ID,
P_PRCHSORDR_DTL_PNRNO,
P_PRCHSORDR_DTL_SECTOR,
P_PRCHSORDR_DTL_TRVLDATE,
P_PRCHSORDR_DTL_REMARKS,
P_PRCHSORDR_DTL_SLNO
);
END SP_INSERT_PRODUCT_DTLS;

PROCEDURE SP_READ_PURCHASE_ORDER_LIST(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SUPLIR_ID IN NUMBER,
P_STRTDATE IN DATE,
P_ENDDATE IN DATE,
P_WRKFLW_ID IN NUMBER,
P_STATUS IN NUMBER,
P_CNCLSTS IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_PRCHSORDR_REFNO IN VARCHAR2,
P_SEARCH_PRCHSORDR_VENDOR IN VARCHAR2,
P_SEARCH_PRCHSORDR_DOCMNT IN VARCHAR2,
P_SEARCH_PRCHSORDR_DLVRYDT IN VARCHAR2,
P_SEARCH_PRCHSORDR_AMNT IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS
T_QUERY VARCHAR2(5000);
T_GETDATA VARCHAR2(5000);
MONEY_DECIMALCOUNT NUMBER(16);
BEGIN

SELECT GN_MNEY_DECIMAL_CNT INTO MONEY_DECIMALCOUNT FROM GN_CORP_GLOBAL WHERE CORPRT_ID=P_CORPID;

T_GETDATA:='SELECT PRCHSORDR_ID,TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') PRCHSORDR_DATE,PRCHSORDR_REF,SUPLIR_NAME,WRKFLW_NAME,
PRCHSORDR_CONFRM_STS,TO_CHAR(PRCHSORDR_DLVRYDT,''DD-MM-YYYY'') PRCHSORDR_DLVRYDT,
FORMAT_DECIMAL(PRCHSORDR_NET_TOTAL,'||MONEY_DECIMALCOUNT||') PRCHSORDR_NET_TOTAL,PRCHSORDR_REOPN_USR_ID,
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_NOTEDTLS WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND USR_ID='||P_USRID||' AND PRCHSORDRNOTE_REPLYSTS=0) "NOTECNT",
DECODE(PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE,1,''PRODUCTS'',2,''CAR RENTAL'',3,''AIR TICKET'')"PO_TYP"
FROM PMS_PURCHASE_ORDER_MASTER 
INNER JOIN FMS_SUPPLIER_MASTER ON FMS_SUPPLIER_MASTER.SUPLIR_ID=PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
WHERE PMS_PURCHASE_ORDER_MASTER.CORPRT_ID='||P_CORPID||' AND PMS_PURCHASE_ORDER_MASTER.ORG_ID='||P_ORGID||'';
IF(P_PRCHSORDR_TYPE!=0) THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE='||P_PRCHSORDR_TYPE||'';
END IF;
IF(P_SUPLIR_ID!=0)THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID='||P_SUPLIR_ID||'';
END IF;
IF(P_WRKFLW_ID!=0)THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID='||P_WRKFLW_ID||'';
END IF;
IF(P_STRTDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')>=TO_DATE('''||P_STRTDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_ENDDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')<=TO_DATE('''||P_ENDDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_STATUS!=3) THEN
IF(P_STATUS!=2)THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CONFRM_STS='||P_STATUS||'';
END IF;
IF(P_STATUS=2) THEN--REOPEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CONFRM_STS=0 AND PRCHSORDR_REOPN_USR_ID IS NOT NULL';
ELSIF(P_STATUS=0)THEN--PENDING
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_REOPN_USR_ID IS NULL';
END IF;

END IF;
IF(P_CNCLSTS=1) THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CNCL_USR_ID IS NOT NULL';
ELSE
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CNCL_USR_ID IS NULL';
END IF;

------------------------------FOR SEARCH----------------------------
IF(P_COMMON_SEARCH_TERM IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' 
AND
(
(PRCHSORDR_DATE LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%'' OR TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') LIKE ''%''||TO_CHAR('''||P_COMMON_SEARCH_TERM||''',''DD-MM-YYYY'')||''%'')
OR UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(SUPLIR_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR (PRCHSORDR_DLVRYDT LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%'' OR TO_CHAR(PRCHSORDR_DLVRYDT,''DD-MM-YYYY'') LIKE ''%''||TO_CHAR('''||P_COMMON_SEARCH_TERM||''',''DD-MM-YYYY'')||''%'')
OR PRCHSORDR_NET_TOTAL LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%'' = ''''
)';
END IF;

IF(P_SEARCH_PRCHSORDR_DATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' (PRCHSORDR_DATE LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DATE||'''||''%'' OR TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') LIKE ''%''||TO_CHAR('''||P_SEARCH_PRCHSORDR_DATE||''',''DD-MM-YYYY'')||''%'')';
END IF;
IF(P_SEARCH_PRCHSORDR_REFNO IS NOT NULL AND P_SEARCH_PRCHSORDR_REFNO!='')THEN
T_GETDATA:=T_GETDATA||' UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_REFNO||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_VENDOR IS NOT NULL AND P_SEARCH_PRCHSORDR_VENDOR!='')THEN
T_GETDATA:=T_GETDATA||' UPPER(SUPLIR_NAME) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_VENDOR||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_DOCMNT IS NOT NULL AND P_SEARCH_PRCHSORDR_DOCMNT!='')THEN
T_GETDATA:=T_GETDATA||' UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_DOCMNT||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_DLVRYDT IS NOT NULL AND P_SEARCH_PRCHSORDR_DLVRYDT!='')THEN
T_GETDATA:=T_GETDATA||' (PRCHSORDR_DLVRYDT LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DLVRYDT||'''||''%'' OR TO_CHAR(PRCHSORDR_DLVRYDT,''DD-MM-YYYY'') LIKE ''%''||TO_CHAR('''||P_SEARCH_PRCHSORDR_DLVRYDT||''',''DD-MM-YYYY'')||''%'')';
END IF;
IF(P_SEARCH_PRCHSORDR_AMNT IS NOT NULL AND P_SEARCH_PRCHSORDR_AMNT!='')THEN
T_GETDATA:=T_GETDATA||' PRCHSORDR_NET_TOTAL LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_AMNT||''')||''%''';
END IF;

------------------------------FOR SEARCH----------------------------

IF(P_ORDER_COLUMN=0)THEN--1st load
T_GETDATA:=T_GETDATA||' ORDER BY PRCHSORDR_ID DESC';

ELSE
IF(P_ORDER_METHOD=0)THEN
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' ASC';
ELSE
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' DESC';
END IF;

END IF;

------------------------------FOR PAGEINATION-----------------------
T_QUERY:=
'SELECT * FROM 
(
select val.*, ROWNUM rnum,
(SELECT COUNT(*) FROM (
'||T_GETDATA||'
)) CNT
from
(
'||T_GETDATA||'
) val
where ROWNUM <= ('||P_PAGE_NUMBER||'*'||P_PAGE_MAXSIZE||')
)
where rnum  >= ((('||P_PAGE_NUMBER||' - 1) * '||P_PAGE_MAXSIZE||') + 1)
';

------------------------------FOR PAGEINATION-----------------------

OPEN P_OUT FOR T_QUERY;
--createfile(T_QUERY,'PRCHSORDR');
END SP_READ_PURCHASE_ORDER_LIST;

PROCEDURE SP_CANCEL_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CNCLREASON IN VARCHAR2,
P_USRID IN NUMBER
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_CNCL_USR_ID=P_USRID,
PRCHSORDR_CNCL_DATE=SYSDATE,
PRCHSORDR_CNCL_REASN=P_CNCLREASON
WHERE PRCHSORDR_ID=P_ID;
END SP_CANCEL_PURCHASE_ORDER;

PROCEDURE SP_READ_PURCHS_ORDER_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_TYPE,PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID,
PRCHSORDR_REF,TO_CHAR(PRCHSORDR_DATE,'DD-MM-YYYY') PRCHSORDR_DATE,TO_CHAR(PRCHSORDR_DLVRYDT,'DD-MM-YYYY') PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME,PRCHSORDR_ENDCSTMRNAME,PRCHSORDR_DLVRYTO_STS,WRHS_ID,PRCHSORDR_DLVRLCTN_WRHS,PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO,TO_CHAR(PRCHSORDR_QTNDATE,'DD-MM-YYYY') PRCHSORDR_QTNDATE,PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID,PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID,PRCHSORDR_VENDOR_ADDRSS,PRCHSORDR_VENDOR_MOBILE,PRCHSORDR_VENDOR_PHONE,PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL,PRCHSORDR_VENDOR_FUTUREUSE,PRCHSORDR_VENDOR_COMMNTS,
PMS_PURCHASE_ORDER_MASTER.CPRDIV_ID,PROJECT_ID,CSTMR_ID,TO_CHAR(PRCHSORDR_REQRMNTDATE,'DD-MM-YYYY')PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY,PRCHSORDR_PO_CONTACTPRSN_ID,PRCHSORDR_PO_MOBILE,PRCHSORDR_PO_REQSTNNO,
TO_CHAR(PRCHSORDR_PO_REQSTNDATE,'DD-MM-YYYY') PRCHSORDR_PO_REQSTNDATE,TO_CHAR(PRCHSORDR_PO_APPRVLDATE,'DD-MM-YYYY') PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY,PRCHSORDR_JOBCODE,PRCHSORDR_JOBDESCRPTN,PMS_PURCHASE_ORDER_MASTER.CRNCMST_ID,PRCHSORDR_CNCL_USR_ID,
PRCHSORDR_EXCHNG_RATE,PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL,PRCHSORDR_TAX_TOTAL,PRCHSORDR_DISCOUNT,PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM,PRCHSORDR_TERM_CNDTNS,PRCHSORDR_FRGHT_TERM,CPRDIV_NAME,SUPLIR_NAME,WRKFLW_NAME,
PRCHSORDR_CONFRM_STS,PRCHSORDR_REOPN_USR_ID,PRCHSORDR_VENDOR_CONTCTNAME,
(SELECT COUNT(*) FROM FMS_SUPPLIER_CONTACT WHERE FMS_SUPPLIER_CONTACT.PRCHSORDR_ID=P_ID) "CNTCNTCT"
FROM PMS_PURCHASE_ORDER_MASTER 
INNER JOIN GN_CORP_DIVISIONS ON GN_CORP_DIVISIONS.CPRDIV_ID=PMS_PURCHASE_ORDER_MASTER.CPRDIV_ID
INNER JOIN FMS_SUPPLIER_MASTER ON FMS_SUPPLIER_MASTER.SUPLIR_ID=PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
WHERE PRCHSORDR_ID=P_ID;
END SP_READ_PURCHS_ORDER_BYID;

PROCEDURE SP_READ_PURCHS_ORDER_DTLS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_DTL_ID,PRCHSORDR_DTL_SLNO,
PRCHSORDR_DTL_QNTY,PRCHSORDR_DTL_RATE,PRCHSORDR_DTL_TOTLAMNT,
PMS_PURCHASE_ORDER_DTLS.PRDT_ID,PRCHSORDR_DTL_DISCNTPCNT,PRCHSORDR_DTL_DISCNTAMT,PRCHSORDR_DTL_TAXID,PRCHSORDR_DTL_TAXPRCNT,
PMS_PURCHASE_ORDER_DTLS.VHCL_ID,
TO_CHAR(PRCHSORDR_DTL_STRTDATE,'DD-MM-YYYY') PRCHSORDR_DTL_STRTDATE,
TO_CHAR(PRCHSORDR_DTL_ENDDATE,'DD-MM-YYYY') PRCHSORDR_DTL_ENDDATE,
PMS_PURCHASE_ORDER_DTLS.USR_ID,
PRCHSORDR_DTL_PNRNO,PRCHSORDR_DTL_SECTOR,
TO_CHAR(PRCHSORDR_DTL_TRVLDATE,'DD-MM-YYYY') PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS,TAX_NAME,
(CASE WHEN (PRDT_CODE is not null) THEN PRDT_CODE || '-' ||upper( PRDT_NAME) ELSE upper(PRDT_NAME) END) as PRDT_NAME,
VHCL_NUMBR || '-' || VHCLCLS_NAME "VHCL_NUMBR",
USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME",
USR_CODE||'-'||USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME_CODE"
FROM PMS_PURCHASE_ORDER_DTLS
LEFT JOIN GN_PRODUCT_MASTER ON GN_PRODUCT_MASTER.PRDT_ID=PMS_PURCHASE_ORDER_DTLS.PRDT_ID
LEFT JOIN GN_USERS ON GN_USERS.USR_ID=PMS_PURCHASE_ORDER_DTLS.USR_ID
LEFT JOIN FLT_VEHICLES ON FLT_VEHICLES.VHCL_ID=PMS_PURCHASE_ORDER_DTLS.VHCL_ID
LEFT JOIN FLT_VEHICLE_CLASS ON FLT_VEHICLE_CLASS.VHCLCLS_ID=FLT_VEHICLES.VHCLCLS_ID
LEFT JOIN GN_TAX_MASTER ON PMS_PURCHASE_ORDER_DTLS.PRCHSORDR_DTL_TAXID=GN_TAX_MASTER.TAX_ID
WHERE PRCHSORDR_ID=P_ID AND PRCHSORDR_DTL_CNCL_USRID IS NULL ORDER BY PRCHSORDR_DTL_SLNO;
END SP_READ_PURCHS_ORDER_DTLS_BYID;

PROCEDURE SP_UPDATE_PURCHASE_ORDER(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_MASTER SET
WRKFLW_ID=P_WRKFLW_ID,
PRCHSORDR_DATE=P_PRCHSORDR_DATE,
PRCHSORDR_DLVRYDT=P_PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME=P_PRCHSORDR_CLIENTNAME,
PRCHSORDR_ENDCSTMRNAME=P_PRCHSORDR_ENDCSTMRNAME,
PRCHSORDR_DLVRYTO_STS=P_PRCHSORDR_DLVRYTO_STS,
WRHS_ID=P_WRHS_ID,
PRCHSORDR_DLVRLCTN_WRHS=P_PRCHSORDR_DLVRLCTN_WRHS,
PRCHSORDR_DLVRLCTN_PRJCT=P_PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO=P_PRCHSORDR_QTNNO,
PRCHSORDR_QTNDATE=P_PRCHSORDR_QTNDATE,
SUPLIR_ID=P_SUPLIR_ID,
PRCHSORDR_VENDOR_REFNO=P_PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID=P_PRCHSORDR_VENDOR_CONTCT_ID,
PRCHSORDR_VENDOR_CONTCTNAME=P_PRCHSORDR_VENDOR_CONTCTNAME,
PRCHSORDR_VENDOR_ADDRSS=P_PRCHSORDR_VENDOR_ADDRSS,
PRCHSORDR_VENDOR_MOBILE=P_PRCHSORDR_VENDOR_MOBILE,
PRCHSORDR_VENDOR_PHONE=P_PRCHSORDR_VENDOR_PHONE,
PRCHSORDR_VENDOR_FAX=P_PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL=P_PRCHSORDR_VENDOR_EMAIL,
PRCHSORDR_VENDOR_FUTUREUSE=P_PRCHSORDR_VENDOR_FUTUREUSE,
PRCHSORDR_VENDOR_COMMNTS=P_PRCHSORDR_VENDOR_COMMNTS,
CPRDIV_ID=P_CPRDIV_ID,
PROJECT_ID=P_PROJECT_ID,
CSTMR_ID=P_CSTMR_ID,
PRCHSORDR_REQRMNTDATE=P_PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY=P_PRCHSORDR_MODOFSUPPLY,
PRCHSORDR_PO_CONTACTPRSN_ID=P_PRCHSORDR_PO_CONTACTPRSN_ID,
PRCHSORDR_PO_MOBILE=P_PRCHSORDR_PO_MOBILE,
PRCHSORDR_PO_REQSTNNO=P_PRCHSORDR_PO_REQSTNNO,
PRCHSORDR_PO_REQSTNDATE=P_PRCHSORDR_PO_REQSTNDATE,
PRCHSORDR_PO_APPRVLDATE=P_PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY=P_PRCHSORDR_PRIORTY,
PRCHSORDR_JOBCODE=P_PRCHSORDR_JOBCODE,
PRCHSORDR_JOBDESCRPTN=P_PRCHSORDR_JOBDESCRPTN,
CRNCMST_ID=P_CRNCMST_ID,
PRCHSORDR_EXCHNG_RATE=P_PRCHSORDR_EXCHNG_RATE,
PRCHSORDR_AMNT_EXCNG=P_PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL=P_PRCHSORDR_GROSS_TOTAL,
PRCHSORDR_TAX_TOTAL=P_PRCHSORDR_TAX_TOTAL,
PRCHSORDR_DISCOUNT=P_PRCHSORDR_DISCOUNT,
PRCHSORDR_NET_TOTAL=P_PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM=P_PRCHSORDR_PAYMT_TERM,
PRCHSORDR_TERM_CNDTNS=P_PRCHSORDR_TERM_CNDTNS,
PRCHSORDR_FRGHT_TERM=P_PRCHSORDR_FRGHT_TERM,
PRCHSORDR_UPD_USR_ID=P_USRID,
PRCHSORDR_UPD_DATE=SYSDATE
WHERE PRCHSORDR_ID=P_ID;
END SP_UPDATE_PURCHASE_ORDER;

PROCEDURE SP_UPDATE_PRODUCT_DTLS(
P_DTLID IN NUMBER,
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_DTLS SET
PRCHSORDR_DTL_QNTY=P_PRCHSORDR_DTL_QNTY,
PRCHSORDR_DTL_RATE=P_PRCHSORDR_DTL_RATE,
PRCHSORDR_DTL_TOTLAMNT=P_PRCHSORDR_DTL_TOTLAMNT,
PRDT_ID=P_PRDT_ID,
PRCHSORDR_DTL_DISCNTPCNT=P_PRCHSORDR_DTL_DISCNTPCNT,
PRCHSORDR_DTL_DISCNTAMT=P_PRCHSORDR_DTL_DISCNTAMT,
PRCHSORDR_DTL_TAXID=P_PRCHSORDR_DTL_TAXID,
PRCHSORDR_DTL_TAXPRCNT=P_PRCHSORDR_DTL_TAXPRCNT,
VHCL_ID=P_VHCL_ID,
PRCHSORDR_DTL_STRTDATE=P_PRCHSORDR_DTL_STRTDATE,
PRCHSORDR_DTL_ENDDATE=P_PRCHSORDR_DTL_ENDDATE,
USR_ID=P_USR_ID,
PRCHSORDR_DTL_PNRNO=P_PRCHSORDR_DTL_PNRNO,
PRCHSORDR_DTL_SECTOR=P_PRCHSORDR_DTL_SECTOR,
PRCHSORDR_DTL_TRVLDATE=P_PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS=P_PRCHSORDR_DTL_REMARKS,
PRCHSORDR_DTL_SLNO=P_PRCHSORDR_DTL_SLNO
WHERE PRCHSORDR_DTL_ID=P_DTLID;
END SP_UPDATE_PRODUCT_DTLS;

PROCEDURE SP_CANCEL_PRODUCT_DTLS_ORATTCH(
P_DTLID IN NUMBER,
P_USRID IN NUMBER,
P_MODE IN NUMBER
)AS BEGIN
IF(P_MODE=0)THEN--PRODCTDTLS
UPDATE PMS_PURCHASE_ORDER_DTLS SET
PRCHSORDR_DTL_CNCL_USRID=P_USRID
WHERE PRCHSORDR_DTL_ID=P_DTLID;
ELSIF(P_MODE=1)THEN--ATTCHMNT
UPDATE PMS_PURCHASE_ORDER_ATTCHDTLS SET
PRCHSORDRATCH_CNCL_USRID=P_USRID
WHERE PRCHSORDR_ATCHID=P_DTLID;
END IF;
END SP_CANCEL_PRODUCT_DTLS_ORATTCH;

PROCEDURE SP_CONFIRM_REOPEN_PRCHS_ORDER(
P_ID IN NUMBER,
P_STATUS IN NUMBER,
P_USRID IN NUMBER
)AS BEGIN
IF(P_STATUS=1)THEN --CONFIRM

UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_CONFRM_USR_ID=P_USRID,
PRCHSORDR_CONFRM_DATE=SYSDATE,
PRCHSORDR_CONFRM_STS=1
WHERE PRCHSORDR_ID=P_ID;

ELSE              --REOPEN

UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_REOPN_USR_ID=P_USRID,
PRCHSORDR_REOPN_DATE=SYSDATE,
PRCHSORDR_CONFRM_STS=0
WHERE PRCHSORDR_ID=P_ID;

--INSERT INTO


END IF;
END SP_CONFIRM_REOPEN_PRCHS_ORDER;

PROCEDURE SP_READ_CHARGEHEADS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CHRGHDID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_CHRGHDID=0)THEN
OPEN P_OUT FOR
SELECT CHRGHD_ID,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_CHARGE_HEADS WHERE CHRGHD_STATUS=1 AND CHRGHD_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID;
ELSE
OPEN P_OUT FOR
SELECT CHRGHD_ID,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_CHARGE_HEADS WHERE CHRGHD_STATUS=1 AND CHRGHD_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CHRGHD_ID=P_CHRGHDID;
END IF;
END SP_READ_CHARGEHEADS;

PROCEDURE SP_INSERT_CHARGE_HEADS(
P_ID IN NUMBER,
P_CHRGHD_ID IN NUMBER,
P_PRCHSORDR_CHRGAMNT IN DECIMAL
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_CHRGDTLS
(
PRCHSORDR_CHRGID,
PRCHSORDR_ID,
CHRGHD_ID,
PRCHSORDR_CHRGAMNT
)
VALUES
(
SEQ_PMS_PRCHSORDRCHRG_ID.NEXTVAL,
P_ID,
P_CHRGHD_ID,
P_PRCHSORDR_CHRGAMNT
);
END SP_INSERT_CHARGE_HEADS;

PROCEDURE SP_INSERT_ATTCHMNTS(
P_ID IN NUMBER,
P_PRCHSORDRATCH_FILE_NAME IN VARCHAR2,
P_PRCHSORDRATCH_FILE_ACTNM IN VARCHAR2,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_ATTCHDTLS
(
PRCHSORDR_ATCHID,
PRCHSORDR_ID,
PRCHSORDRATCH_FILE_NAME,
PRCHSORDRATCH_FILE_ACTNM,
PRCHSORDRATCH_DESCRPTN
)
VALUES
(
SEQ_PMS_PRCHSORDRATCH_ID.NEXTVAL,
P_ID,
P_PRCHSORDRATCH_FILE_NAME,
P_PRCHSORDRATCH_FILE_ACTNM,
P_PRCHSORDRATCH_DESCRPTN
);
END SP_INSERT_ATTCHMNTS;

PROCEDURE SP_DELETE_CHRGHEAD(
P_ID IN NUMBER,
P_MODE IN NUMBER
)AS BEGIN
DELETE FROM PMS_PURCHASE_ORDER_CHRGDTLS WHERE PRCHSORDR_ID=P_ID;
END SP_DELETE_CHRGHEAD;

PROCEDURE SP_READ_ATTACHMENTS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT * FROM PMS_PURCHASE_ORDER_ATTCHDTLS WHERE PRCHSORDR_ID=P_ID AND PRCHSORDRATCH_CNCL_USRID IS NULL; 
END SP_READ_ATTACHMENTS_BYID;

PROCEDURE SP_READ_CHARGEHEADS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_CHRGID,PMS_PURCHASE_ORDER_CHRGDTLS.CHRGHD_ID,PRCHSORDR_CHRGAMNT,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_PURCHASE_ORDER_CHRGDTLS 
INNER JOIN PMS_CHARGE_HEADS ON PMS_CHARGE_HEADS.CHRGHD_ID=PMS_PURCHASE_ORDER_CHRGDTLS.CHRGHD_ID
WHERE PRCHSORDR_ID=P_ID;
END SP_READ_CHARGEHEADS_BYID;

PROCEDURE SP_UPDATE_ATTCHMNTS(
P_DTLID IN NUMBER,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_ATTCHDTLS SET
PRCHSORDRATCH_DESCRPTN=P_PRCHSORDRATCH_DESCRPTN
WHERE PRCHSORDR_ATCHID=P_DTLID;
END SP_UPDATE_ATTCHMNTS;

PROCEDURE SP_INSERT_COMMENTDTLS(
P_PRCHSORDR_ID IN NUMBER,
P_PRCHSORDRCMNT_VISBLSTS IN NUMBER,
P_PRCHSORDRCMNT_COMMENT IN VARCHAR2,
P_PRCHSORDRCMNT_INS_USR_ID IN NUMBER
)
AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_COMMENTDTLS(PRCHSORDR_CMNTID,PRCHSORDR_ID,
PRCHSORDRCMNT_VISBLSTS,PRCHSORDRCMNT_COMMENT,PRCHSORDRCMNT_INS_USR_ID,PRCHSORDRCMNT_INS_DATE)
VALUES(SEQ_PMS_PRCHSORDRCMNT_ID.NEXTVAL,P_PRCHSORDR_ID,P_PRCHSORDRCMNT_VISBLSTS,P_PRCHSORDRCMNT_COMMENT,P_PRCHSORDRCMNT_INS_USR_ID,CURRENT_TIMESTAMP);

END SP_INSERT_COMMENTDTLS;


PROCEDURE SP_READ_COMMENTDTLS(
P_PRCHSORDR_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDR_CMNTID,PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_VISBLSTS,PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_COMMENT,PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_USR_ID,
PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_DATE,GN_USERS.USR_NAME FROM PMS_PURCHASE_ORDER_COMMENTDTLS
INNER JOIN GN_USERS ON PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_USR_ID=GN_USERS.USR_ID WHERE PRCHSORDR_ID=P_PRCHSORDR_ID;

END SP_READ_COMMENTDTLS;

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID,PRCHSORDRNOTE_MSG,PRCHSORDRNOTE_INS_USR_ID,PRCHSORDR_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "NOTE_TO_USRNAME",
prchsordruser.USR_NAME||' '||prchsordruser.EMPERDTL_MNAME||' '||prchsordruser.EMPERDTL_LNAME "NOTE_INS_USRNAME",
PRCHSORDRNOTE_REPLY_MSG,
PRCHSORDRATCHNT_FILENM,PRCHSORDRATCHNT_FILEACTNM,PRCHSORDRATCHNT_TYPE
FROM PMS_PURCHASE_ORDER_NOTEDTLS 
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID
LEFT JOIN GN_USERS prchsordruser  ON prchsordruser.USR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_INS_USR_ID
LEFT JOIN PMS_PURCHASE_ORDER_NOTE_ATTACH ON PMS_PURCHASE_ORDER_NOTE_ATTACH.PRCHSORDR_NOTEID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID
WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=P_ID AND PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID=P_USRID AND PRCHSORDRNOTE_REPLYSTS=0;
END SP_READ_NOTEDTLS;

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_PRCHSORDRNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_NOTEID OUT NUMBER
)AS BEGIN
SELECT SEQ_PMS_PRCHSORDRNOTE_ID.NEXTVAL INTO P_OUT_NOTEID FROM DUAL;

INSERT INTO PMS_PURCHASE_ORDER_NOTEDTLS
(
PRCHSORDR_NOTEID,
PRCHSORDR_ID,
USR_ID,
PRCHSORDRNOTE_MSG,
PRCHSORDRNOTE_INS_USR_ID,
PRCHSORDRNOTE_INS_DATE
)
VALUES
(
P_OUT_NOTEID,
P_ID,
P_TO_USRID,
P_PRCHSORDRNOTE_MSG,
P_FROM_USRID,
SYSDATE
);
END SP_INSERT_NOTE;

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_PRCHSORDRATCHNT_FILENM IN VARCHAR2,
P_PRCHSORDRATCHNT_FILEACTNM IN VARCHAR2,
P_PRCHSORDRATCHNT_TYPE IN NUMBER
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_NOTE_ATTACH
(
PRCHSORDR_NTATCHID,
PRCHSORDR_NOTEID,
PRCHSORDRATCHNT_FILENM,
PRCHSORDRATCHNT_FILEACTNM,
PRCHSORDRATCHNT_TYPE
)
VALUES
(
SEQ_PMS_PRCHSORDRNTATCH_ID.NEXTVAL,
P_NOTEID,
P_PRCHSORDRATCHNT_FILENM,
P_PRCHSORDRATCHNT_FILEACTNM,
P_PRCHSORDRATCHNT_TYPE
);
END SP_INSERT_NOTE_ATTCH;

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_PRCHSORDRNOTE_REPLY_MSG IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_NOTEDTLS SET
PRCHSORDRNOTE_REPLYSTS=1,
PRCHSORDRNOTE_REPLY_MSG=P_PRCHSORDRNOTE_REPLY_MSG,
PRCHSORDRNOTE_REPLY_DATE=SYSDATE
WHERE PRCHSORDR_NOTEID=P_NOTEID;
END SP_UPDATE_REPLYNOTE;

PROCEDURE SP_INSERT_SUPPLIER_CONTACT(
L_SUPLIER_ID IN NUMBER,
L_CONTACTNAME IN VARCHAR2,
L_CONTACTADDRESS IN VARCHAR2,
L_CONTACTMOBILE IN VARCHAR2,
L_CONTACTPHONE IN VARCHAR2,
L_CONTACTWEBSITE IN VARCHAR2,
L_CONTACTEMAIL IN VARCHAR2,
L_ID IN NUMBER
)AS BEGIN

INSERT INTO FMS_SUPPLIER_CONTACT
(
SUPLIR_CNTCT_ID,
SUPLIR_ID,
SUPLIR_CNTCT_NAME,
SUPLIR_CNTCT_ADDRESS,
SUPLIR_CNTCT_MOBILE,
SUPLIR_CNTCT_PHONE,
SUPLIR_CNTCT_WEBSITE,
SUPLIR_CNTCT_EMAIL,
PRCHSORDR_ID
)
VALUES
(
SEQ_SUPLIR_CONTACT.NEXTVAL,
L_SUPLIER_ID,
L_CONTACTNAME,
L_CONTACTADDRESS,
L_CONTACTMOBILE,
L_CONTACTPHONE,
L_CONTACTWEBSITE,
L_CONTACTEMAIL,
L_ID
);
END SP_INSERT_SUPPLIER_CONTACT;

PROCEDURE SP_DELETE_SUPPLIER_CONTACT(
L_ID IN NUMBER
)AS BEGIN
DELETE FROM FMS_SUPPLIER_CONTACT WHERE PRCHSORDR_ID=L_ID;
END SP_DELETE_SUPPLIER_CONTACT;

PROCEDURE SP_READ_CONTACTDTLS_BYID(
P_MODE IN NUMBER, 
P_CONTACT_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_MODE=0)THEN--VENDOR
OPEN P_OUT FOR
SELECT SUPLIR_CNTCT_ID "CNTCT_ID",SUPLIR_CNTCT_NAME "CNTCT_NAME",SUPLIR_CNTCT_ADDRESS "CNTCT_ADDRSS",SUPLIR_CNTCT_MOBILE "CNTCT_MOBILE",
SUPLIR_CNTCT_PHONE "CNTCT_PHONE",SUPLIR_CNTCT_WEBSITE "CNTC_WEBSITE",SUPLIR_CNTCT_EMAIL "CNTC_EMAIL"
FROM FMS_SUPPLIER_CONTACT WHERE SUPLIR_CNTCT_ID=P_CONTACT_ID;
ELSE
OPEN P_OUT FOR--CSTMR
SELECT CSTMRCNT_ID "CNTCT_ID",CSTMRCNT_NAME "CNTCT_NAME",CSTMRCNT_ADDRESS "CNTCT_ADDRSS",CSTMRCNT_MOBILE "CNTCT_MOBILE",
CSTMRCNT_PHONE "CNTCT_PHONE",CSTMRCNT_EMAIL "CNTC_EMAIL",CSTMRCNT_WEBSITE "CNTC_WEBSITE" 
FROM GN_CUSTOMER_CONTACT WHERE CSTMRCNT_ID=P_CONTACT_ID;
END IF;
END SP_READ_CONTACTDTLS_BYID;

END PMS_PURCHASE_ORDER;

/
