--------------------------------------------------------
--  File created - Thursday-July-02-2020   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Package PMS_APPROVALCONSOLE
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE "PMS_APPROVALCONSOLE" AS 

PROCEDURE SP_READ_DOCUMENTS(
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_APPROVAL_PENDING_LIST(
P_CORPRT_ID IN NUMBER,
P_ORG_ID IN NUMBER,
P_USER_ID IN NUMBER,
P_DOC_ID IN NUMBER,
P_STATUS IN NUMBER,
P_FROMDATE IN DATE,
P_TODATE IN DATE,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_REF IN VARCHAR2,
P_SEARCH_WRKFLW_NAME IN VARCHAR2,
P_SEARCH_DOC_NAME IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_USR_NAME IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_HIERCHY_BYID(
P_PRCHSORDRID IN NUMBER,
P_MODE IN NUMBER,
P_USRID IN NUMBER,
P_SEARCH_TERM IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_CONDITIONS(
P_WRKFLOWID IN NUMBER,
P_DSGNID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_CONDITION_CHECK(
P_PRCHSORDRID IN NUMBER,
P_USRID IN NUMBER,
P_CNDTNID IN NUMBER,
P_CNDTNTYPE IN NUMBER,
P_VALUES IN VARCHAR2,
P_MAXVAL IN NUMBER,
P_MINVAL IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_APPROVAL_CONSOLE(
P_CORPRT_ID IN NUMBER,
P_ORG_ID IN NUMBER,
P_NEXT_USER_ID IN NUMBER,
P_DOC_ID IN NUMBER,
P_PRCHSORDRID IN NUMBER,
P_APRVL_USR_ID IN NUMBER,
P_LEVEL IN NUMBER
);

PROCEDURE SP_APPROVE_OR_REJECT(
P_PRCHSORDRID IN NUMBER,
P_ARPRVREJCT_USRID IN NUMBER,
P_USERID IN NUMBER,
P_REJCT_REASON IN VARCHAR2,
P_MODE IN NUMBER
);

PROCEDURE SP_READ_STATUS_DTLS(
P_CORPRT_ID IN NUMBER,
P_PRCHSORDRID IN NUMBER,
P_DOC_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_COMMENTDTLS(
P_PRCHSORDRID IN NUMBER,
P_DOC_ID IN NUMBER,
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_COMMENTDTLS(
P_ID IN NUMBER,
P_APRVLCNSLCMNT_VISBLSTS IN NUMBER,
P_APRVLCNSLCMNT_COMMENT IN VARCHAR2,
P_USRID IN NUMBER
);

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_APRVLCNSLNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_ID OUT NUMBER
);

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_APRVLCNSLATCHNT_FILENM IN VARCHAR2,
P_APRVLCNSLATCHNT_FILEACTNM IN VARCHAR2,
P_APRVLCNSLATCHNT_TYPE IN NUMBER
);

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_APRVLCNSLNOTE_REPLY_MSG IN VARCHAR2
);

PROCEDURE SP_READ_ADDTNLDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_ADDTNL(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_APRVLCNSLADTNL_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_ID OUT NUMBER
);

PROCEDURE SP_INSERT_ADDTNL_ATTCH(
P_ADDTNLID IN NUMBER,
P_APRVLCNSLATCHADDTN_FILENM IN VARCHAR2,
P_APRVLCNSLATCHADDTN_FILEACTNM IN VARCHAR2,
P_APRVLCNSLATCHADDTN_REPLYSTS IN NUMBER
);

PROCEDURE SP_UPDATE_REPLYADDTNL(
P_ADDTNLID IN NUMBER,
P_APRVLCNSLADTNL_REPLY_MSG IN VARCHAR2
);

PROCEDURE SP_INSERT_CMNT_USER(
P_PRCHSORDRID IN NUMBER,
P_USRID IN NUMBER,
P_CNT IN NUMBER
);

END PMS_APPROVALCONSOLE;

/
--------------------------------------------------------
--  DDL for Package PMS_APPROVALSET
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE "PMS_APPROVALSET" AS 

PROCEDURE SP_LOAD_DOCUMENTS(
APPROVALSET_OUT OUT SYS_REFCURSOR
);
PROCEDURE SP_LOAD_CONDITIONS(
APPROVALSET_DOCID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_LOAD_CONDITIONSTYPE(
APPROVALSET_CNDTNID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
);

/* PROCEDURE SP_LOAD_CONDITIONVALUES(
APPROVALSET_TYPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
);*/

 PROCEDURE SP_LOAD_CORP_DEPTS(
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
);

 PROCEDURE SP_LOAD_SEARCH_CORP_DEPTS(
APPROVALSET_DEPTNAME IN VARCHAR2,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INS_APPROVALSET(
APPROVALSET_ID IN NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USRID NUMBER
);

PROCEDURE SP_INS_APPROVALSETDTL(
APPROVALSET_DTLID NUMBER,
APPROVALSET_ID NUMBER,
APPROVALSET_CNDTNID NUMBER,
APPROVALSET_TYPEID NUMBER

);

/*PROCEDURE SP_INS_APPROVALSETVALUE(
APPROVALSET_DTLID NUMBER,
APPROVALSET_MINVAL NUMBER,
APPROVALSET_MAXVAL NUMBER,
APPROVALSET_DEPTID VARCHAR2
);*/

PROCEDURE SP_UPDATE_APPROVALSET(
APPROVALSET_ID IN NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USRID NUMBER
);

PROCEDURE SP_UPDATE_APPROVALSETDTL(
APPROVALSET_DTLID NUMBER,
APPROVALSET_ID NUMBER,
APPROVALSET_CNDTNID NUMBER,
APPROVALSET_TYPEID NUMBER

);

PROCEDURE SP_UPDATE_APPROVALSETVALUE(
APPROVALSET_VALEID NUMBER,
APPROVALSET_DTLID NUMBER,
APPROVALSET_MAXVAL FLOAT,
APPROVALSET_MINVAL FLOAT,

APPROVALSET_DTLIST VARCHAR2,
CND_ID IN NUMBER
);

PROCEDURE SP_READ_APPROVALSETLIST(

APPROVALSET_DOCID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_STATUS NUMBER,
APPROVALSET_CNCLSTS NUMBER,
APPROVALSET_OUT  OUT SYS_REFCURSOR 
);

/*PROCEDURE SP_READ_APPROVALSETLISTBYID(
APPROVALSET_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT  OUT SYS_REFCURSOR 
);*/
PROCEDURE SP_CONFIRM_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
);
PROCEDURE SP_REOPEN_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
);
PROCEDURE SP_DELETE_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_CNCLRSN VARCHAR2,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
);


PROCEDURE SP_READ_APPR_CONDITION(
A_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_APPR_CONDITION_TYPE(
A_OUT OUT SYS_REFCURSOR);
PROCEDURE SP_DELETE_APPROVALSETDETAILS(
APPROVALSET_DET_ID NUMBER,
APPROVALSET_VALUE_ID NUMBER);

PROCEDURE SP_READ_PRODUCT_CATEGORY(
ORGID NUMBER,
CORPID NUMBER,
      A_OUT OUT SYS_REFCURSOR
      );
      PROCEDURE SP_READ_PRODUCT(
      ORGID NUMBER,
CORPID NUMBER,
      A_OUT OUT SYS_REFCURSOR
      );
      PROCEDURE SP_READ_CND(
ORGID NUMBER,
CORPID NUMBER,
A_OUT OUT SYS_REFCURSOR,
A_OUT1 OUT SYS_REFCURSOR,
D_DEPT OUT SYS_REFCURSOR,
D_DIV OUT SYS_REFCURSOR
      );

      PROCEDURE SP_INS_APPROVAL_SET(
AP_ID IN NUMBER,
AP_NAME IN VARCHAR2,
AP_DESC IN VARCHAR2,
DO_ID IN NUMBER,
AP_CON_STATUS IN NUMBER,
COR_ID IN NUMBER,
OR_ID IN NUMBER,
A_IN_USR_ID IN NUMBER,
A_INS_DATE IN DATE,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE,
A_CNFM_ID IN NUMBER,
A_CNFM_DATE IN DATE,
A_REOPEN_ID IN NUMBER,
A_REOPEN_DATE IN DATE,
A_CNCL_USR_ID IN NUMBER,
A_CNCL_DATE IN DATE,
A_CNCL_RSN IN VARCHAR2);


PROCEDURE SP_INS_APPROVAL_SET_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
CN_ID IN NUMBER,
CN_TY_ID IN NUMBER
);

PROCEDURE SP_INS_APPROVAL_SET_DTLSVALUE(
AP_DTLVAL_ID IN NUMBER,
AP_DTL_ID IN NUMBER,
AP_DTL_MAXVAL IN FLOAT,
AP_DTL_MINVAL IN FLOAT,
AP_DTL_VALUES IN VARCHAR2,
CND_ID IN NUMBER);
PROCEDURE SP_CHECK_DUP_APP(
A_CORPID IN NUMBER,
A_ORGID IN NUMBER,
APP_NAME IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR );

PROCEDURE SP_READ_APPSETSTS(
A_ST IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);

    PROCEDURE SP_CANCEL_APPROVALSET(
      APP_ID IN NUMBER,
      AT_CANCEL_USERID IN NUMBER,
      AT_CANCEL_DATE   IN DATE,
      AT_CANCEL_REASON IN VARCHAR2 );
      PROCEDURE SP_READ_APPROVAL
(
AP_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_APPROVALACTIVE(
ADOC_ID IN VARCHAR2,
A_STS IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_APPROVALLIST(
A_DESG IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);

     PROCEDURE SP_READ_APPROVALCNCL(
A_OUT OUT SYS_REFCURSOR
);
      PROCEDURE SP_READ_APPROVALCNFMSTS(
A_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
);
PROCEDURE SP_READ_APPROVLA_ASSIGNMENT(
AP_ID IN NUMBER,
A_OUT OUT SYS_REFCURSOR);
PROCEDURE SP_READ_APPROVALAll(
ADOC_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
);
END PMS_APPROVALSET;

/
--------------------------------------------------------
--  DDL for Package PMS_APPROVAL_ASSIGNMENT
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE "PMS_APPROVAL_ASSIGNMENT" AS 

 PROCEDURE SP_READ_DESIGNATION(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);
PROCEDURE SP_READ_WORKFLOW(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_WRKNAME IN VARCHAR2,
A_DESG IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);
PROCEDURE SP_READ_APPROVAL(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_NAME IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
);

  PROCEDURE SP_INS_APPROVAL_ASSGNMNT(
AP_ID IN NUMBER,
DSG_ID IN NUMBER,
COR_ID IN NUMBER,
OR_ID IN NUMBER,
A_IN_USR_ID IN NUMBER,
A_INS_DATE IN DATE,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE
);
PROCEDURE SP_INS_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
WRKFLW_ID IN NUMBER,
APPSET_ID IN NUMBER,
AP_START IN DATE,
AP_END IN DATE,
AP_CNCL_USR_ID IN NUMBER,
AP_CONSOLE IN NUMBER);


PROCEDURE SP_READ_APPROVALASS(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_APPROVALASSIGNMENT(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_ID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
);

  PROCEDURE SP_CNCL_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
AP_CNCL_USR_ID IN NUMBER
);


PROCEDURE SP_UPD_APPROVAL_ASSGNMNT(
AP_ID IN NUMBER,
DSG_ID IN NUMBER,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE
);
PROCEDURE SP_UPD_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
AWRKFLW_ID IN NUMBER,
APPSET_ID IN NUMBER,
AP_START IN DATE,
AP_END IN DATE,
AP_CNCL_USR_ID IN NUMBER,
AP_CONSOLE IN NUMBER
);

 PROCEDURE SP_DELETE_APPROVAL_ASS_DTLS(
APP_DTL_ID NUMBER);



END PMS_APPROVAL_ASSIGNMENT;

/
--------------------------------------------------------
--  DDL for Package PMS_PURCHASE_ORDER
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE "PMS_PURCHASE_ORDER" AS 

PROCEDURE SP_READ_MODE_OF_SUPPLY(
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_PROJECTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_DIVID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_WAREHOUSE(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VENDORS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VENDORCNTCTPRSN(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_VENDORID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_DOCUMNT_WRKFLOW(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_DIVISION(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_CUSTOMERS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_DIVSNID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_POCONTACTPRSNS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CUSTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_PRODUCTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_VEHICLES(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_EMPLOYEEDTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_EMPID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE READ_PRODUCT_TAX_DTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PRDCTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USRID IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_REF IN VARCHAR2,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
);

PROCEDURE SP_INSERT_PRODUCT_DTLS(
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
);

PROCEDURE SP_READ_PURCHASE_ORDER_LIST(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SUPLIR_ID IN NUMBER,
P_STRTDATE IN DATE,
P_ENDDATE IN DATE,
P_WRKFLW_ID IN NUMBER,
P_STATUS IN NUMBER,
P_CNCLSTS IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_PRCHSORDR_REFNO IN VARCHAR2,
P_SEARCH_PRCHSORDR_POTYPE IN VARCHAR2,
P_SEARCH_PRCHSORDR_VENDOR IN VARCHAR2,
P_SEARCH_PRCHSORDR_DOCMNT IN VARCHAR2,
P_SEARCH_PRCHSORDR_DLVRYDT IN VARCHAR2,
P_SEARCH_PRCHSORDR_AMNT IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_CANCEL_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CNCLREASON IN VARCHAR2,
P_USRID IN NUMBER
);

PROCEDURE SP_READ_PURCHS_ORDER_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_PURCHS_ORDER_DTLS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_UPDATE_PURCHASE_ORDER(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
);

PROCEDURE SP_UPDATE_PRODUCT_DTLS(
P_DTLID IN NUMBER,
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
);

PROCEDURE SP_CANCEL_PRODUCT_DTLS_ORATTCH(
P_DTLID IN NUMBER,
P_USRID IN NUMBER,
P_MODE IN NUMBER
);

PROCEDURE SP_CONFIRM_REOPEN_PRCHS_ORDER(
P_ID IN NUMBER,
P_STATUS IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER
);

PROCEDURE SP_READ_CHARGEHEADS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CHRGHDID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_INSERT_CHARGE_HEADS(
P_ID IN NUMBER,
P_CHRGHD_ID IN NUMBER,
P_PRCHSORDR_CHRGAMNT IN DECIMAL
);

PROCEDURE SP_INSERT_ATTCHMNTS(
P_ID IN NUMBER,
P_PRCHSORDRATCH_FILE_NAME IN VARCHAR2,
P_PRCHSORDRATCH_FILE_ACTNM IN VARCHAR2,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
);

PROCEDURE SP_DELETE_CHRGHEAD(
P_ID IN NUMBER,
P_MODE IN NUMBER
);

PROCEDURE SP_READ_ATTACHMENTS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR);

PROCEDURE SP_READ_CHARGEHEADS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_UPDATE_ATTCHMNTS(
P_DTLID IN NUMBER,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
);

PROCEDURE SP_INSERT_COMMENTDTLS(
P_ID IN NUMBER,
P_PRCHSORDRCMNT_VISBLSTS IN NUMBER,
P_PRCHSORDRCMNT_COMMENT IN VARCHAR2,
P_USRID IN NUMBER
);

PROCEDURE SP_READ_COMMENTDTLS(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_PRCHSORDRNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_NOTEID OUT NUMBER
);

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_PRCHSORDRATCHNT_FILENM IN VARCHAR2,
P_PRCHSORDRATCHNT_FILEACTNM IN VARCHAR2,
P_PRCHSORDRATCHNT_TYPE IN NUMBER
);

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_PRCHSORDRNOTE_REPLY_MSG IN VARCHAR2
);

PROCEDURE SP_INSERT_SUPPLIER_CONTACT(
L_SUPLIER_ID IN NUMBER,
L_CONTACTNAME IN VARCHAR2,
L_CONTACTADDRESS IN VARCHAR2,
L_CONTACTMOBILE IN VARCHAR2,
L_CONTACTPHONE IN VARCHAR2,
L_CONTACTWEBSITE IN VARCHAR2,
L_CONTACTEMAIL IN VARCHAR2,
L_ID IN NUMBER
);

PROCEDURE SP_DELETE_SUPPLIER_CONTACT(
L_ID IN NUMBER
);

PROCEDURE SP_READ_CONTACTDTLS_BYID(
P_MODE IN NUMBER,
P_CONTACT_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
);

END PMS_PURCHASE_ORDER;

/
--------------------------------------------------------
--  DDL for Package Body PMS_APPROVALCONSOLE
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PMS_APPROVALCONSOLE" AS

PROCEDURE SP_READ_DOCUMENTS(
P_OUT OUT SYS_REFCURSOR) AS
BEGIN
OPEN P_OUT FOR
SELECT * FROM PMS_APPROVAL_DOCUMENTS;
END SP_READ_DOCUMENTS;

PROCEDURE SP_READ_APPROVAL_PENDING_LIST(
P_CORPRT_ID IN NUMBER,
P_ORG_ID IN NUMBER,
P_USER_ID IN NUMBER,
P_DOC_ID IN NUMBER,
P_STATUS IN NUMBER,
P_FROMDATE IN DATE,
P_TODATE IN DATE,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_REF IN VARCHAR2,
P_SEARCH_WRKFLW_NAME IN VARCHAR2,
P_SEARCH_DOC_NAME IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_USR_NAME IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_OUT OUT SYS_REFCURSOR)AS
T_QUERY VARCHAR2(32767);
T_GETDATA VARCHAR2(32767);
BEGIN

T_GETDATA:='';

T_GETDATA:=T_GETDATA||'
SELECT PMS_APPROVAL_CONSOLE.PRCHSORDR_ID,PMS_APPROVAL_CONSOLE.APRVLCNSL_ID,

TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') PRCHSORDR_DATE,PRCHSORDR_REF,
DECODE(PRCHSORDR_PRIORTY,0,''NORMAL'',1,''URGENT'')"PRCHSORDR_IMPORTNC",PRCHSORDR_CONFRM_USR_ID,

WRKFLW_NAME,DOC_NAME,TO_CHAR(APRVLCNSL_INS_DATE,''DD-MM-YYYY'') APRVLCNSL_INS_DATE,
GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME",
GN_USERS.USR_CODE||''-''||GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME_CODE",
APRVLCNSL_APRVLSTS,DECODE(PMS_DOCUMNT_WRKFLW.WRKFLW_PRIORTY,0,''MEDIUM'',1,''HIGH'')"PRCHSORDR_PRIORTY",
WRKFLWFLT_APRVL_MNDTRY_STS,WRKFLWFLT_SUBSTUTE_STS,WRKFLWFLT_THRSHOLD_PRD_STS,WRKFLWFLT_THRSHOLD_PERIOD,
WRKFLWFLT_APRVL_PEN_MSG_STS,WRKFLWFLT_SMS_MSG_STS,WRKFLWFLT_DASHBRD_MSG_STS,WRKFLWFLT_TTC_EXCD_MSG_STS,
PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID,APRVLCNSL_LEVEL,
APRVLCNSL_HOLD_USR_ID,WRKFLW_APRVR_MODFY,
to_users.USR_NAME||'' ''||to_users.EMPERDTL_MNAME||'' ''||to_users.EMPERDTL_LNAME "NOTE_TO_USRNAME",

(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID='||P_USER_ID||' AND APRVLCNSLNOTE_REPLYSTS=0) 
"USR_NOTECNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLNOTE_REPLYSTS=0 AND APRVLCNSLNOTE_ID = (SELECT MAX(APRVLCNSLNOTE_ID) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"NOTECNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLNOTE_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLNOTE_REPLYSTS=1
AND APRVLCNSLNOTE_ID = (SELECT MAX(APRVLCNSLNOTE_ID) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"USR_REPLYCNT",

((SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_VISBLSTS=0)+
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLCMNT_VISBLSTS=1))-
NVL((SELECT NVL(APRVLCNSLCMNTUSR_VIEW_CNT,0) FROM PMS_APPROVAL_CONSOLE_COMMNTUSR WHERE 
PMS_APPROVAL_CONSOLE_COMMNTUSR.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_COMMNTUSR.USR_ID='||P_USER_ID||'),0)
"COMMNTCNT",

(
SELECT apprvl_cnsl.USR_ID FROM PMS_APPROVAL_CONSOLE apprvl_cnsl
WHERE apprvl_cnsl.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID AND
APRVLCNSL_APRVL_DATE=
(select max(apprvl_cnsl2.APRVLCNSL_APRVL_DATE)
FROM PMS_APPROVAL_CONSOLE apprvl_cnsl2
where apprvl_cnsl2.APRVLCNSL_APRVL_DATE is not null
and apprvl_cnsl2.PRCHSORDR_ID=apprvl_cnsl.PRCHSORDR_ID)
) "NOTE_TO_USRID_HIERCHY",
(
SELECT USR_NAME FROM PMS_APPROVAL_CONSOLE apprvl_cnsl
INNER JOIN GN_USERS ON GN_USERS.USR_ID=apprvl_cnsl.USR_ID
WHERE apprvl_cnsl.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID AND
APRVLCNSL_APRVL_DATE=
(select max(apprvl_cnsl2.APRVLCNSL_APRVL_DATE)
FROM PMS_APPROVAL_CONSOLE apprvl_cnsl2
where apprvl_cnsl2.APRVLCNSL_APRVL_DATE is not null
and apprvl_cnsl2.PRCHSORDR_ID=apprvl_cnsl.PRCHSORDR_ID)
) "NOTE_TO_USRNAME_HIERCHY",

0 "TYPE_STATUS",

(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID='||P_USER_ID||' AND APRVLCNSLADTNL_REPLYSTS=0) 
"USR_ADDTNL_CNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLADTNL_REPLYSTS=0 AND APRVLCNSLADTNL_ID = (SELECT MAX(APRVLCNSLADTNL_ID) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"ADDTNL_CNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLADTNL_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLADTNL_REPLYSTS=1
AND APRVLCNSLADTNL_ID = (SELECT MAX(APRVLCNSLADTNL_ID) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"USR_REPLY_ADDTNLCNT"

FROM PMS_APPROVAL_CONSOLE
INNER JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_APPROVAL_CONSOLE.DOC_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_APPROVAL_CONSOLE.APRVLCNSL_INS_USR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW_FLOATING ON PMS_DOCUMNT_WRKFLW_FLOATING.USR_ID='||P_USER_ID||' 
LEFT JOIN GN_USERS to_users ON to_users.USR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_CONFRM_USR_ID --NOTE_TO_USER--
WHERE PMS_APPROVAL_CONSOLE.USR_ID='||P_USER_ID||' 
AND PMS_APPROVAL_CONSOLE.CORPRT_ID='||P_CORPRT_ID||' AND PMS_APPROVAL_CONSOLE.ORG_ID='||P_ORG_ID||'
AND PMS_DOCUMNT_WRKFLW_FLOATING.WRKFLW_ID=PMS_DOCUMNT_WRKFLW.WRKFLW_ID';

IF(P_DOC_ID!=0) THEN
T_GETDATA:=T_GETDATA||' AND PMS_APPROVAL_CONSOLE.DOC_ID='||P_DOC_ID||'';
END IF;
IF(P_STATUS!=3) THEN
T_GETDATA:=T_GETDATA||' AND APRVLCNSL_APRVLSTS='||P_STATUS||'';
END IF;
IF(P_FROMDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_TODATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
END IF;

------------------------------FOR SEARCH----------------------------
IF(P_COMMON_SEARCH_TERM IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' 
AND
(
UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(DOC_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR APRVLCNSL_INS_DATE LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%''
--OR PRCHSORDR_DATE LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%''
OR GN_USERS.USR_CODE||''-''||GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%'' = ''''
)';
END IF;

IF(P_SEARCH_PRCHSORDR_REF IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_REF||''')||''%''';
END IF;
IF(P_SEARCH_WRKFLW_NAME IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_SEARCH_WRKFLW_NAME||''')||''%''';
END IF;
IF(P_SEARCH_DOC_NAME IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(DOC_NAME) LIKE ''%''||UPPER('''||P_SEARCH_DOC_NAME||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_DATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND APRVLCNSL_INS_DATE LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DATE||'''||''%''';
END IF;
--IF(P_SEARCH_PRCHSORDR_DATE IS NOT NULL AND P_SEARCH_PRCHSORDR_DATE!='')THEN
--T_GETDATA:=T_GETDATA||' (PRCHSORDR_DATE LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DATE||'''||''%'' OR TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') LIKE ''%''||TO_CHAR('''||P_SEARCH_PRCHSORDR_DATE||''',''DD-MM-YYYY'')||''%'')';
--END IF;
IF(P_SEARCH_USR_NAME IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND GN_USERS.USR_CODE||''-''||GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME LIKE ''%''||UPPER('''||P_SEARCH_USR_NAME||''')||''%''';
END IF;
------------------------------FOR SEARCH----------------------------

T_GETDATA:=T_GETDATA||'
UNION

SELECT PMS_APPROVAL_CONSOLE.PRCHSORDR_ID,PMS_APPROVAL_CONSOLE.APRVLCNSL_ID,

TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') PRCHSORDR_DATE,PRCHSORDR_REF,
NULL "PRCHSORDR_IMPORTNC",PRCHSORDR_CONFRM_USR_ID,

WRKFLW_NAME,DOC_NAME,TO_CHAR(APRVLCNSL_INS_DATE,''DD-MM-YYYY'') APRVLCNSL_INS_DATE,
GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME",
GN_USERS.USR_CODE||''-''||GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME_CODE",
APRVLCNSL_APRVLSTS,NULL "PRCHSORDR_PRIORTY",

0 "WRKFLWFLT_APRVL_MNDTRY_STS",0 "WRKFLWFLT_SUBSTUTE_STS",0 "WRKFLWFLT_THRSHOLD_PRD_STS",0 "WRKFLWFLT_THRSHOLD_PERIOD",
0 "WRKFLWFLT_APRVL_PEN_MSG_STS",0 "WRKFLWFLT_SMS_MSG_STS",0 "WRKFLWFLT_DASHBRD_MSG_STS",0 "WRKFLWFLT_TTC_EXCD_MSG_STS",
NULL "WRKFLW_ID",APRVLCNSL_LEVEL,
APRVLCNSL_HOLD_USR_ID,0 "WRKFLW_APRVR_MODFY",
NULL "NOTE_TO_USRNAME",

(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID='||P_USER_ID||' AND APRVLCNSLNOTE_REPLYSTS=0) 
"USR_NOTECNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLNOTE_REPLYSTS=0 AND APRVLCNSLNOTE_ID = (SELECT MAX(APRVLCNSLNOTE_ID) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"NOTECNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLNOTE_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLNOTE_REPLYSTS=1
AND APRVLCNSLNOTE_ID = (SELECT MAX(APRVLCNSLNOTE_ID) FROM PMS_APPROVAL_CONSOLE_NOTEDTLS
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"USR_REPLYCNT",

((SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_VISBLSTS=0)+
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLCMNT_VISBLSTS=1))-
NVL((SELECT NVL(APRVLCNSLCMNTUSR_VIEW_CNT,0) FROM PMS_APPROVAL_CONSOLE_COMMNTUSR WHERE 
PMS_APPROVAL_CONSOLE_COMMNTUSR.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_COMMNTUSR.USR_ID='||P_USER_ID||'),0)
"COMMNTCNT",

(
SELECT apprvl_cnsl.USR_ID FROM PMS_APPROVAL_CONSOLE apprvl_cnsl
WHERE apprvl_cnsl.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE.APRVLCNSL_ID AND
APRVLCNSL_APRVL_DATE=
(select max(apprvl_cnsl2.APRVLCNSL_APRVL_DATE)
FROM PMS_APPROVAL_CONSOLE apprvl_cnsl2
where apprvl_cnsl2.APRVLCNSL_APRVL_DATE is not null
and apprvl_cnsl2.PRCHSORDR_ID=apprvl_cnsl.PRCHSORDR_ID)
) "NOTE_TO_USRID_HIERCHY",
(
SELECT USR_NAME FROM PMS_APPROVAL_CONSOLE apprvl_cnsl
INNER JOIN GN_USERS ON GN_USERS.USR_ID=apprvl_cnsl.USR_ID
WHERE apprvl_cnsl.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE.APRVLCNSL_ID AND
APRVLCNSL_APRVL_DATE=
(select max(apprvl_cnsl2.APRVLCNSL_APRVL_DATE)
FROM PMS_APPROVAL_CONSOLE apprvl_cnsl2
where apprvl_cnsl2.APRVLCNSL_APRVL_DATE is not null
and apprvl_cnsl2.PRCHSORDR_ID=apprvl_cnsl.PRCHSORDR_ID)
) "NOTE_TO_USRNAME_HIERCHY",

1 "TYPE_STATUS",

0 "USR_ADDTNL_CNT",
0 "ADDTNL_CNT",
0 "USR_REPLY_ADDTNLCNT"

FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_APPROVAL_CONSOLE.DOC_ID
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_APPROVAL_CONSOLE.APRVLCNSL_INS_USR_ID
WHERE PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID='||P_USER_ID||' AND APRVLCNSLNOTE_REPLYSTS=0
AND PMS_APPROVAL_CONSOLE.CORPRT_ID='||P_CORPRT_ID||' AND PMS_APPROVAL_CONSOLE.ORG_ID='||P_ORG_ID||'
';

IF(P_DOC_ID!=0) THEN
T_GETDATA:=T_GETDATA||' AND PMS_APPROVAL_CONSOLE.DOC_ID='||P_DOC_ID||'';
END IF;
IF(P_STATUS!=3) THEN
T_GETDATA:=T_GETDATA||' AND APRVLCNSL_APRVLSTS='||P_STATUS||'';
END IF;
IF(P_FROMDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_TODATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
END IF;

T_GETDATA:=T_GETDATA||'
UNION

SELECT PMS_APPROVAL_CONSOLE.PRCHSORDR_ID,PMS_APPROVAL_CONSOLE.APRVLCNSL_ID,

TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') PRCHSORDR_DATE,PRCHSORDR_REF,
NULL "PRCHSORDR_IMPORTNC",PRCHSORDR_CONFRM_USR_ID,

WRKFLW_NAME,DOC_NAME,TO_CHAR(APRVLCNSL_INS_DATE,''DD-MM-YYYY'') APRVLCNSL_INS_DATE,
GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME",
GN_USERS.USR_CODE||''-''||GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "USR_NAME_CODE",
APRVLCNSL_APRVLSTS,NULL "PRCHSORDR_PRIORTY",

0 "WRKFLWFLT_APRVL_MNDTRY_STS",0 "WRKFLWFLT_SUBSTUTE_STS",0 "WRKFLWFLT_THRSHOLD_PRD_STS",0 "WRKFLWFLT_THRSHOLD_PERIOD",
0 "WRKFLWFLT_APRVL_PEN_MSG_STS",0 "WRKFLWFLT_SMS_MSG_STS",0 "WRKFLWFLT_DASHBRD_MSG_STS",0 "WRKFLWFLT_TTC_EXCD_MSG_STS",
NULL "WRKFLW_ID",APRVLCNSL_LEVEL,
APRVLCNSL_HOLD_USR_ID,0 "WRKFLW_APRVR_MODFY",
NULL "NOTE_TO_USRNAME",

0 "USR_NOTECNT",
0 "NOTECNT",
0 "USR_REPLYCNT",

((SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_VISBLSTS=0)+
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_COMMNTDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLCMNT_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLCMNT_VISBLSTS=1))-
NVL((SELECT NVL(APRVLCNSLCMNTUSR_VIEW_CNT,0) FROM PMS_APPROVAL_CONSOLE_COMMNTUSR WHERE 
PMS_APPROVAL_CONSOLE_COMMNTUSR.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_COMMNTUSR.USR_ID='||P_USER_ID||'),0)
"COMMNTCNT",

NULL "NOTE_TO_USRID_HIERCHY",
NULL "NOTE_TO_USRNAME_HIERCHY",

2 "TYPE_STATUS",

(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID='||P_USER_ID||' AND APRVLCNSLADTNL_REPLYSTS=0) 
"USR_ADDTNL_CNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLADTNL_REPLYSTS=0 AND APRVLCNSLADTNL_ID = (SELECT MAX(APRVLCNSLADTNL_ID) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"ADDTNL_CNT",
(SELECT COUNT(*) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND APRVLCNSLADTNL_INS_USR_ID='||P_USER_ID||' AND APRVLCNSLADTNL_REPLYSTS=1
AND APRVLCNSLADTNL_ID = (SELECT MAX(APRVLCNSLADTNL_ID) FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) ) 
"USR_REPLY_ADDTNLCNT"

FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_APPROVAL_CONSOLE.DOC_ID
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_APPROVAL_CONSOLE.APRVLCNSL_INS_USR_ID
WHERE PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID='||P_USER_ID||' AND APRVLCNSLADTNL_REPLYSTS=0
AND PMS_APPROVAL_CONSOLE.CORPRT_ID='||P_CORPRT_ID||' AND PMS_APPROVAL_CONSOLE.ORG_ID='||P_ORG_ID||'
';

IF(P_DOC_ID!=0) THEN
T_GETDATA:=T_GETDATA||' AND PMS_APPROVAL_CONSOLE.DOC_ID='||P_DOC_ID||'';
END IF;
IF(P_STATUS!=3) THEN
T_GETDATA:=T_GETDATA||' AND APRVLCNSL_APRVLSTS='||P_STATUS||'';
END IF;
IF(P_FROMDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')>=TO_DATE('''||P_FROMDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_TODATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(CAST(APRVLCNSL_INS_DATE AS DATE),''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
--T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')<=TO_DATE('''||P_TODATE||''',''DD-MM-YYYY'')';
END IF;

IF(P_ORDER_COLUMN=0)THEN--1st load
T_GETDATA:=T_GETDATA||' ORDER BY PRCHSORDR_PRIORTY DESC,PRCHSORDR_PRIORTY DESC,APRVLCNSL_ID ASC';

ELSE
IF(P_ORDER_METHOD=0)THEN
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' ASC';
ELSE
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' DESC';
END IF;

END IF;

------------------------------FOR PAGEINATION-----------------------
T_QUERY:=
'SELECT * FROM 
(
select val.*, ROWNUM rnum,
(SELECT COUNT(*) FROM (
'||T_GETDATA||'
)) CNT
from
(
'||T_GETDATA||'
) val
where ROWNUM <= ('||P_PAGE_NUMBER||'*'||P_PAGE_MAXSIZE||')
)
where rnum  >= ((('||P_PAGE_NUMBER||' - 1) * '||P_PAGE_MAXSIZE||') + 1)
';

------------------------------FOR PAGEINATION-----------------------

OPEN P_OUT FOR T_QUERY;
--createfile(T_QUERY,'APRVLCNSL');

END SP_READ_APPROVAL_PENDING_LIST;

PROCEDURE SP_READ_HIERCHY_BYID(
P_PRCHSORDRID IN NUMBER,
P_MODE IN NUMBER,
P_USRID IN NUMBER,
P_SEARCH_TERM IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_MODE=0)THEN
OPEN P_OUT FOR
SELECT * FROM PMS_DOCUMNT_WRKFLW_FLOATING WHERE WRKFLW_ID=(SELECT WRKFLW_ID FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID)
AND USR_ID NOT IN (SELECT USR_ID FROM PMS_APPROVAL_CONSOLE WHERE PRCHSORDR_ID=P_PRCHSORDRID) AND WRKFLWFLT_CNCL_USR_ID IS NULL
AND WRKFLWFLT_LEVEL NOT IN(SELECT APRVLCNSL_LEVEL FROM PMS_APPROVAL_CONSOLE WHERE PRCHSORDR_ID=P_PRCHSORDRID)
ORDER BY WRKFLWFLT_LEVEL DESC;

ELSIF(P_MODE=1)THEN
OPEN P_OUT FOR
SELECT * FROM PMS_DOCUMNT_WRKFLW_FLOATING WHERE WRKFLW_ID=(SELECT WRKFLW_ID FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID)
AND USR_ID IN (SELECT USR_ID FROM PMS_APPROVAL_CONSOLE WHERE PRCHSORDR_ID=P_PRCHSORDRID AND APRVLCNSL_APRVLSTS=0) AND WRKFLWFLT_CNCL_USR_ID IS NULL
AND WRKFLWFLT_LEVEL=(SELECT APRVLCNSL_LEVEL FROM PMS_APPROVAL_CONSOLE WHERE PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USRID AND APRVLCNSL_APRVLSTS=0)
ORDER BY WRKFLWFLT_LEVEL DESC;

ELSIF(P_MODE=2)THEN
OPEN P_OUT FOR
SELECT PMS_DOCUMNT_WRKFLW_FLOATING.USR_ID,
USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME",USR_CODE,
USR_CODE||'-'||USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME_CODE",
PMS_DOCUMNT_WRKFLW_FLOATING.DSGN_ID,
WRKFLWFLT_PARENT_DTL_ID,WRKFLWFLT_APRVL_MNDTRY_STS,WRKFLWFLT_SUBSTUTE_STS,WRKFLWFLT_THRSHOLD_PRD_STS,WRKFLWFLT_THRSHOLD_PERIOD,
WRKFLWFLT_APRVL_PEN_MSG_STS,WRKFLWFLT_SMS_MSG_STS,WRKFLWFLT_DASHBRD_MSG_STS,WRKFLWFLT_TTC_EXCD_MSG_STS
FROM PMS_DOCUMNT_WRKFLW_FLOATING
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_DOCUMNT_WRKFLW_FLOATING.USR_ID
WHERE WRKFLW_ID=(SELECT WRKFLW_ID FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID)
AND PMS_DOCUMNT_WRKFLW_FLOATING.USR_ID IN (SELECT PMS_APPROVAL_CONSOLE.USR_ID FROM PMS_APPROVAL_CONSOLE 
WHERE PRCHSORDR_ID=P_PRCHSORDRID AND APRVLCNSL_APRVLSTS=0) AND WRKFLWFLT_CNCL_USR_ID IS NULL
AND (UPPER(USR_CODE) LIKE UPPER('%'||P_SEARCH_TERM||'%') OR UPPER(USR_NAME) LIKE UPPER('%'||P_SEARCH_TERM||'%'))
ORDER BY WRKFLWFLT_LEVEL DESC;

END IF;
END SP_READ_HIERCHY_BYID;

PROCEDURE SP_READ_CONDITIONS(
P_WRKFLOWID IN NUMBER,
P_DSGNID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT CNDTN_ID,CNDTN_TYPE_ID,APRVLSET_DTL_MAXVAL,APRVLSET_DTL_MINVAL,APRVLSET_DTL_VALUES
FROM PMS_APPROVAL_ASSGNMNT 
INNER JOIN PMS_APPROVAL_ASSGNMNT_DTLS ON PMS_APPROVAL_ASSGNMNT_DTLS.APRVLASGN_ID=PMS_APPROVAL_ASSGNMNT.APRVLASGN_ID
INNER JOIN PMS_APPROVAL_SET_DTLS ON PMS_APPROVAL_SET_DTLS.APRVLSET_ID=PMS_APPROVAL_ASSGNMNT_DTLS.APRVLSET_ID
INNER JOIN PMS_APPROVAL_SET_DTLSVALUE ON PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_ID=PMS_APPROVAL_SET_DTLS.APRVLSET_DTL_ID
WHERE DSGN_ID=P_DSGNID AND WRKFLW_ID=P_WRKFLOWID AND APRVLASGN_CNCL_USR_ID IS NULL 
AND TO_DATE(APRVLASGN_STRTDATE,'DD-MM-YYYY')<=TO_DATE(SYSDATE,'DD-MM-YYYY')
AND TO_DATE(APRVLASGN_ENDDATE,'DD-MM-YYYY')>=TO_DATE(SYSDATE,'DD-MM-YYYY')
;
END SP_READ_CONDITIONS;

PROCEDURE SP_CONDITION_CHECK(
P_PRCHSORDRID IN NUMBER,
P_USRID IN NUMBER,
P_CNDTNID IN NUMBER,
P_CNDTNTYPE IN NUMBER,
P_VALUES IN VARCHAR2,
P_MAXVAL IN NUMBER,
P_MINVAL IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_CNDTNTYPE!=4)THEN

IF(P_CNDTNID=1)THEN--TOTAL AMNT
IF(P_CNDTNTYPE=1)THEN
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM PMS_PURCHASE_ORDER_MASTER WHERE PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID 
AND NVL(PRCHSORDR_NET_TOTAL,0)<=NVL(P_MAXVAL,0) AND NVL(PRCHSORDR_NET_TOTAL,0)>=NVL(P_MINVAL,0);
ELSIF(P_CNDTNTYPE=2)THEN
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM PMS_PURCHASE_ORDER_MASTER WHERE PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID 
AND NVL(PRCHSORDR_NET_TOTAL,0)<=NVL(P_MINVAL,0);
ELSIF(P_CNDTNTYPE=3)THEN
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM PMS_PURCHASE_ORDER_MASTER WHERE PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID 
AND NVL(PRCHSORDR_NET_TOTAL,0)>=NVL(P_MINVAL,0);
END IF;
END IF;

ELSE
IF(P_CNDTNID=2)THEN--PRDCT CATGRY
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM PMS_PURCHASE_ORDER_MASTER
INNER JOIN PMS_PURCHASE_ORDER_DTLS ON PMS_PURCHASE_ORDER_DTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID
INNER JOIN GN_PRODUCT_MASTER ON GN_PRODUCT_MASTER.PRDT_ID=PMS_PURCHASE_ORDER_DTLS.PRDT_ID
WHERE PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID AND GN_PRODUCT_MASTER.PRDT_MN_CTGRY_ID IN(
(select regexp_substr(P_VALUES,'[^,]+', 1, level) from dual
connect by regexp_substr(P_VALUES, '[^,]+', 1, level) is not null)
) AND PRCHSORDR_DTL_CNCL_USRID IS NULL;
ELSIF(P_CNDTNID=3)THEN--PRDCT
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM PMS_PURCHASE_ORDER_MASTER
INNER JOIN PMS_PURCHASE_ORDER_DTLS ON PMS_PURCHASE_ORDER_DTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID
WHERE PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID AND PRDT_ID IN(
(select regexp_substr(P_VALUES,'[^,]+', 1, level) from dual
connect by regexp_substr(P_VALUES, '[^,]+', 1, level) is not null)
) AND PRCHSORDR_DTL_CNCL_USRID IS NULL;
ELSIF(P_CNDTNID=4)THEN--DEPARTMNT
OPEN P_OUT FOR
SELECT COUNT(*) "CNT" FROM GN_USERS WHERE USR_ID=P_USRID AND CPRDEPT_ID IN(
(select regexp_substr(P_VALUES,'[^,]+', 1, level) from dual
connect by regexp_substr(P_VALUES, '[^,]+', 1, level) is not null)
);
END IF;

END IF;
END SP_CONDITION_CHECK;

PROCEDURE SP_INSERT_APPROVAL_CONSOLE(
P_CORPRT_ID IN NUMBER,
P_ORG_ID IN NUMBER,
P_NEXT_USER_ID IN NUMBER,
P_DOC_ID IN NUMBER,
P_PRCHSORDRID IN NUMBER,
P_APRVL_USR_ID IN NUMBER,
P_LEVEL IN NUMBER
)AS BEGIN

INSERT INTO PMS_APPROVAL_CONSOLE
(
APRVLCNSL_ID,
DOC_ID,
PRCHSORDR_ID,
USR_ID,
CORPRT_ID,
ORG_ID,
APRVLCNSL_INS_USR_ID,
APRVLCNSL_INS_DATE,
APRVLCNSL_LEVEL,
WRKFLW_ID
)
VALUES(
SEQ_PMS_APRVLCNSL_ID.NEXTVAL,
P_DOC_ID,
P_PRCHSORDRID,
P_NEXT_USER_ID,
P_CORPRT_ID,
P_ORG_ID,
P_APRVL_USR_ID,
SYSDATE,
P_LEVEL,
(SELECT WRKFLW_ID FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID)
);

INSERT INTO PMS_APPROVAL_CONSOLE_FLOATING
(
APRVLCNSLFLT_ID,
DOC_ID,
APRVLCNSLFLT_TRANSACTN_ID,
WRKFLW_ID,
USR_ID,
CORPRT_ID,
ORG_ID,
APRVLCNSLFLT_INS_USR_ID,
APRVLCNSLFLT_INS_DATE,
APRVLCNSLFLT_REF,
APRVLCNSLFLT_DATE,
APRVLCNSLFLT_LEVEL
)
VALUES
(
SEQ_PMS_APRVLCNSLFLT_ID.NEXTVAL,
1,
P_PRCHSORDRID,
(SELECT WRKFLW_ID FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID),
P_NEXT_USER_ID,
P_CORPRT_ID,
P_ORG_ID,
P_APRVL_USR_ID,
SYSDATE,
(SELECT PRCHSORDR_REF FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID),
(SELECT PRCHSORDR_DATE FROM PMS_PURCHASE_ORDER_MASTER WHERE PRCHSORDR_ID=P_PRCHSORDRID),
P_LEVEL
);

END SP_INSERT_APPROVAL_CONSOLE;

PROCEDURE SP_APPROVE_OR_REJECT(
P_PRCHSORDRID IN NUMBER,
P_ARPRVREJCT_USRID IN NUMBER,--APPROVING USERID
P_USERID IN NUMBER,--WHICH ALL USERIDS BEING APPROVED - IF ALL SAME DESIGNATION IN A LEVEL,ALL USERS IN THAT LEVEL
P_REJCT_REASON IN VARCHAR2,
P_MODE IN NUMBER
)AS 
P_LEVEL NUMBER(5);
BEGIN

SELECT APRVLCNSL_LEVEL INTO P_LEVEL FROM PMS_APPROVAL_CONSOLE WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

IF(P_MODE=1)THEN--CONFIRM
UPDATE PMS_APPROVAL_CONSOLE SET
APRVLCNSL_APRVLSTS=P_MODE,
APRVLCNSL_APRVL_USR_ID=P_ARPRVREJCT_USRID,
APRVLCNSL_APRVL_DATE=SYSDATE
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

UPDATE PMS_APPROVAL_CONSOLE SET
APRVLCNSL_HOLD_DATE=NULL,
APRVLCNSL_HOLD_USR_ID=NULL
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID!=P_ARPRVREJCT_USRID AND APRVLCNSL_LEVEL=P_LEVEL;

UPDATE PMS_APPROVAL_CONSOLE_FLOATING SET
APRVLCNSLFLT_APRVLSTS=P_MODE,
APRVLCNSLFLT_APRVL_USR_ID=P_ARPRVREJCT_USRID,
APRVLCNSLFLT_APRVL_DATE=SYSDATE
WHERE DOC_ID=1 AND APRVLCNSLFLT_TRANSACTN_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

ELSIF(P_MODE=2)THEN--REJECT
UPDATE PMS_APPROVAL_CONSOLE SET
APRVLCNSL_APRVLSTS=P_MODE,
APRVLCNSL_REJCT_USR_ID=P_ARPRVREJCT_USRID,
APRVLCNSL_REJCT_DATE=SYSDATE,
APRVLCNSL_REJCT_REASON=P_REJCT_REASON
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

UPDATE PMS_APPROVAL_CONSOLE SET
APRVLCNSL_HOLD_DATE=NULL,
APRVLCNSL_HOLD_USR_ID=NULL
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID!=P_ARPRVREJCT_USRID AND APRVLCNSL_LEVEL=P_LEVEL;

UPDATE PMS_APPROVAL_CONSOLE_FLOATING SET
APRVLCNSLFLT_APRVLSTS=P_MODE,
APRVLCNSLFLT_REJCT_DATE=SYSDATE,
APRVLCNSLFLT_REJCT_REASON=P_REJCT_REASON,
APRVLCNSLFLT_REJCT_USR_ID=P_ARPRVREJCT_USRID
WHERE DOC_ID=1 AND APRVLCNSLFLT_TRANSACTN_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

DELETE FROM PMS_APPROVAL_CONSOLE
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID!=P_ARPRVREJCT_USRID AND APRVLCNSL_LEVEL=P_LEVEL;

DELETE FROM PMS_APPROVAL_CONSOLE_FLOATING
WHERE DOC_ID=1 AND APRVLCNSLFLT_TRANSACTN_ID=P_PRCHSORDRID AND USR_ID!=P_ARPRVREJCT_USRID AND APRVLCNSLFLT_LEVEL=P_LEVEL;

ELSIF(P_MODE=3)THEN--HOLD
UPDATE PMS_APPROVAL_CONSOLE SET
APRVLCNSL_APRVLSTS=0,
APRVLCNSL_HOLD_USR_ID=P_ARPRVREJCT_USRID,
APRVLCNSL_HOLD_DATE=SYSDATE
WHERE DOC_ID=1 AND PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USERID;

END IF;

END SP_APPROVE_OR_REJECT;

PROCEDURE SP_READ_STATUS_DTLS(
P_CORPRT_ID IN NUMBER,
P_PRCHSORDRID IN NUMBER,
P_DOC_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS 
MONEY_DECIMALCOUNT NUMBER(16);
BEGIN
SELECT GN_MNEY_DECIMAL_CNT INTO MONEY_DECIMALCOUNT FROM GN_CORP_GLOBAL WHERE CORPRT_ID=P_CORPRT_ID;
OPEN P_OUT FOR

SELECT APRVLCNSLFLT_ID,FORMAT_DECIMAL(PRCHSORDR_NET_TOTAL ,MONEY_DECIMALCOUNT) "PRCHSORDR_NET_TOTAL",ins_user.USR_NAME "INS_USER",0 "STS",
APRVLCNSLFLT_APRVLSTS,APRVLCNSLFLT_LEVEL,APRVLCNSLFLT_STS,
(CASE 
WHEN (APRVLCNSLFLT_APRVLSTS=0) THEN apprvr_user.USR_NAME
WHEN (APRVLCNSLFLT_APRVLSTS=1) THEN apprvd_user.USR_NAME
WHEN (APRVLCNSLFLT_APRVLSTS=2) THEN rejectd_user.USR_NAME
END) "USR_NAME",
(CASE 
WHEN (APRVLCNSLFLT_APRVLSTS=0) THEN APRVLCNSLFLT_INS_DATE
WHEN (APRVLCNSLFLT_APRVLSTS=1) THEN APRVLCNSLFLT_APRVL_DATE
WHEN (APRVLCNSLFLT_APRVLSTS=2) THEN APRVLCNSLFLT_REJCT_DATE
END) "DATEVAL"
FROM PMS_APPROVAL_CONSOLE_FLOATING
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=P_PRCHSORDRID AND PMS_APPROVAL_CONSOLE_FLOATING.DOC_ID=1
INNER JOIN GN_USERS ins_user ON ins_user.USR_ID=PMS_APPROVAL_CONSOLE_FLOATING.APRVLCNSLFLT_INS_USR_ID
INNER JOIN GN_USERS apprvr_user ON apprvr_user.USR_ID=PMS_APPROVAL_CONSOLE_FLOATING.USR_ID
LEFT JOIN GN_USERS apprvd_user ON apprvd_user.USR_ID=PMS_APPROVAL_CONSOLE_FLOATING.APRVLCNSLFLT_APRVL_USR_ID
LEFT JOIN GN_USERS rejectd_user ON rejectd_user.USR_ID=PMS_APPROVAL_CONSOLE_FLOATING.APRVLCNSLFLT_REJCT_USR_ID
WHERE APRVLCNSLFLT_TRANSACTN_ID=P_PRCHSORDRID AND PMS_APPROVAL_CONSOLE_FLOATING.DOC_ID=P_DOC_ID

UNION

SELECT NULL "APRVLCNSLFLT_ID",NULL "PRCHSORDR_NET_TOTAL",NULL "INS_USER",1 "STS",0 "APRVLCNSLFLT_APRVLSTS",
NULL "APRVLCNSLFLT_LEVEL",PRCHSORDRNOTE_REPLYSTS "APRVLCNSLFLT_STS",USR_NAME,PRCHSORDRNOTE_INS_DATE "DATEVAL"
FROM PMS_PURCHASE_ORDER_NOTEDTLS
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID
WHERE PRCHSORDR_ID=P_PRCHSORDRID

UNION

SELECT NULL "APRVLCNSLFLT_ID",NULL "PRCHSORDR_NET_TOTAL",NULL "INS_USER",1 "STS",1 "APRVLCNSLFLT_APRVLSTS",
NULL "APRVLCNSLFLT_LEVEL",PRCHSORDRNOTE_REPLYSTS "APRVLCNSLFLT_STS",USR_NAME,PRCHSORDRNOTE_REPLY_DATE "DATEVAL"
FROM PMS_PURCHASE_ORDER_NOTEDTLS
INNER JOIN GN_USERS ON GN_USERS.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID
WHERE PRCHSORDR_ID=P_PRCHSORDRID

ORDER BY DATEVAL DESC,APRVLCNSLFLT_LEVEL ASC
;
END SP_READ_STATUS_DTLS;

PROCEDURE SP_READ_COMMENTDTLS(
P_PRCHSORDRID IN NUMBER,
P_DOC_ID IN NUMBER,
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_DOC_ID=1)THEN
OPEN P_OUT FOR
SELECT APRVLCNSLCMNT_ID,APRVLCNSLCMNT_VISBLSTS,APRVLCNSLCMNT_COMMENT,APRVLCNSLCMNT_INS_USR_ID,
APRVLCNSLCMNT_INS_DATE,GN_USERS.USR_NAME||' '||GN_USERS.EMPERDTL_MNAME||' '||GN_USERS.EMPERDTL_LNAME "USR_NAME",
(SELECT APRVLCNSLCMNTUSR_VIEW_CNT FROM PMS_APPROVAL_CONSOLE_COMMNTUSR WHERE PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USRID)
"APRVLCNSLCMNTUSR_VIEW_CNT"
FROM PMS_APPROVAL_CONSOLE_COMMNTDTL
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSL_ID
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID
INNER JOIN GN_USERS ON PMS_APPROVAL_CONSOLE_COMMNTDTL.APRVLCNSLCMNT_INS_USR_ID=GN_USERS.USR_ID 
WHERE PMS_APPROVAL_CONSOLE.PRCHSORDR_ID=P_PRCHSORDRID AND DOC_ID=1 ORDER BY APRVLCNSLCMNT_INS_DATE ASC;
END IF;
END SP_READ_COMMENTDTLS;

PROCEDURE SP_INSERT_COMMENTDTLS(
P_ID IN NUMBER,
P_APRVLCNSLCMNT_VISBLSTS IN NUMBER,
P_APRVLCNSLCMNT_COMMENT IN VARCHAR2,
P_USRID IN NUMBER
)
AS BEGIN
INSERT INTO PMS_APPROVAL_CONSOLE_COMMNTDTL
(
APRVLCNSLCMNT_ID,
APRVLCNSL_ID,
APRVLCNSLCMNT_VISBLSTS,
APRVLCNSLCMNT_COMMENT,
APRVLCNSLCMNT_INS_USR_ID,
APRVLCNSLCMNT_INS_DATE
)
VALUES(
SEQ_PMS_APRVLCNSLCMNT_ID.NEXTVAL,
P_ID,
P_APRVLCNSLCMNT_VISBLSTS,
P_APRVLCNSLCMNT_COMMENT,
P_USRID,
CURRENT_TIMESTAMP
);
END SP_INSERT_COMMENTDTLS;

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN

IF(P_REPLYSTS=0)THEN
OPEN P_OUT FOR----NOT REPLIED----
SELECT PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID,APRVLCNSLNOTE_MSG,APRVLCNSLNOTE_INS_USR_ID,APRVLCNSL_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
APRVLCNSLNOTE_REPLY_MSG,PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID "ATTCH_NOTEID",
APRVLCNSLATCHNT_FILENM,APRVLCNSLATCHNT_FILEACTNM,APRVLCNSLATCHNT_TYPE,
PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID "REPLY_FRM_USRID",PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID "REPLY_TO_USRID"
FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_APPROVAL_CONSOLE_NOTEATTCH ON PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID AND APRVLCNSLATCHNT_TYPE=0
WHERE PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID=P_ID AND PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID=P_USRID 
AND APRVLCNSLNOTE_REPLYSTS=0
ORDER BY PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID DESC;
ELSE
OPEN P_OUT FOR----REPLIED----
SELECT PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID,APRVLCNSLNOTE_MSG,APRVLCNSLNOTE_INS_USR_ID,APRVLCNSL_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
APRVLCNSLNOTE_REPLY_MSG,PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID "ATTCH_NOTEID",
APRVLCNSLATCHNT_FILENM,APRVLCNSLATCHNT_FILEACTNM,APRVLCNSLATCHNT_TYPE,
PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID "REPLY_FRM_USRID",PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID "REPLY_TO_USRID"
FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_APPROVAL_CONSOLE_NOTEATTCH ON PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID AND APRVLCNSLATCHNT_TYPE=1
WHERE PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID=P_ID AND PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID=P_USRID
AND APRVLCNSLNOTE_REPLYSTS=1
ORDER BY PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID DESC;
END IF;

END SP_READ_NOTEDTLS;

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_APRVLCNSLNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_ID OUT NUMBER
)AS BEGIN
SELECT SEQ_PMS_APRVLCNSL_NOTEID.NEXTVAL INTO P_OUT_ID FROM DUAL;

INSERT INTO PMS_APPROVAL_CONSOLE_NOTEDTLS
(
APRVLCNSLNOTE_ID,
APRVLCNSL_ID,
USR_ID,
APRVLCNSLNOTE_MSG,
APRVLCNSLNOTE_INS_USR_ID,
APRVLCNSLNOTE_INS_DATE
)
VALUES
(
P_OUT_ID,
P_ID,
P_TO_USRID,
P_APRVLCNSLNOTE_MSG,
P_FROM_USRID,
SYSDATE
);
END SP_INSERT_NOTE;

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_APRVLCNSLATCHNT_FILENM IN VARCHAR2,
P_APRVLCNSLATCHNT_FILEACTNM IN VARCHAR2,
P_APRVLCNSLATCHNT_TYPE IN NUMBER
)AS BEGIN
INSERT INTO PMS_APPROVAL_CONSOLE_NOTEATTCH
(
APRVLCNSL_NTATCHID,
APRVLCNSL_NOTEID,
APRVLCNSLATCHNT_FILENM,
APRVLCNSLATCHNT_FILEACTNM,
APRVLCNSLATCHNT_TYPE
)
VALUES
(
SEQ_PMS_APRVLCNSLATCHNT_ID.NEXTVAL,
P_NOTEID,
P_APRVLCNSLATCHNT_FILENM,
P_APRVLCNSLATCHNT_FILEACTNM,
P_APRVLCNSLATCHNT_TYPE
);
END SP_INSERT_NOTE_ATTCH;

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_APRVLCNSLNOTE_REPLY_MSG IN VARCHAR2
)AS BEGIN
UPDATE PMS_APPROVAL_CONSOLE_NOTEDTLS SET
APRVLCNSLNOTE_REPLYSTS=1,
APRVLCNSLNOTE_REPLY_MSG=P_APRVLCNSLNOTE_REPLY_MSG,
APRVLCNSLNOTE_REPLY_DATE=SYSDATE
WHERE APRVLCNSLNOTE_ID=P_NOTEID;
END SP_UPDATE_REPLYNOTE;


PROCEDURE SP_READ_ADDTNLDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN

IF(P_REPLYSTS=0)THEN
OPEN P_OUT FOR----NOT REPLIED----
SELECT PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID,APRVLCNSLADTNL_MSG,APRVLCNSLADTNL_INS_USR_ID,APRVLCNSL_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
APRVLCNSLADTNL_REPLY_MSG,PMS_APPROVAL_CONSOLE_ADDTNATCH.APRVLCNSLADTNL_ID "ATTCH_ADDTNLID",
APRVLCNSLATCHADDTN_FILENM,APRVLCNSLATCHADDTN_FILEACTNM,APRVLCNSLATCHADDTN_REPLYSTS,
PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_INS_USR_ID "REPLY_FRM_USRID",PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID "REPLY_TO_USRID"
FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_APPROVAL_CONSOLE_ADDTNATCH ON PMS_APPROVAL_CONSOLE_ADDTNATCH.APRVLCNSLADTNL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID AND APRVLCNSLATCHADDTN_REPLYSTS=0
WHERE PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID=P_ID AND PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID=P_USRID 
AND APRVLCNSLADTNL_REPLYSTS=0
ORDER BY PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID DESC;
ELSE
OPEN P_OUT FOR----REPLIED----
SELECT PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID,APRVLCNSLADTNL_MSG,APRVLCNSLADTNL_INS_USR_ID,APRVLCNSL_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
APRVLCNSLADTNL_REPLY_MSG,PMS_APPROVAL_CONSOLE_ADDTNATCH.APRVLCNSLADTNL_ID "ATTCH_ADDTNLID",
APRVLCNSLATCHADDTN_FILENM,APRVLCNSLATCHADDTN_FILEACTNM,APRVLCNSLATCHADDTN_REPLYSTS,
PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_INS_USR_ID "REPLY_FRM_USRID",PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID "REPLY_TO_USRID"
FROM PMS_APPROVAL_CONSOLE_ADDTNLDTL 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_APPROVAL_CONSOLE_ADDTNATCH ON PMS_APPROVAL_CONSOLE_ADDTNATCH.APRVLCNSLADTNL_ID=PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID AND APRVLCNSLATCHADDTN_REPLYSTS=1
WHERE PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSL_ID=P_ID AND PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_INS_USR_ID=P_USRID
AND APRVLCNSLADTNL_REPLYSTS=1
ORDER BY PMS_APPROVAL_CONSOLE_ADDTNLDTL.APRVLCNSLADTNL_ID DESC;
END IF;

END SP_READ_ADDTNLDTLS;

PROCEDURE SP_INSERT_ADDTNL(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_APRVLCNSLADTNL_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_ID OUT NUMBER
)AS BEGIN
SELECT SEQ_PMS_APRVLCNSL_ADTNLID.NEXTVAL INTO P_OUT_ID FROM DUAL;

INSERT INTO PMS_APPROVAL_CONSOLE_ADDTNLDTL
(
APRVLCNSLADTNL_ID,
APRVLCNSL_ID,
USR_ID,
APRVLCNSLADTNL_MSG,
APRVLCNSLADTNL_INS_USR_ID,
APRVLCNSLADTNL_INS_DATE
)
VALUES
(
P_OUT_ID,
P_ID,
P_TO_USRID,
P_APRVLCNSLADTNL_MSG,
P_FROM_USRID,
SYSDATE
);
END SP_INSERT_ADDTNL;

PROCEDURE SP_INSERT_ADDTNL_ATTCH(
P_ADDTNLID IN NUMBER,
P_APRVLCNSLATCHADDTN_FILENM IN VARCHAR2,
P_APRVLCNSLATCHADDTN_FILEACTNM IN VARCHAR2,
P_APRVLCNSLATCHADDTN_REPLYSTS IN NUMBER
)AS BEGIN
INSERT INTO PMS_APPROVAL_CONSOLE_ADDTNATCH
(
APRVLCNSL_ADTNLATCHID,
APRVLCNSLADTNL_ID,
APRVLCNSLATCHADDTN_FILENM,
APRVLCNSLATCHADDTN_FILEACTNM,
APRVLCNSLATCHADDTN_REPLYSTS
)
VALUES
(
SEQ_PMS_APRVLCNSL_ADTNLATCHID.NEXTVAL,
P_ADDTNLID,
P_APRVLCNSLATCHADDTN_FILENM,
P_APRVLCNSLATCHADDTN_FILEACTNM,
P_APRVLCNSLATCHADDTN_REPLYSTS
);
END SP_INSERT_ADDTNL_ATTCH;

PROCEDURE SP_UPDATE_REPLYADDTNL(
P_ADDTNLID IN NUMBER,
P_APRVLCNSLADTNL_REPLY_MSG IN VARCHAR2
)AS BEGIN
UPDATE PMS_APPROVAL_CONSOLE_ADDTNLDTL SET
APRVLCNSLADTNL_REPLYSTS=1,
APRVLCNSLADTNL_REPLY_MSG=P_APRVLCNSLADTNL_REPLY_MSG,
APRVLCNSLADTNL_REPLY_DATE=SYSDATE
WHERE APRVLCNSLADTNL_ID=P_ADDTNLID;
END SP_UPDATE_REPLYADDTNL;

PROCEDURE SP_INSERT_CMNT_USER(
P_PRCHSORDRID IN NUMBER,
P_USRID IN NUMBER,
P_CNT IN NUMBER
)AS 
VIEWCNT NUMBER(20);
BEGIN
SELECT COUNT(*) INTO VIEWCNT FROM PMS_APPROVAL_CONSOLE_COMMNTUSR WHERE PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USRID; 

IF(VIEWCNT=0)THEN
INSERT INTO PMS_APPROVAL_CONSOLE_COMMNTUSR
(
APRVLCNSLCMNTUSR_ID,
USR_ID,
APRVLCNSLCMNTUSR_VIEW_CNT,
PRCHSORDR_ID
)
VALUES
(
SEQ_PMS_APRVLCNSLCMNTUSR_ID.NEXTVAL,
P_USRID,
P_CNT,
P_PRCHSORDRID
);
ELSE
UPDATE PMS_APPROVAL_CONSOLE_COMMNTUSR SET
APRVLCNSLCMNTUSR_VIEW_CNT=P_CNT
WHERE PRCHSORDR_ID=P_PRCHSORDRID AND USR_ID=P_USRID;
END IF;
END SP_INSERT_CMNT_USER;

END PMS_APPROVALCONSOLE;

/
--------------------------------------------------------
--  DDL for Package Body PMS_APPROVALSET
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PMS_APPROVALSET" AS

PROCEDURE SP_LOAD_DOCUMENTS(
APPROVALSET_OUT OUT SYS_REFCURSOR
)
AS
BEGIN
OPEN APPROVALSET_OUT FOR
SELECT DOC_ID,DOC_NAME FROM PMS_APPROVAL_DOCUMENTS;
END SP_LOAD_DOCUMENTS;

  PROCEDURE SP_LOAD_CONDITIONS(
  APPROVALSET_DOCID NUMBER,
  APPROVALSET_OUT OUT SYS_REFCURSOR
)
  AS
  BEGIN
  OPEN APPROVALSET_OUT FOR
  SELECT DISTINCT(PMS_APPROVAL_CONDITIONS.CNDTN_ID),PMS_APPROVAL_CONDITIONS.CNDTN_NAME FROM PMS_APPROVAL_CONDITIONS
  INNER JOIN PMS_APPROVAL_CONDITIONS_DTLS ON PMS_APPROVAL_CONDITIONS.CNDTN_ID= PMS_APPROVAL_CONDITIONS_DTLS.CNDTN_ID
  WHERE DOC_ID= APPROVALSET_DOCID ORDER BY PMS_APPROVAL_CONDITIONS.CNDTN_ID;
  END SP_LOAD_CONDITIONS;

 PROCEDURE SP_LOAD_CONDITIONSTYPE(
 APPROVALSET_CNDTNID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
  OPEN APPROVALSET_OUT FOR
  SELECT DISTINCT(PMS_APPROVAL_CONDITION_TYPES.CNDTN_TYPE_ID),PMS_APPROVAL_CONDITION_TYPES.CNDTN_TYPE_NAME FROM PMS_APPROVAL_CONDITION_TYPES
   INNER JOIN PMS_APPROVAL_CONDITIONS_DTLS ON PMS_APPROVAL_CONDITION_TYPES.CNDTN_TYPE_ID=PMS_APPROVAL_CONDITIONS_DTLS.CNDTN_TYPE_ID
   WHERE PMS_APPROVAL_CONDITIONS_DTLS.CNDTN_ID= APPROVALSET_CNDTNID;
  END SP_LOAD_CONDITIONSTYPE;

 /*  PROCEDURE SP_LOAD_CONDITIONVALUES(
 APPROVALSET_TYPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
  OPEN APPROVALSET_OUT FOR
  SELECT PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTLVAL_ID,PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_ID,APRVLSET_DTL_MAXVAL,APRVLSET_DTL_MINVAL,CPRDEPT_ID FROM PMS_APPROVAL_SET_DTLSVALUE
   INNER JOIN PMS_APPROVAL_SET_DTLS ON PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_ID=PMS_APPROVAL_SET_DTLS.APRVLSET_DTL_ID
   WHERE PMS_APPROVAL_SET_DTLS.CNDTN_TYPE_ID= APPROVALSET_TYPID;
  END SP_LOAD_CONDITIONVALUES;*/

   PROCEDURE SP_LOAD_CORP_DEPTS(
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
)
AS 
BEGIN
OPEN APPROVALSET_OUT FOR
SELECT CPRDEPT_ID,CPRDEPT_NAME FROM GN_CORP_DEPTS WHERE ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID;
END SP_LOAD_CORP_DEPTS;

PROCEDURE SP_LOAD_SEARCH_CORP_DEPTS(
APPROVALSET_DEPTNAME IN VARCHAR2,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT OUT SYS_REFCURSOR
)
AS 
BEGIN
OPEN APPROVALSET_OUT FOR
SELECT CPRDEPT_ID,CPRDEPT_NAME FROM GN_CORP_DEPTS WHERE ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID
AND    UPPER(CPRDEPT_NAME) LIKE '%'||UPPER(APPROVALSET_DEPTNAME)||'%';
END SP_LOAD_SEARCH_CORP_DEPTS;

PROCEDURE SP_INS_APPROVALSET(
APPROVALSET_ID IN NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USRID NUMBER
)
AS
BEGIN
INSERT INTO PMS_APPROVAL_SET(APRVLSET_ID ,APRVLSET_NAME,APRVLSET_DESCRIPTN,DOC_ID,
CORPRT_ID,ORG_ID,APRVLSET_INS_USR_ID,APRVLSET_INS_DATE) VALUES (APPROVALSET_ID,APPROVALSET_NAME,APPROVALSET_DESC,
APPROVALSET_DOC_ID,APPROVALSET_CORPID,APPROVALSET_ORGID,APPROVALSET_USRID,SYSDATE);
END SP_INS_APPROVALSET;


PROCEDURE SP_INS_APPROVALSETDTL(
APPROVALSET_DTLID NUMBER,
APPROVALSET_ID NUMBER,
APPROVALSET_CNDTNID NUMBER,
APPROVALSET_TYPEID NUMBER
)
AS
BEGIN
INSERT INTO PMS_APPROVAL_SET_DTLS(APRVLSET_DTL_ID,APRVLSET_ID,CNDTN_ID,CNDTN_TYPE_ID)
VALUES(APPROVALSET_DTLID,APPROVALSET_ID,APPROVALSET_CNDTNID,APPROVALSET_TYPEID);
END SP_INS_APPROVALSETDTL;


/*PROCEDURE SP_INS_APPROVALSETVALUE(
APPROVALSET_DTLID NUMBER,
APPROVALSET_MINVAL NUMBER,
APPROVALSET_MAXVAL NUMBER,
APPROVALSET_DEPTID VARCHAR2
)
AS
BEGIN
INSERT INTO PMS_APPROVAL_SET_DTLSVALUE(APRVLSET_DTLVAL_ID,APRVLSET_DTL_ID,APRVLSET_DTL_MAXVAL,APRVLSET_DTL_MINVAL,CPRDEPT_ID)
VALUES(SEQ_PMS_APRVLSET_DTLVAL_ID.NEXTVAL, APPROVALSET_DTLID,APPROVALSET_MINVAL,APPROVALSET_MAXVAL,APPROVALSET_DEPTID);
END SP_INS_APPROVALSETVALUE;*/


PROCEDURE SP_UPDATE_APPROVALSET(
APPROVALSET_ID IN NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USRID NUMBER
)
AS
BEGIN
UPDATE  PMS_APPROVAL_SET SET 
APRVLSET_NAME=APPROVALSET_NAME,
APRVLSET_DESCRIPTN=APPROVALSET_DESC,
DOC_ID=APPROVALSET_DOC_ID,
APRVLSET_UPD_USR_ID=APPROVALSET_USRID,
APRVLSET_UPD_DATE=SYSDATE
WHERE APRVLSET_ID=APPROVALSET_ID;
END SP_UPDATE_APPROVALSET;


PROCEDURE SP_UPDATE_APPROVALSETDTL(
APPROVALSET_DTLID NUMBER,
APPROVALSET_ID NUMBER,
APPROVALSET_CNDTNID NUMBER,
APPROVALSET_TYPEID NUMBER
)
AS
BEGIN
if(APPROVALSET_DTLID!=0)THEN
UPDATE PMS_APPROVAL_SET_DTLS SET
CNDTN_ID=APPROVALSET_CNDTNID,
CNDTN_TYPE_ID=APPROVALSET_TYPEID
WHERE APRVLSET_DTL_ID=APPROVALSET_DTLID AND APRVLSET_ID=APPROVALSET_ID;
ELSE
INSERT INTO PMS_APPROVAL_SET_DTLS
(
APRVLSET_DTL_ID,
APRVLSET_ID,
CNDTN_ID,
CNDTN_TYPE_ID)
VALUES
(
SEQ_PMS_APRVLSET_DTL_ID.NEXTVAL,
APPROVALSET_ID,
APPROVALSET_CNDTNID,
APPROVALSET_TYPEID );
END IF;
END SP_UPDATE_APPROVALSETDTL;


PROCEDURE SP_UPDATE_APPROVALSETVALUE(
APPROVALSET_VALEID NUMBER,
APPROVALSET_DTLID NUMBER,

APPROVALSET_MAXVAL FLOAT,
APPROVALSET_MINVAL FLOAT,
APPROVALSET_DTLIST VARCHAR2,
CND_ID IN NUMBER
)
AS
BEGIN
IF(APPROVALSET_VALEID!=0 AND APPROVALSET_DTLID!=0) THEN
UPDATE PMS_APPROVAL_SET_DTLSVALUE SET
APRVLSET_DTL_MAXVAL=APPROVALSET_MAXVAL,
APRVLSET_DTL_MINVAL=APPROVALSET_MINVAL,
APRVLSET_DTL_VALUES=APPROVALSET_DTLIST
WHERE APRVLSET_DTLVAL_ID=APPROVALSET_VALEID AND APRVLSET_DTL_ID=APPROVALSET_DTLID;
ELSE
INSERT INTO PMS_APPROVAL_SET_DTLSVALUE
(
APRVLSET_DTLVAL_ID,
APRVLSET_DTL_ID,
APRVLSET_DTL_MAXVAL,
APRVLSET_DTL_MINVAL,

APRVLSET_DTL_VALUES)
VALUES
(
SEQ_PMS_APRVLSET_DTLVAL_ID.NEXTVAL,
 (SELECT COALESCE(MAX(APRVLSET_DTL_ID),0) FROM PMS_APPROVAL_SET_DTLS WHERE CNDTN_ID=CND_ID),
 APPROVALSET_MAXVAL,
APPROVALSET_MINVAL,

APPROVALSET_DTLIST);
END IF;
END SP_UPDATE_APPROVALSETVALUE;


PROCEDURE SP_READ_APPROVALSETLIST(

APPROVALSET_DOCID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_STATUS NUMBER,
APPROVALSET_CNCLSTS NUMBER,

APPROVALSET_OUT  OUT SYS_REFCURSOR 
)
AS
 T_QUERY VARCHAR2(5000);
BEGIN
T_QUERY:='SELECT APRVLSET_ID,APRVLSET_NAME,PMS_APPROVAL_SET.DOC_ID,PMS_APPROVAL_DOCUMENTS.DOC_NAME,APRVLSET_CONFRM_STS
FROM PMS_APPROVAL_SET INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_SET.DOC_ID=PMS_APPROVAL_DOCUMENTS.DOC_ID
WHERE  CORPRT_ID='||APPROVALSET_CORPID||' AND ORG_ID= '||APPROVALSET_ORGID||' AND PMS_APPROVAL_SET.DOC_ID='||APPROVALSET_DOCID;

IF(APPROVALSET_STATUS!=2)THEN
T_QUERY:=T_QUERY||' AND APRVLSET_CONFRM_STS='||APPROVALSET_STATUS||'';
END IF;
IF(APPROVALSET_CNCLSTS=1) THEN
T_QUERY:=T_QUERY||' AND APRVLSET_CNCL_USR_ID IS  NULL';
END IF;
IF(APPROVALSET_CNCLSTS=0) THEN
T_QUERY:=T_QUERY||' AND APRVLSET_CNCL_USR_ID IS NOT NULL';
END IF;
OPEN APPROVALSET_OUT FOR  T_QUERY;
END SP_READ_APPROVALSETLIST;

/*PROCEDURE SP_READ_APPROVALSETLISTBYID(
APPROVALSET_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_OUT  OUT SYS_REFCURSOR 
)
AS
BEGIN
OPEN APPROVALSET_OUT FOR
SELECT PMS_APPROVAL_SET.APRVLSET_ID,APRVLSET_NAME,APRVLSET_DESCRIPTN,PMS_APPROVAL_SET.DOC_ID,PMS_APPROVAL_DOCUMENTS.DOC_NAME,APRVLSET_CONFRM_STS,
PMS_APPROVAL_SET_DTLS.CNDTN_ID,PMS_APPROVAL_SET_DTLS.CNDTN_TYPE_ID,PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_MAXVAL,
PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_MINVAL,PMS_APPROVAL_SET_DTLSVALUE.CPRDEPT_ID,PMS_APPROVAL_SET_DTLS.APRVLSET_DTL_ID,
PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTLVAL_ID
FROM PMS_APPROVAL_SET
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_SET.DOC_ID=PMS_APPROVAL_DOCUMENTS.DOC_ID
INNER JOIN PMS_APPROVAL_SET_DTLS ON PMS_APPROVAL_SET_DTLS.APRVLSET_ID=PMS_APPROVAL_SET.APRVLSET_ID
INNER JOIN PMS_APPROVAL_SET_DTLSVALUE ON PMS_APPROVAL_SET_DTLSVALUE.APRVLSET_DTL_ID=PMS_APPROVAL_SET_DTLS.APRVLSET_DTL_ID
INNER JOIN PMS_APPROVAL_CONDITIONS ON PMS_APPROVAL_CONDITIONS.CNDTN_ID=PMS_APPROVAL_SET_DTLS.CNDTN_ID
INNER JOIN PMS_APPROVAL_CONDITION_TYPES ON PMS_APPROVAL_CONDITION_TYPES.CNDTN_TYPE_ID=PMS_APPROVAL_SET_DTLS.CNDTN_TYPE_ID
WHERE ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID AND PMS_APPROVAL_SET.APRVLSET_ID=APPROVALSET_ID;
END SP_READ_APPROVALSETLISTBYID;*/

PROCEDURE SP_CONFIRM_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_NAME IN VARCHAR2,
APPROVALSET_DESC IN VARCHAR2,
APPROVALSET_DOC_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
)
AS 
BEGIN
UPDATE PMS_APPROVAL_SET SET
APRVLSET_NAME=APPROVALSET_NAME,
APRVLSET_DESCRIPTN=APPROVALSET_DESC,
DOC_ID=APPROVALSET_DOC_ID,
APRVLSET_CONFRM_STS=1,
APRVLSET_CONFRM_USR_ID=APPROVALSET_USERID,
APRVLSET_CONFRM_DATE=SYSDATE
WHERE APRVLSET_ID=APPROVALSET_ID AND ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID;
END SP_CONFIRM_APPROVALSET;






PROCEDURE SP_REOPEN_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
)
AS 
BEGIN
UPDATE PMS_APPROVAL_SET SET
APRVLSET_CONFRM_STS=2,
APRVLSET_REOPN_USR_ID=APPROVALSET_USERID,
APRVLSET_REOPN_DATE=SYSDATE
WHERE APRVLSET_ID=APPROVALSET_ID AND ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID;
END SP_REOPEN_APPROVALSET;

PROCEDURE SP_DELETE_APPROVALSET(
APPROVALSET_ID NUMBER,
APPROVALSET_CNCLRSN VARCHAR2,
APPROVALSET_ORGID NUMBER,
APPROVALSET_CORPID NUMBER,
APPROVALSET_USERID NUMBER
)
AS 
BEGIN
UPDATE PMS_APPROVAL_SET SET
/*APRVLSET_CONFRM_STS=1,*/
APRVLSET_CNCL_USR_ID=APPROVALSET_USERID,
APRVLSET_CNCL_DATE=SYSDATE
WHERE APRVLSET_ID=APPROVALSET_ID AND ORG_ID=APPROVALSET_ORGID AND CORPRT_ID=APPROVALSET_CORPID;
END SP_DELETE_APPROVALSET;

PROCEDURE SP_DELETE_APPROVALSETDETAILS(
APPROVALSET_DET_ID NUMBER,
APPROVALSET_VALUE_ID NUMBER)
AS
BEGIN
DELETE FROM PMS_APPROVAL_SET_DTLSVALUE WHERE APRVLSET_DTLVAL_ID=APPROVALSET_VALUE_ID;
DELETE FROM PMS_APPROVAL_SET_DTLS WHERE APRVLSET_DTL_ID=APPROVALSET_DET_ID;
END SP_DELETE_APPROVALSETDETAILS;


PROCEDURE SP_READ_APPR_CONDITION(
A_OUT OUT SYS_REFCURSOR)
AS
BEGIN
OPEN A_OUT FOR
SELECT CNDTN_ID,CNDTN_NAME FROM PMS_APPROVAL_CONDITIONS;
END SP_READ_APPR_CONDITION;
PROCEDURE SP_READ_APPR_CONDITION_TYPE(
A_OUT OUT SYS_REFCURSOR)
AS
BEGIN
OPEN A_OUT FOR
SELECT CNDTN_TYPE_ID,CNDTN_TYPE_NAME FROM PMS_APPROVAL_CONDITION_TYPES;
END SP_READ_APPR_CONDITION_TYPE;

PROCEDURE SP_READ_PRODUCT_CATEGORY(
ORGID NUMBER,
CORPID NUMBER,
A_OUT OUT SYS_REFCURSOR
      )AS
      BEGIN
      OPEN A_OUT FOR
      SELECT CTGRY_ID,CTGRY_NAME FROM GN_PRODUCT_CATEGORY WHERE ORG_ID=ORGID AND CORPRT_ID=CORPID AND CTGRY_CNCL_USR_ID IS NULL AND CTGRY_STATUS!=0;
END SP_READ_PRODUCT_CATEGORY;
PROCEDURE SP_READ_PRODUCT(
ORGID NUMBER,
CORPID NUMBER,
      A_OUT OUT SYS_REFCURSOR
      )AS
      BEGIN
      OPEN A_OUT FOR
      SELECT PRDT_ID,PRDT_NAME FROM GN_PRODUCT_MASTER WHERE  ORG_ID=ORGID AND CORPRT_ID=CORPID AND PRDT_CNCL_USR_ID IS NULL AND PRDT_STATUS!=0;
     END SP_READ_PRODUCT;


PROCEDURE SP_READ_CND(
ORGID NUMBER,
CORPID NUMBER,
A_OUT OUT SYS_REFCURSOR,
A_OUT1 OUT SYS_REFCURSOR,
D_DEPT OUT SYS_REFCURSOR,
D_DIV OUT SYS_REFCURSOR
      )AS
      BEGIN
OPEN A_OUT FOR   
SELECT CTGRY_ID ,CTGRY_NAME   FROM GN_PRODUCT_CATEGORY  WHERE ORG_ID=ORGID AND CORPRT_ID=CORPID AND CTGRY_CNCL_USR_ID IS NULL AND CTGRY_STATUS!=0;
OPEN A_OUT1 FOR
SELECT PRDT_ID ,PRDT_NAME  FROM GN_PRODUCT_MASTER  WHERE ORG_ID=ORGID AND CORPRT_ID=CORPID AND PRDT_CNCL_USR_ID IS NULL AND PRDT_STATUS!=0;
OPEN D_DEPT FOR
  SELECT  DISTINCT CPRDEPT_NAME,CPRDEPT_ID FROM GN_CORP_DEPTS WHERE ORG_ID=ORGID AND CORPRT_ID=CORPID AND CPRDEPT_CNCL_USR_ID IS NULL AND CPRDEPT_STATUS!=0;   
  OPEN D_DIV FOR
   SELECT  DISTINCT CPRDIV_NAME,CPRDIV_ID FROM GN_CORP_DIVISIONS WHERE ORG_ID=ORGID AND CORPRT_ID=CORPID AND CPRDIV_CNCL_USR_ID IS NULL AND CPRDIV_STATUS!=0;   
END SP_READ_CND;


PROCEDURE SP_INS_APPROVAL_SET(
AP_ID IN NUMBER,
AP_NAME IN VARCHAR2,
AP_DESC IN VARCHAR2,
DO_ID IN NUMBER,
AP_CON_STATUS IN NUMBER,
COR_ID IN NUMBER,
OR_ID IN NUMBER,
A_IN_USR_ID IN NUMBER,
A_INS_DATE IN DATE,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE,
A_CNFM_ID IN NUMBER,
A_CNFM_DATE IN DATE,
A_REOPEN_ID IN NUMBER,
A_REOPEN_DATE IN DATE,
A_CNCL_USR_ID IN NUMBER,
A_CNCL_DATE IN DATE,
A_CNCL_RSN IN VARCHAR2)
AS 
BEGIN

INSERT INTO PMS_APPROVAL_SET
(
APRVLSET_ID,
APRVLSET_NAME,
APRVLSET_DESCRIPTN,
DOC_ID,
APRVLSET_CONFRM_STS,
CORPRT_ID,
ORG_ID,
APRVLSET_INS_USR_ID,
APRVLSET_INS_DATE,
APRVLSET_UPD_USR_ID,
APRVLSET_UPD_DATE,
APRVLSET_CONFRM_USR_ID,
APRVLSET_CONFRM_DATE,
APRVLSET_REOPN_USR_ID,
APRVLSET_REOPN_DATE,
APRVLSET_CNCL_USR_ID,
APRVLSET_CNCL_DATE,
APRVLSET_CNCL_REASN)
VALUES
(
AP_ID,
AP_NAME,
AP_DESC,
DO_ID,
AP_CON_STATUS,
COR_ID,
OR_ID,
A_IN_USR_ID,
A_INS_DATE,
A_UPD_ID,
A_UPD_DATE,
A_CNFM_ID,
A_CNFM_DATE,
A_REOPEN_ID,
A_REOPEN_DATE,
A_CNCL_USR_ID,
A_CNCL_DATE,
A_CNCL_RSN);

END SP_INS_APPROVAL_SET;

PROCEDURE SP_INS_APPROVAL_SET_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
CN_ID IN NUMBER,
CN_TY_ID IN NUMBER
)
AS

BEGIN

INSERT INTO PMS_APPROVAL_SET_DTLS
(
APRVLSET_DTL_ID,
APRVLSET_ID,
CNDTN_ID,
CNDTN_TYPE_ID)
VALUES
(
AP_DTL_ID,
(SELECT COALESCE(MAX(APRVLSET_ID),0) FROM PMS_APPROVAL_SET),
CN_ID,
CN_TY_ID);
END SP_INS_APPROVAL_SET_DTLS;

PROCEDURE SP_INS_APPROVAL_SET_DTLSVALUE(
AP_DTLVAL_ID IN NUMBER,
AP_DTL_ID IN NUMBER,
AP_DTL_MAXVAL IN FLOAT,
AP_DTL_MINVAL IN FLOAT,
AP_DTL_VALUES IN VARCHAR2,
CND_ID IN NUMBER)
AS


BEGIN
 INSERT INTO PMS_APPROVAL_SET_DTLSVALUE
(
APRVLSET_DTLVAL_ID,
APRVLSET_DTL_ID,
APRVLSET_DTL_MAXVAL,
APRVLSET_DTL_MINVAL,
APRVLSET_DTL_VALUES)
VALUES
(
AP_DTLVAL_ID,
 (SELECT COALESCE(MAX(APRVLSET_DTL_ID),0) FROM PMS_APPROVAL_SET_DTLS WHERE CNDTN_ID=CND_ID),
AP_DTL_MAXVAL,
AP_DTL_MINVAL,
AP_DTL_VALUES);
END SP_INS_APPROVAL_SET_DTLSVALUE;
PROCEDURE SP_CHECK_DUP_APP(
A_CORPID IN NUMBER,
A_ORGID IN NUMBER,
APP_NAME IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR )
AS
BEGIN
 OPEN A_OUT FOR
    SELECT APRVLSET_NAME FROM PMS_APPROVAL_SET where APRVLSET_NAME=APP_NAME AND CORPRT_ID=A_CORPID AND ORG_ID=A_ORGID and APRVLSET_CNCL_USR_ID is NULL;
      END SP_CHECK_DUP_APP;

PROCEDURE SP_READ_APPSETSTS(
A_ST IN NUMBER,
A_OUT OUT SYS_REFCURSOR
)
AS
BEGIN
 OPEN A_OUT FOR
    SELECT B.APRVLSET_ID,  B.APRVLSET_NAME,A.DOC_NAME,B.APRVLSET_CONFRM_STS,B.APRVLSET_CONFRM_USR_ID FROM PMS_APPROVAL_SET B INNER JOIN PMS_APPROVAL_DOCUMENTS A ON B.DOC_ID=A.DOC_ID AND B.APRVLSET_CONFRM_STS=A_ST  and B.APRVLSET_CNCL_USR_ID IS NULL   ;
      END SP_READ_APPSETSTS;

      PROCEDURE SP_CANCEL_APPROVALSET(
      APP_ID IN NUMBER,
      AT_CANCEL_USERID IN NUMBER,
      AT_CANCEL_DATE   IN DATE,
      AT_CANCEL_REASON IN VARCHAR2 )
      AS
      BEGIN
      UPDATE PMS_APPROVAL_SET SET APRVLSET_CNCL_USR_ID=AT_CANCEL_USERID,APRVLSET_CNCL_DATE=AT_CANCEL_DATE,APRVLSET_CNCL_REASN=AT_CANCEL_REASON WHERE APRVLSET_ID=APP_ID;
      END SP_CANCEL_APPROVALSET;


PROCEDURE SP_READ_APPROVAL
(
AP_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR)
AS
BEGIN
OPEN A_OUT FOR
SELECT A.APRVLSET_NAME,A.APRVLSET_DESCRIPTN,A.DOC_ID,B.APRVLSET_DTL_ID,
B.CNDTN_ID,D.CNDTN_NAME,B.CNDTN_TYPE_ID,E.CNDTN_TYPE_NAME,
C.APRVLSET_DTLVAL_ID,C.APRVLSET_DTL_MAXVAL,C.APRVLSET_DTL_MINVAL,C.APRVLSET_DTL_VALUES,A.APRVLSET_CONFRM_STS,A.APRVLSET_CNCL_USR_ID
FROM PMS_APPROVAL_SET A
INNER JOIN PMS_APPROVAL_SET_DTLS B ON A.APRVLSET_ID=B.APRVLSET_ID 
INNER JOIN PMS_APPROVAL_SET_DTLSVALUE C ON B.APRVLSET_DTL_ID = C.APRVLSET_DTL_ID 
INNER JOIN PMS_APPROVAL_CONDITIONS D ON B.CNDTN_ID=D.CNDTN_ID 
INNER JOIN PMS_APPROVAL_CONDITION_TYPES E ON B.CNDTN_TYPE_ID=E.CNDTN_TYPE_ID AND A.APRVLSET_ID=AP_ID 
ORDER BY B.CNDTN_ID;
END SP_READ_APPROVAL;


PROCEDURE SP_READ_APPROVALACTIVE(
ADOC_ID IN VARCHAR2,
A_STS IN NUMBER,
A_OUT OUT SYS_REFCURSOR
)
AS BEGIN
OPEN A_OUT FOR
SELECT B.APRVLSET_ID,B.APRVLSET_NAME,A.DOC_NAME,B.APRVLSET_CONFRM_STS,B.APRVLSET_CONFRM_USR_ID 
FROM PMS_APPROVAL_SET B 
INNER JOIN PMS_APPROVAL_DOCUMENTS A ON B.DOC_ID=A.DOC_ID 
AND B.DOC_ID=ADOC_ID and B.APRVLSET_CONFRM_STS=A_STS 
and B.APRVLSET_CNCL_USR_ID IS NULL;
END SP_READ_APPROVALACTIVE;


PROCEDURE SP_READ_APPROVALLIST(
A_DESG IN NUMBER,
A_OUT OUT SYS_REFCURSOR
)
AS BEGIN

IF(A_DESG=0)THEN

OPEN A_OUT FOR
SELECT B.APRVLSET_ID,B.APRVLSET_NAME,A.DOC_NAME,B.APRVLSET_CONFRM_STS,B.APRVLSET_CONFRM_USR_ID 
FROM PMS_APPROVAL_SET B INNER JOIN PMS_APPROVAL_DOCUMENTS A ON B.DOC_ID=A.DOC_ID AND B.APRVLSET_CNCL_USR_ID IS NULL;

ELSE

OPEN A_OUT FOR

SELECT PMS_APPROVAL_SET.APRVLSET_ID,APRVLSET_NAME,DOC_NAME,APRVLSET_CONFRM_STS,APRVLSET_CONFRM_USR_ID 
FROM PMS_APPROVAL_SET
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_APPROVAL_SET.DOC_ID
WHERE PMS_APPROVAL_SET.APRVLSET_CONFRM_STS=1 AND APRVLSET_CNCL_USR_ID IS NULL 
AND PMS_APPROVAL_SET.APRVLSET_ID IN(
SELECT APRVLSET_ID FROM PMS_APPROVAL_ASSGNMNT_DTLS
INNER JOIN PMS_APPROVAL_ASSGNMNT ON PMS_APPROVAL_ASSGNMNT.APRVLASGN_ID=PMS_APPROVAL_ASSGNMNT_DTLS.APRVLASGN_ID
WHERE DSGN_ID=A_DESG 
AND TO_DATE(APRVLASGN_STRTDATE,'DD-MM-YYYY')<=TO_DATE(SYSDATE,'DD-MM-YYYY')
AND TO_DATE(APRVLASGN_ENDDATE,'DD-MM-YYYY')>=TO_DATE(SYSDATE,'DD-MM-YYYY')
);

END IF;
END SP_READ_APPROVALLIST;




      PROCEDURE SP_READ_APPROVALCNCL(
A_OUT OUT SYS_REFCURSOR
)
AS
BEGIN
 OPEN A_OUT FOR
    SELECT B.APRVLSET_ID,B.APRVLSET_NAME,A.DOC_NAME,B.APRVLSET_CONFRM_STS,B.APRVLSET_CONFRM_USR_ID FROM PMS_APPROVAL_SET B  INNER JOIN PMS_APPROVAL_DOCUMENTS A ON B.DOC_ID=A.DOC_ID AND B.APRVLSET_CNCL_USR_ID IS NOT NULL;
      END SP_READ_APPROVALCNCL;

      PROCEDURE SP_READ_APPROVALCNFMSTS(
A_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
)
AS
BEGIN
 OPEN A_OUT FOR
    SELECT APRVLSET_CONFRM_STS FROM PMS_APPROVAL_SET   WHERE APRVLSET_ID=A_ID;
      END SP_READ_APPROVALCNFMSTS;

PROCEDURE SP_READ_APPROVLA_ASSIGNMENT(
AP_ID IN NUMBER,
A_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN A_OUT FOR
SELECT AP_ID FROM PMS_APPROVAL_ASSGNMNT_DTLS WHERE APRVLSET_ID=AP_ID AND APRVLASGN_CNCL_USR_ID IS NULL;
END SP_READ_APPROVLA_ASSIGNMENT;


PROCEDURE SP_READ_APPROVALAll(
ADOC_ID IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
)
AS
BEGIN
 OPEN A_OUT FOR
    SELECT B.APRVLSET_ID,B.APRVLSET_NAME,A.DOC_NAME,B.APRVLSET_CONFRM_STS,B.APRVLSET_CONFRM_USR_ID FROM PMS_APPROVAL_SET B INNER JOIN PMS_APPROVAL_DOCUMENTS A ON B.DOC_ID=A.DOC_ID AND B.DOC_ID=ADOC_ID and B.APRVLSET_CNCL_USR_ID IS NULL;
      END SP_READ_APPROVALAll;

END PMS_APPROVALSET;

/
--------------------------------------------------------
--  DDL for Package Body PMS_APPROVAL_ASSIGNMENT
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PMS_APPROVAL_ASSIGNMENT" AS
  PROCEDURE SP_READ_DESIGNATION(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
   OPEN A_OUT FOR

SELECT DSGN_ID,DSGN_NAME FROM GN_DESIGNATIONS WHERE DSGN_ID NOT IN
(SELECT DSGN_ID FROM PMS_APPROVAL_ASSGNMNT WHERE 
(SELECT COUNT(*) FROM PMS_APPROVAL_ASSGNMNT_DTLS WHERE PMS_APPROVAL_ASSGNMNT_DTLS.APRVLASGN_ID=PMS_APPROVAL_ASSGNMNT.APRVLASGN_ID
AND APRVLASGN_CNCL_USR_ID IS NULL)>0)
AND DSGN_STATUS=1 AND DSGN_CNCL_USR_ID IS NULL AND ORG_ID=A_ORGID
ORDER BY DSGN_NAME;

END SP_READ_DESIGNATION;


  PROCEDURE SP_READ_WORKFLOW(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_WRKNAME IN VARCHAR2,
A_DESG IN NUMBER,
A_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
   OPEN A_OUT FOR
   SELECT  DISTINCT A.WRKFLW_ID,A.WRKFLW_NAME FROM PMS_DOCUMNT_WRKFLW A 
   INNER JOIN PMS_DOCUMNT_WRKFLW_DTLS B ON B.WRKFLW_ID=A.WRKFLW_ID AND
    A.WRKFLW_CONFRM_USR_ID IS NOT NULL AND A.WRKFLW_CONFRM_STS=1 AND A.WRKFLW_CNCL_USR_ID IS NULL AND A.ORG_ID=A_ORGID AND A.CORPRT_ID=A_CORPID
   AND UPPER(A.WRKFLW_NAME) LIKE UPPER('%'||A_WRKNAME||'%') 
   ORDER BY WRKFLW_NAME;
  END SP_READ_WORKFLOW;


  PROCEDURE SP_READ_APPROVAL(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_NAME IN VARCHAR2,
A_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
   OPEN A_OUT FOR
   SELECT APRVLSET_ID,APRVLSET_NAME FROM PMS_APPROVAL_SET
   WHERE APRVLSET_CONFRM_STS=1 AND APRVLSET_CNCL_USR_ID IS NULL AND ORG_ID=A_ORGID AND CORPRT_ID=A_CORPID
   AND UPPER(APRVLSET_NAME) LIKE UPPER('%'||A_NAME||'%')
   ORDER BY APRVLSET_NAME;
  END SP_READ_APPROVAL;


  PROCEDURE SP_INS_APPROVAL_ASSGNMNT(
AP_ID IN NUMBER,
DSG_ID IN NUMBER,
COR_ID IN NUMBER,
OR_ID IN NUMBER,
A_IN_USR_ID IN NUMBER,
A_INS_DATE IN DATE,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE
)
AS 
BEGIN

INSERT INTO PMS_APPROVAL_ASSGNMNT
(
APRVLASGN_ID,
DSGN_ID,
CORPRT_ID,
ORG_ID,
APRVLASGN_INS_USR_ID,
APRVLASGN_INS_DATE,
APRVLASGN_UPD_USR_ID,
APRVLASGN_UPD_DATE
)
VALUES
(
AP_ID,
DSG_ID,
COR_ID,
OR_ID,
A_IN_USR_ID,
A_INS_DATE,
A_UPD_ID,
A_UPD_DATE
);

END SP_INS_APPROVAL_ASSGNMNT;


PROCEDURE SP_UPD_APPROVAL_ASSGNMNT(
AP_ID IN NUMBER,
DSG_ID IN NUMBER,
A_UPD_ID IN NUMBER,
A_UPD_DATE IN DATE
)
AS 
BEGIN

UPDATE PMS_APPROVAL_ASSGNMNT
SET

APRVLASGN_UPD_USR_ID=A_UPD_ID,
APRVLASGN_UPD_DATE=A_UPD_DATE WHERE APRVLASGN_ID=AP_ID AND
DSGN_ID=DSG_ID ;


END SP_UPD_APPROVAL_ASSGNMNT;




PROCEDURE SP_INS_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
WRKFLW_ID IN NUMBER,
APPSET_ID IN NUMBER,
AP_START IN DATE,
AP_END IN DATE,
AP_CNCL_USR_ID IN NUMBER,
AP_CONSOLE IN NUMBER
)
AS

BEGIN

INSERT INTO PMS_APPROVAL_ASSGNMNT_DTLS
(
APRVLASGN_DTL_ID,
APRVLASGN_ID,
WRKFLW_ID,
APRVLSET_ID,
APRVLASGN_STRTDATE,
APRVLASGN_ENDDATE,
APRVLASGN_CNCL_USR_ID,
APRVLASGN_CONSOLE
)
VALUES
(
AP_DTL_ID,
(SELECT COALESCE(MAX(APRVLASGN_ID),0) FROM PMS_APPROVAL_ASSGNMNT),
WRKFLW_ID,
APPSET_ID,
AP_START,
AP_END,
AP_CNCL_USR_ID,
AP_CONSOLE);
END SP_INS_APPROVAL_ASSGNMNT_DTLS;

PROCEDURE SP_UPD_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
AWRKFLW_ID IN NUMBER,
APPSET_ID IN NUMBER,
AP_START IN DATE,
AP_END IN DATE,
AP_CNCL_USR_ID IN NUMBER,
AP_CONSOLE IN NUMBER
)
AS

BEGIN
 IF(AP_DTL_ID!=0)THEN
 UPDATE PMS_APPROVAL_ASSGNMNT_DTLS SET 
 WRKFLW_ID=AWRKFLW_ID,
 APRVLSET_ID=APPSET_ID,
 APRVLASGN_STRTDATE=AP_START,
 APRVLASGN_ENDDATE=AP_END WHERE APRVLASGN_DTL_ID=AP_DTL_ID AND APRVLASGN_ID=AP_ID;
 ELSE
INSERT INTO PMS_APPROVAL_ASSGNMNT_DTLS
(
APRVLASGN_DTL_ID,
APRVLASGN_ID,
WRKFLW_ID,
APRVLSET_ID,
APRVLASGN_STRTDATE,
APRVLASGN_ENDDATE,
APRVLASGN_CNCL_USR_ID,
APRVLASGN_CONSOLE
)
VALUES
(
AP_DTL_ID,
AP_ID,
AWRKFLW_ID,
APPSET_ID,
AP_START,
AP_END,
AP_CNCL_USR_ID,
AP_CONSOLE);
END IF;
END SP_UPD_APPROVAL_ASSGNMNT_DTLS;

















PROCEDURE SP_READ_APPROVALASS(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN A_OUT FOR

   SELECT  A.APRVLASGN_ID, C.DSGN_NAME,COUNT(B.APRVLASGN_ID)  
   FROM PMS_APPROVAL_ASSGNMNT A  
   INNER JOIN PMS_APPROVAL_ASSGNMNT_DTLS B ON A.APRVLASGN_ID=B.APRVLASGN_ID 
   INNER JOIN GN_DESIGNATIONS C ON A.DSGN_ID=C.DSGN_ID
   AND A.ORG_ID=A_ORGID AND A.CORPRT_ID=A_CORPID AND B.APRVLASGN_CNCL_USR_ID IS NULL 
   GROUP BY C.DSGN_NAME ,A.APRVLASGN_ID,A.APRVLASGN_INS_USR_ID ORDER BY A.APRVLASGN_INS_USR_ID ;
   
--SELECT APRVLASGN_ID,DSGN_NAME,
--(SELECT COUNT(*) FROM PMS_APPROVAL_ASSGNMNT_DTLS WHERE PMS_APPROVAL_ASSGNMNT_DTLS.APRVLASGN_ID=PMS_APPROVAL_ASSGNMNT.APRVLASGN_ID
-- AND APRVLASGN_CNCL_USR_ID IS NULL) CNT
--FROM PMS_APPROVAL_ASSGNMNT
--INNER JOIN GN_DESIGNATIONS ON GN_DESIGNATIONS.DSGN_ID=PMS_APPROVAL_ASSGNMNT.DSGN_ID
--WHERE PMS_APPROVAL_ASSGNMNT.ORG_ID=A_ORGID AND PMS_APPROVAL_ASSGNMNT.CORPRT_ID=A_CORPID
--AND (SELECT COUNT(*) FROM PMS_APPROVAL_ASSGNMNT_DTLS WHERE PMS_APPROVAL_ASSGNMNT_DTLS.APRVLASGN_ID=PMS_APPROVAL_ASSGNMNT.APRVLASGN_ID
-- AND APRVLASGN_CNCL_USR_ID IS NULL)>0
--ORDER BY DSGN_NAME ASC;
   
END SP_READ_APPROVALASS;


  PROCEDURE SP_READ_APPROVALASSIGNMENT(
A_ORGID IN NUMBER,
A_CORPID IN NUMBER,
A_ID IN NUMBER,
A_OUT OUT SYS_REFCURSOR
) AS
  BEGIN
   OPEN A_OUT FOR
   SELECT A.DSGN_ID,C.DSGN_NAME,E.WRKFLW_ID,D.WRKFLW_NAME,E.APRVLSET_ID,F.APRVLSET_NAME ,E.APRVLASGN_STRTDATE,E.APRVLASGN_ENDDATE,E.APRVLASGN_CONSOLE,E.APRVLASGN_DTL_ID FROM PMS_APPROVAL_ASSGNMNT A  INNER JOIN PMS_APPROVAL_ASSGNMNT_DTLS E ON A.APRVLASGN_ID=E.APRVLASGN_ID 
   INNER JOIN GN_DESIGNATIONS C ON A.DSGN_ID=C.DSGN_ID INNER JOIN PMS_DOCUMNT_WRKFLW D ON E.WRKFLW_ID=D.WRKFLW_ID INNER JOIN PMS_APPROVAL_SET F ON E.APRVLSET_ID=F.APRVLSET_ID
 AND A.ORG_ID=A_ORGID AND A.CORPRT_ID=A_CORPID AND A.APRVLASGN_ID=A_ID AND E.APRVLASGN_CNCL_USR_ID IS NULL;
  END SP_READ_APPROVALASSIGNMENT;

  PROCEDURE SP_CNCL_APPROVAL_ASSGNMNT_DTLS
(
AP_DTL_ID IN NUMBER,
AP_ID IN NUMBER,
AP_CNCL_USR_ID IN NUMBER
)
AS

BEGIN

UPDATE PMS_APPROVAL_ASSGNMNT_DTLS SET 

APRVLASGN_CNCL_USR_ID=AP_CNCL_USR_ID WHERE APRVLASGN_DTL_ID=AP_DTL_ID AND
APRVLASGN_ID= AP_ID;

END SP_CNCL_APPROVAL_ASSGNMNT_DTLS;



 PROCEDURE SP_DELETE_APPROVAL_ASS_DTLS(
APP_DTL_ID NUMBER)
AS
BEGIN
DELETE FROM PMS_APPROVAL_ASSGNMNT_DTLS WHERE APRVLASGN_ID=APP_DTL_ID;
END SP_DELETE_APPROVAL_ASS_DTLS;


END PMS_APPROVAL_ASSIGNMENT;

/
--------------------------------------------------------
--  DDL for Package Body PMS_PURCHASE_ORDER
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "PMS_PURCHASE_ORDER" AS

PROCEDURE SP_READ_MODE_OF_SUPPLY(
P_OUT OUT SYS_REFCURSOR) AS
BEGIN
OPEN P_OUT FOR
SELECT * FROM PMS_MODE_OF_SUPPLY;
END SP_READ_MODE_OF_SUPPLY;

PROCEDURE SP_READ_PROJECTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_DIVID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_DIVID!=0) THEN
--OPEN P_OUT FOR
--SELECT PROJECT_ID,PROJECT_NAME FROM GN_PROJECTS WHERE PROJECT_CNCL_USR_ID IS NULL AND PROJECT_STATUS=1
--AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID IN (SELECT CPRDIV_ID FROM GN_USER_DIVISION WHERE USER_ID=P_USERID) ORDER BY PROJECT_NAME ASC;
--ELSE
OPEN P_OUT FOR
SELECT PROJECT_ID,PROJECT_NAME FROM GN_PROJECTS WHERE PROJECT_CNCL_USR_ID IS NULL AND PROJECT_STATUS=1
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID=P_DIVID ORDER BY PROJECT_ID ASC;
END IF;
END SP_READ_PROJECTS;

PROCEDURE SP_READ_WAREHOUSE(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_PROJECTID=0) THEN
OPEN P_OUT FOR
SELECT WRHS_ID,WRHS_NAME,null "PROJECTS_WAREHOUSE_PRIMARY_ID" FROM PMS_WAREHOUSE_MSTR WHERE WRHS_CNCL_USR_ID IS NULL AND WRHS_STATUS=1
AND PMS_WAREHOUSE_MSTR.CORPRT_ID=P_CORPID AND PMS_WAREHOUSE_MSTR.ORG_ID=P_ORGID ORDER BY WRHS_NAME ASC;
ELSE
OPEN P_OUT FOR
SELECT WRHS_ID,WRHS_NAME,PROJECTS_WAREHOUSE_PRIMARY_ID FROM PMS_WAREHOUSE_MSTR
LEFT JOIN GN_PROJECTS ON PMS_WAREHOUSE_MSTR.WRHS_ID IN 
(select regexp_substr(PROJECTS_WAREHOUSE_IDS,'[^,]+', 1, level) from dual
connect by regexp_substr(PROJECTS_WAREHOUSE_IDS, '[^,]+', 1, level) is not null) 
AND PROJECT_ID=P_PROJECTID
WHERE WRHS_CNCL_USR_ID IS NULL AND WRHS_STATUS=1
AND PMS_WAREHOUSE_MSTR.CORPRT_ID=P_CORPID AND PMS_WAREHOUSE_MSTR.ORG_ID=P_ORGID ORDER BY WRHS_NAME ASC;
END IF;
END SP_READ_WAREHOUSE;

PROCEDURE SP_READ_VENDORS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT SUPLIR_ID,SUPLIR_NAME FROM FMS_SUPPLIER_MASTER WHERE SUPLIR_CNCL_USR_ID IS NULL AND SUPLIR_STS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND UPPER(SUPLIR_NAME) LIKE UPPER('%'||P_SEARCHSTRING||'%') ORDER BY SUPLIR_NAME ASC;
END SP_READ_VENDORS;

PROCEDURE SP_READ_VENDORCNTCTPRSN(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_VENDORID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT SUPLIR_CNTCT_ID,SUPLIR_CNTCT_NAME,SUPLIR_CNTCT_ADDRESS,SUPLIR_CNTCT_MOBILE,SUPLIR_CNTCT_PHONE,SUPLIR_CNTCT_WEBSITE,SUPLIR_CNTCT_EMAIL,
FMS_SUPPLIER_MASTER.SUPLIR_RATING,FMS_SUPPLIER_MASTER.VNDRCTGRY_ID,VNDRCTGRY_NAME,SUPLIR_CONTACTNO
FROM FMS_SUPPLIER_MASTER
LEFT JOIN FMS_SUPPLIER_CONTACT ON FMS_SUPPLIER_MASTER.SUPLIR_ID=FMS_SUPPLIER_CONTACT.SUPLIR_ID
LEFT JOIN PMS_VENDOR_CATGRY ON FMS_SUPPLIER_MASTER.VNDRCTGRY_ID=PMS_VENDOR_CATGRY.VNDRCTGRY_ID
WHERE SUPLIR_CNCL_USR_ID IS NULL AND SUPLIR_STS=1 
AND FMS_SUPPLIER_MASTER.CORPRT_ID=P_CORPID AND FMS_SUPPLIER_MASTER.ORG_ID=P_ORGID AND FMS_SUPPLIER_MASTER.SUPLIR_ID=P_VENDORID;
END SP_READ_VENDORCNTCTPRSN;

PROCEDURE SP_READ_DOCUMNT_WRKFLOW(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT WRKFLW_ID,WRKFLW_NAME FROM PMS_DOCUMNT_WRKFLW 
INNER JOIN PMS_APPROVAL_DOCUMENTS ON PMS_APPROVAL_DOCUMENTS.DOC_ID=PMS_DOCUMNT_WRKFLW.DOC_ID
WHERE WRKFLW_STATUS=1 AND WRKFLW_CONFRM_STS=1 AND WRKFLW_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND PMS_DOCUMNT_WRKFLW.DOC_ID=1
ORDER BY WRKFLW_NAME ASC;
END SP_READ_DOCUMNT_WRKFLOW;

PROCEDURE SP_READ_DIVISION(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USERID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_USERID!=0)THEN
OPEN P_OUT FOR
SELECT CPRDIV_ID,CPRDIV_NAME FROM GN_CORP_DIVISIONS WHERE CPRDIV_CNCL_USR_ID IS NULL AND CPRDIV_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CPRDIV_ID IN (SELECT CPRDIV_ID FROM GN_USER_DIVISION WHERE USER_ID=P_USERID) ORDER BY CPRDIV_NAME ASC;
ELSE
OPEN P_OUT FOR
SELECT CPRDIV_ID,CPRDIV_NAME FROM GN_CORP_DIVISIONS WHERE CPRDIV_CNCL_USR_ID IS NULL AND CPRDIV_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID ORDER BY CPRDIV_NAME ASC;
END IF;
END SP_READ_DIVISION;

PROCEDURE SP_READ_CUSTOMERS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_DIVSNID IN NUMBER,
P_PROJECTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT GN_CUSTOMER_MASTER.CSTMR_ID,CSTMR_NAME,GN_PROJECTS.CSTMR_ID "PRJCT_CSTMRID" FROM GN_CUSTOMER_MASTER 
LEFT JOIN GN_PROJECTS ON GN_PROJECTS.CSTMR_ID=GN_CUSTOMER_MASTER.CSTMR_ID AND GN_PROJECTS.PROJECT_ID=P_PROJECTID
WHERE CSTMR_CNCL_USR_ID IS NULL AND CSTMR_STATUS=1 
AND GN_CUSTOMER_MASTER.CORPRT_ID=P_CORPID AND GN_CUSTOMER_MASTER.ORG_ID=P_ORGID ORDER BY CSTMR_NAME ASC;
END SP_READ_CUSTOMERS;

PROCEDURE SP_READ_POCONTACTPRSNS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CUSTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT CSTMRCNT_ID,CSTMRCNT_NAME,CSTMRCNT_ADDRESS,CSTMRCNT_MOBILE,CSTMRCNT_PHONE,CSTMRCNT_EMAIL,CSTMRCNT_WEBSITE,
CSTMRCNT_MAIL_ALWD,CSTMR_MOBILE 
FROM GN_CUSTOMER_CONTACT 
INNER JOIN GN_CUSTOMER_MASTER ON GN_CUSTOMER_MASTER.CSTMR_ID=GN_CUSTOMER_CONTACT.CSTMR_ID
WHERE CSTMR_CNCL_USR_ID IS NULL AND CSTMR_STATUS=1 
AND GN_CUSTOMER_MASTER.CORPRT_ID=P_CORPID AND GN_CUSTOMER_MASTER.ORG_ID=P_ORGID AND GN_CUSTOMER_CONTACT.CSTMR_ID=P_CUSTID;
END SP_READ_POCONTACTPRSNS;

PROCEDURE SP_READ_PRODUCTS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT PRDT_ID,(CASE WHEN (PRDT_CODE is not null) THEN PRDT_CODE || '-' ||upper( PRDT_NAME) ELSE upper(PRDT_NAME) END) as PRDT_NAME
FROM GN_PRODUCT_MASTER WHERE PRDT_CNCL_USR_ID IS NULL AND PRDT_STATUS=1 
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND UPPER(PRDT_NAME) LIKE UPPER('%'||P_SEARCHSTRING||'%');
END SP_READ_PRODUCTS;

PROCEDURE SP_READ_VEHICLES(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SEARCHSTRING IN VARCHAR2,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT FLT_VEHICLES.VHCL_ID "PRDT_ID",VHCL_NUMBR || '-' || VHCLCLS_NAME "PRDT_NAME" FROM FLT_VEHICLES
INNER JOIN FLT_VEHICLE_CLASS ON FLT_VEHICLE_CLASS.VHCLCLS_ID=FLT_VEHICLES.VHCLCLS_ID
WHERE VHCL_CNCL_USR_ID IS NULL AND VHCL_STATUS=1 
AND FLT_VEHICLES.CORPRT_ID=P_CORPID AND FLT_VEHICLES.ORG_ID=P_ORGID AND UPPER(VHCL_NUMBR) LIKE UPPER('%'||P_SEARCHSTRING||'%');
END SP_READ_VEHICLES;

PROCEDURE SP_READ_EMPLOYEEDTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_EMPID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT USR_CODE,
(SELECT 
TO_CHAR(SYS_XMLAGG (XMLELEMENT (CPRDIV_NAME, CPRDIV_NAME || ',')).EXTRACT ('/ROWSET/CPRDIV_NAME/text()').getclobval ())
FROM GN_USER_DIVISION 
INNER JOIN GN_CORP_DIVISIONS ON GN_CORP_DIVISIONS.CPRDIV_ID=GN_USER_DIVISION.CPRDIV_ID
WHERE GN_USER_DIVISION.ORG_ID=P_ORGID AND USER_ID=P_EMPID AND USRDIV_PRIMARY_STS=1
) "CPRDIV_NAME"
FROM GN_USERS 
WHERE CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND USR_ID=P_EMPID;
END SP_READ_EMPLOYEEDTLS;

PROCEDURE READ_PRODUCT_TAX_DTLS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_PRDCTID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS
MONEY_DECIMALCOUNT NUMBER(16);
BEGIN
SELECT GN_MNEY_DECIMAL_CNT INTO MONEY_DECIMALCOUNT FROM GN_CORP_GLOBAL WHERE CORPRT_ID=P_CORPID;
OPEN P_OUT FOR
SELECT FORMAT_DECIMAL(PRDT_COST_PRICE ,MONEY_DECIMALCOUNT) "PRDT_COST_PRICE",
GN_TAX_MASTER.TAX_ID,GN_TAX_MASTER.TAX_NAME,GN_TAX_MASTER.TAX_PERCENTAGE
FROM GN_PRODUCT_MASTER
LEFT JOIN GN_TAX_MASTER ON GN_PRODUCT_MASTER.TAX_ID=GN_TAX_MASTER.TAX_ID
WHERE GN_PRODUCT_MASTER.PRDT_ID=P_PRDCTID;
END READ_PRODUCT_TAX_DTLS;

PROCEDURE SP_INSERT_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_USRID IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_REF IN VARCHAR2,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_MASTER
(
PRCHSORDR_ID,
PRCHSORDR_TYPE,
WRKFLW_ID,
PRCHSORDR_REF,
PRCHSORDR_DATE,
PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME,
PRCHSORDR_ENDCSTMRNAME,
PRCHSORDR_DLVRYTO_STS,
WRHS_ID,
PRCHSORDR_DLVRLCTN_WRHS,
PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO,
PRCHSORDR_QTNDATE,
SUPLIR_ID,
PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID,
PRCHSORDR_VENDOR_CONTCTNAME,
PRCHSORDR_VENDOR_ADDRSS,
PRCHSORDR_VENDOR_MOBILE,
PRCHSORDR_VENDOR_PHONE,
PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL,
PRCHSORDR_VENDOR_FUTUREUSE,
PRCHSORDR_VENDOR_COMMNTS,
CPRDIV_ID,
PROJECT_ID,
CSTMR_ID,
PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY,
PRCHSORDR_PO_CONTACTPRSN_ID,
PRCHSORDR_PO_MOBILE,
PRCHSORDR_PO_REQSTNNO,
PRCHSORDR_PO_REQSTNDATE,
PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY,
PRCHSORDR_JOBCODE,
PRCHSORDR_JOBDESCRPTN,
CRNCMST_ID,
PRCHSORDR_EXCHNG_RATE,
PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL,
PRCHSORDR_TAX_TOTAL,
PRCHSORDR_DISCOUNT,
PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM,
PRCHSORDR_TERM_CNDTNS,
PRCHSORDR_FRGHT_TERM,
CORPRT_ID,
ORG_ID,
PRCHSORDR_INS_USR_ID,
PRCHSORDR_INS_DATE
)
VALUES
(
P_ID,
P_PRCHSORDR_TYPE,
P_WRKFLW_ID,
P_PRCHSORDR_REF,
P_PRCHSORDR_DATE,
P_PRCHSORDR_DLVRYDT,
P_PRCHSORDR_CLIENTNAME,
P_PRCHSORDR_ENDCSTMRNAME,
P_PRCHSORDR_DLVRYTO_STS,
P_WRHS_ID,
P_PRCHSORDR_DLVRLCTN_WRHS,
P_PRCHSORDR_DLVRLCTN_PRJCT,
P_PRCHSORDR_QTNNO,
P_PRCHSORDR_QTNDATE,
P_SUPLIR_ID,
P_PRCHSORDR_VENDOR_REFNO,
P_PRCHSORDR_VENDOR_CONTCT_ID,
P_PRCHSORDR_VENDOR_CONTCTNAME,
P_PRCHSORDR_VENDOR_ADDRSS,
P_PRCHSORDR_VENDOR_MOBILE,
P_PRCHSORDR_VENDOR_PHONE,
P_PRCHSORDR_VENDOR_FAX,
P_PRCHSORDR_VENDOR_EMAIL,
P_PRCHSORDR_VENDOR_FUTUREUSE,
P_PRCHSORDR_VENDOR_COMMNTS,
P_CPRDIV_ID,
P_PROJECT_ID,
P_CSTMR_ID,
P_PRCHSORDR_REQRMNTDATE,
P_PRCHSORDR_MODOFSUPPLY,
P_PRCHSORDR_PO_CONTACTPRSN_ID,
P_PRCHSORDR_PO_MOBILE,
P_PRCHSORDR_PO_REQSTNNO,
P_PRCHSORDR_PO_REQSTNDATE,
P_PRCHSORDR_PO_APPRVLDATE,
P_PRCHSORDR_PRIORTY,
P_PRCHSORDR_JOBCODE,
P_PRCHSORDR_JOBDESCRPTN,
P_CRNCMST_ID,
P_PRCHSORDR_EXCHNG_RATE,
P_PRCHSORDR_AMNT_EXCNG,
P_PRCHSORDR_GROSS_TOTAL,
P_PRCHSORDR_TAX_TOTAL,
P_PRCHSORDR_DISCOUNT,
P_PRCHSORDR_NET_TOTAL,
P_PRCHSORDR_PAYMT_TERM,
P_PRCHSORDR_TERM_CNDTNS,
P_PRCHSORDR_FRGHT_TERM,
P_CORPID,
P_ORGID,
P_USRID,
SYSDATE
);

INSERT INTO PMS_APPROVAL_CONSOLE_FLOATING
(
APRVLCNSLFLT_ID,
DOC_ID,
APRVLCNSLFLT_TRANSACTN_ID,
WRKFLW_ID,
USR_ID,
CORPRT_ID,
ORG_ID,
APRVLCNSLFLT_INS_USR_ID,
APRVLCNSLFLT_INS_DATE,
APRVLCNSLFLT_REF,
APRVLCNSLFLT_DATE,
APRVLCNSLFLT_STS
)
VALUES
(
SEQ_PMS_APRVLCNSLFLT_ID.NEXTVAL,
1,
P_ID,
P_WRKFLW_ID,
P_USRID,
P_CORPID,
P_ORGID,
P_USRID,
SYSDATE,
P_PRCHSORDR_REF,
P_PRCHSORDR_DATE,
0
);

END SP_INSERT_PURCHASE_ORDER;

PROCEDURE SP_INSERT_PRODUCT_DTLS(
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_DTLS
(
PRCHSORDR_DTL_ID,
PRCHSORDR_ID,
PRCHSORDR_DTL_QNTY,
PRCHSORDR_DTL_RATE,
PRCHSORDR_DTL_TOTLAMNT,
PRDT_ID,
PRCHSORDR_DTL_DISCNTPCNT,
PRCHSORDR_DTL_DISCNTAMT,
PRCHSORDR_DTL_TAXID,
PRCHSORDR_DTL_TAXPRCNT,
VHCL_ID,
PRCHSORDR_DTL_STRTDATE,
PRCHSORDR_DTL_ENDDATE,
USR_ID,
PRCHSORDR_DTL_PNRNO,
PRCHSORDR_DTL_SECTOR,
PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS,
PRCHSORDR_DTL_SLNO
)
VALUES
(
SEQ_PMS_PRCHSORDRDTL_ID.NEXTVAL,
P_ID,
P_PRCHSORDR_DTL_QNTY,
P_PRCHSORDR_DTL_RATE,
P_PRCHSORDR_DTL_TOTLAMNT,
P_PRDT_ID,
P_PRCHSORDR_DTL_DISCNTPCNT,
P_PRCHSORDR_DTL_DISCNTAMT,
P_PRCHSORDR_DTL_TAXID,
P_PRCHSORDR_DTL_TAXPRCNT,
P_VHCL_ID,
P_PRCHSORDR_DTL_STRTDATE,
P_PRCHSORDR_DTL_ENDDATE,
P_USR_ID,
P_PRCHSORDR_DTL_PNRNO,
P_PRCHSORDR_DTL_SECTOR,
P_PRCHSORDR_DTL_TRVLDATE,
P_PRCHSORDR_DTL_REMARKS,
P_PRCHSORDR_DTL_SLNO
);
END SP_INSERT_PRODUCT_DTLS;

PROCEDURE SP_READ_PURCHASE_ORDER_LIST(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_SUPLIR_ID IN NUMBER,
P_STRTDATE IN DATE,
P_ENDDATE IN DATE,
P_WRKFLW_ID IN NUMBER,
P_STATUS IN NUMBER,
P_CNCLSTS IN NUMBER,
P_PRCHSORDR_TYPE IN NUMBER,
-------PAGEINATION-------
P_COMMON_SEARCH_TERM IN VARCHAR2,
P_SEARCH_PRCHSORDR_DATE IN VARCHAR2,
P_SEARCH_PRCHSORDR_REFNO IN VARCHAR2,
P_SEARCH_PRCHSORDR_POTYPE IN VARCHAR2,
P_SEARCH_PRCHSORDR_VENDOR IN VARCHAR2,
P_SEARCH_PRCHSORDR_DOCMNT IN VARCHAR2,
P_SEARCH_PRCHSORDR_DLVRYDT IN VARCHAR2,
P_SEARCH_PRCHSORDR_AMNT IN VARCHAR2,
P_ORDER_COLUMN IN NUMBER,
P_ORDER_METHOD IN NUMBER,
P_PAGE_MAXSIZE IN NUMBER,
P_PAGE_NUMBER IN NUMBER,
-------PAGEINATION-------
P_USRID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS
T_QUERY VARCHAR2(32767);
T_GETDATA VARCHAR2(32767);
MONEY_DECIMALCOUNT NUMBER(16);
BEGIN

SELECT GN_MNEY_DECIMAL_CNT INTO MONEY_DECIMALCOUNT FROM GN_CORP_GLOBAL WHERE CORPRT_ID=P_CORPID;

T_GETDATA:='SELECT PRCHSORDR_ID,TO_CHAR(PRCHSORDR_DATE,''DD-MM-YYYY'') PRCHSORDR_DATE,PRCHSORDR_REF,SUPLIR_NAME,WRKFLW_NAME,
PRCHSORDR_CONFRM_STS,TO_CHAR(PRCHSORDR_DLVRYDT,''DD-MM-YYYY'') PRCHSORDR_DLVRYDT,
FORMAT_DECIMAL(PRCHSORDR_NET_TOTAL,'||MONEY_DECIMALCOUNT||') PRCHSORDR_NET_TOTAL,PRCHSORDR_REOPN_USR_ID,
DECODE(PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE,1,''PRODUCTS'',2,''CAR RENTAL'',3,''AIR TICKET'')"PO_TYP",
GN_USERS.USR_NAME||'' ''||GN_USERS.EMPERDTL_MNAME||'' ''||GN_USERS.EMPERDTL_LNAME "NOTE_TO_USRNAME",PRCHSORDR_INS_USR_ID,PROJECT_NAME,

(
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_NOTEDTLS WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND USR_ID='||P_USRID||' AND PRCHSORDRNOTE_REPLYSTS=0)
)"USR_NOTECNT",
(
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_NOTEDTLS WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PRCHSORDRNOTE_REPLYSTS=0 AND PRCHSORDR_NOTEID = (SELECT MAX(PRCHSORDR_NOTEID) FROM PMS_PURCHASE_ORDER_NOTEDTLS 
WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) )
) "NOTECNT",
(
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_NOTEDTLS WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PRCHSORDRNOTE_INS_USR_ID='||P_USRID||' AND PRCHSORDRNOTE_REPLYSTS=1
AND PRCHSORDR_NOTEID = (SELECT MAX(PRCHSORDR_NOTEID) FROM PMS_PURCHASE_ORDER_NOTEDTLS 
WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID) )
) "USR_REPLYCNT",

(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_COMMENTDTLS WHERE PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PRCHSORDRCMNT_VISBLSTS=0)+
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_COMMENTDTLS WHERE PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PRCHSORDRCMNT_INS_USR_ID='||P_USRID||' AND PRCHSORDRCMNT_VISBLSTS=1)
"COMMNTCNT"

FROM PMS_PURCHASE_ORDER_MASTER 
INNER JOIN FMS_SUPPLIER_MASTER ON FMS_SUPPLIER_MASTER.SUPLIR_ID=PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
LEFT JOIN GN_USERS ON GN_USERS.USR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_INS_USR_ID --NOTE_TO_USER--
LEFT JOIN GN_PROJECTS ON GN_PROJECTS.PROJECT_ID=PMS_PURCHASE_ORDER_MASTER.PROJECT_ID
WHERE PMS_PURCHASE_ORDER_MASTER.CORPRT_ID='||P_CORPID||' AND PMS_PURCHASE_ORDER_MASTER.ORG_ID='||P_ORGID||'';
IF(P_PRCHSORDR_TYPE!=0) THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE='||P_PRCHSORDR_TYPE||'';
END IF;
IF(P_SUPLIR_ID!=0)THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID='||P_SUPLIR_ID||'';
END IF;
IF(P_WRKFLW_ID!=0)THEN
T_GETDATA:=T_GETDATA||' AND PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID='||P_WRKFLW_ID||'';
END IF;
IF(P_STRTDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')>=TO_DATE('''||P_STRTDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_ENDDATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND TO_DATE(PRCHSORDR_DATE,''DD-MM-YYYY'')<=TO_DATE('''||P_ENDDATE||''',''DD-MM-YYYY'')';
END IF;
IF(P_STATUS!=3) THEN
IF(P_STATUS!=2)THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CONFRM_STS='||P_STATUS||'';
END IF;
IF(P_STATUS=2) THEN--REOPEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CONFRM_STS=0 AND PRCHSORDR_REOPN_USR_ID IS NOT NULL';
ELSIF(P_STATUS=0)THEN--PENDING
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_REOPN_USR_ID IS NULL';
END IF;

END IF;
IF(P_CNCLSTS=1) THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CNCL_USR_ID IS NOT NULL';
ELSE
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_CNCL_USR_ID IS NULL';
END IF;

------------------------------FOR SEARCH----------------------------
IF(P_COMMON_SEARCH_TERM IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' 
AND
(
PRCHSORDR_DATE LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%''
OR UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(DECODE(PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE,1,''PRODUCTS'',2,''CAR RENTAL'',3,''AIR TICKET'')) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(SUPLIR_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR PRCHSORDR_DLVRYDT LIKE ''%''||'''||P_COMMON_SEARCH_TERM||'''||''%''
OR PRCHSORDR_NET_TOTAL LIKE ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%''
OR ''%''||UPPER('''||P_COMMON_SEARCH_TERM||''')||''%'' = ''''
)';
END IF;

IF(P_SEARCH_PRCHSORDR_DATE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_DATE LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DATE||'''||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_REFNO IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(PRCHSORDR_REF) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_REFNO||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_POTYPE IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(DECODE(PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_TYPE,1,''PRODUCTS'',2,''CAR RENTAL'',3,''AIR TICKET'')) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_POTYPE||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_VENDOR IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(SUPLIR_NAME) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_VENDOR||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_DOCMNT IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND UPPER(WRKFLW_NAME) LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_DOCMNT||''')||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_DLVRYDT IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_DLVRYDT LIKE ''%''||'''||P_SEARCH_PRCHSORDR_DLVRYDT||'''||''%''';
END IF;
IF(P_SEARCH_PRCHSORDR_AMNT IS NOT NULL)THEN
T_GETDATA:=T_GETDATA||' AND PRCHSORDR_NET_TOTAL LIKE ''%''||UPPER('''||P_SEARCH_PRCHSORDR_AMNT||''')||''%''';
END IF;

------------------------------FOR SEARCH----------------------------

IF(P_ORDER_COLUMN=0)THEN--1st load
T_GETDATA:=T_GETDATA||' ORDER BY PRCHSORDR_ID DESC';

ELSE
IF(P_ORDER_METHOD=0)THEN
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' ASC';
ELSE
T_GETDATA:=T_GETDATA||' ORDER BY '||P_ORDER_COLUMN||' DESC';
END IF;

END IF;

------------------------------FOR PAGEINATION-----------------------
IF(P_PAGE_MAXSIZE!=0)THEN
T_QUERY:=
'SELECT * FROM 
(
select val.*, ROWNUM rnum,
(SELECT COUNT(*) FROM (
'||T_GETDATA||'
)) CNT
from
(
'||T_GETDATA||'
) val
where ROWNUM <= ('||P_PAGE_NUMBER||'*'||P_PAGE_MAXSIZE||')
)
where rnum  >= ((('||P_PAGE_NUMBER||' - 1) * '||P_PAGE_MAXSIZE||') + 1)
';
ELSE
T_QUERY:=T_GETDATA;
END IF;
------------------------------FOR PAGEINATION-----------------------

OPEN P_OUT FOR T_QUERY;
--createfile(T_QUERY,'PRCHSORDR');
END SP_READ_PURCHASE_ORDER_LIST;

PROCEDURE SP_CANCEL_PURCHASE_ORDER(
P_ID IN NUMBER,
P_CNCLREASON IN VARCHAR2,
P_USRID IN NUMBER
)AS BEGIN

UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_CNCL_USR_ID=P_USRID,
PRCHSORDR_CNCL_DATE=SYSDATE,
PRCHSORDR_CNCL_REASN=P_CNCLREASON
WHERE PRCHSORDR_ID=P_ID;

DELETE FROM PMS_APPROVAL_CONSOLE_FLOATING WHERE APRVLCNSLFLT_TRANSACTN_ID=P_ID AND DOC_ID=1;

END SP_CANCEL_PURCHASE_ORDER;

PROCEDURE SP_READ_PURCHS_ORDER_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_TYPE,PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID,
PRCHSORDR_REF,TO_CHAR(PRCHSORDR_DATE,'DD-MM-YYYY') PRCHSORDR_DATE,TO_CHAR(PRCHSORDR_DLVRYDT,'DD-MM-YYYY') PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME,PRCHSORDR_ENDCSTMRNAME,PRCHSORDR_DLVRYTO_STS,WRHS_ID,PRCHSORDR_DLVRLCTN_WRHS,PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO,TO_CHAR(PRCHSORDR_QTNDATE,'DD-MM-YYYY') PRCHSORDR_QTNDATE,PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID,PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID,PRCHSORDR_VENDOR_ADDRSS,PRCHSORDR_VENDOR_MOBILE,PRCHSORDR_VENDOR_PHONE,PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL,PRCHSORDR_VENDOR_FUTUREUSE,PRCHSORDR_VENDOR_COMMNTS,
PMS_PURCHASE_ORDER_MASTER.CPRDIV_ID,PROJECT_ID,CSTMR_ID,TO_CHAR(PRCHSORDR_REQRMNTDATE,'DD-MM-YYYY')PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY,PRCHSORDR_PO_CONTACTPRSN_ID,PRCHSORDR_PO_MOBILE,PRCHSORDR_PO_REQSTNNO,
TO_CHAR(PRCHSORDR_PO_REQSTNDATE,'DD-MM-YYYY') PRCHSORDR_PO_REQSTNDATE,TO_CHAR(PRCHSORDR_PO_APPRVLDATE,'DD-MM-YYYY') PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY,PRCHSORDR_JOBCODE,PRCHSORDR_JOBDESCRPTN,PMS_PURCHASE_ORDER_MASTER.CRNCMST_ID,PRCHSORDR_CNCL_USR_ID,
PRCHSORDR_EXCHNG_RATE,PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL,PRCHSORDR_TAX_TOTAL,PRCHSORDR_DISCOUNT,PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM,PRCHSORDR_TERM_CNDTNS,PRCHSORDR_FRGHT_TERM,CPRDIV_NAME,SUPLIR_NAME,WRKFLW_NAME,
PRCHSORDR_CONFRM_STS,PRCHSORDR_REOPN_USR_ID,PRCHSORDR_VENDOR_CONTCTNAME,
(SELECT COUNT(*) FROM FMS_SUPPLIER_CONTACT WHERE FMS_SUPPLIER_CONTACT.PRCHSORDR_ID=P_ID) "CNTCNTCT",
(SELECT COUNT(*) FROM PMS_PURCHASE_ORDER_NOTEDTLS WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID 
AND PRCHSORDRNOTE_REPLYSTS=0) "NOTECNT"
FROM PMS_PURCHASE_ORDER_MASTER 
INNER JOIN GN_CORP_DIVISIONS ON GN_CORP_DIVISIONS.CPRDIV_ID=PMS_PURCHASE_ORDER_MASTER.CPRDIV_ID
INNER JOIN FMS_SUPPLIER_MASTER ON FMS_SUPPLIER_MASTER.SUPLIR_ID=PMS_PURCHASE_ORDER_MASTER.SUPLIR_ID
INNER JOIN PMS_DOCUMNT_WRKFLW ON PMS_DOCUMNT_WRKFLW.WRKFLW_ID=PMS_PURCHASE_ORDER_MASTER.WRKFLW_ID
WHERE PRCHSORDR_ID=P_ID;
END SP_READ_PURCHS_ORDER_BYID;

PROCEDURE SP_READ_PURCHS_ORDER_DTLS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_DTL_ID,PRCHSORDR_DTL_SLNO,
PRCHSORDR_DTL_QNTY,PRCHSORDR_DTL_RATE,PRCHSORDR_DTL_TOTLAMNT,
PMS_PURCHASE_ORDER_DTLS.PRDT_ID,PRCHSORDR_DTL_DISCNTPCNT,PRCHSORDR_DTL_DISCNTAMT,PRCHSORDR_DTL_TAXID,PRCHSORDR_DTL_TAXPRCNT,
PMS_PURCHASE_ORDER_DTLS.VHCL_ID,
TO_CHAR(PRCHSORDR_DTL_STRTDATE,'DD-MM-YYYY') PRCHSORDR_DTL_STRTDATE,
TO_CHAR(PRCHSORDR_DTL_ENDDATE,'DD-MM-YYYY') PRCHSORDR_DTL_ENDDATE,
PMS_PURCHASE_ORDER_DTLS.USR_ID,
PRCHSORDR_DTL_PNRNO,PRCHSORDR_DTL_SECTOR,
TO_CHAR(PRCHSORDR_DTL_TRVLDATE,'DD-MM-YYYY') PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS,TAX_NAME,
(CASE WHEN (PRDT_CODE is not null) THEN PRDT_CODE || '-' ||upper( PRDT_NAME) ELSE upper(PRDT_NAME) END) as PRDT_NAME,
VHCL_NUMBR || '-' || VHCLCLS_NAME "VHCL_NUMBR",
USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME",
USR_CODE||'-'||USR_NAME||' '||EMPERDTL_MNAME||' '||EMPERDTL_LNAME "USR_NAME_CODE"
FROM PMS_PURCHASE_ORDER_DTLS
LEFT JOIN GN_PRODUCT_MASTER ON GN_PRODUCT_MASTER.PRDT_ID=PMS_PURCHASE_ORDER_DTLS.PRDT_ID
LEFT JOIN GN_USERS ON GN_USERS.USR_ID=PMS_PURCHASE_ORDER_DTLS.USR_ID
LEFT JOIN FLT_VEHICLES ON FLT_VEHICLES.VHCL_ID=PMS_PURCHASE_ORDER_DTLS.VHCL_ID
LEFT JOIN FLT_VEHICLE_CLASS ON FLT_VEHICLE_CLASS.VHCLCLS_ID=FLT_VEHICLES.VHCLCLS_ID
LEFT JOIN GN_TAX_MASTER ON PMS_PURCHASE_ORDER_DTLS.PRCHSORDR_DTL_TAXID=GN_TAX_MASTER.TAX_ID
WHERE PRCHSORDR_ID=P_ID AND PRCHSORDR_DTL_CNCL_USRID IS NULL ORDER BY PRCHSORDR_DTL_SLNO;
END SP_READ_PURCHS_ORDER_DTLS_BYID;

PROCEDURE SP_UPDATE_PURCHASE_ORDER(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER,
P_PRCHSORDR_DATE IN DATE,
P_PRCHSORDR_DLVRYDT IN DATE,
P_PRCHSORDR_CLIENTNAME IN VARCHAR2,
P_PRCHSORDR_ENDCSTMRNAME IN VARCHAR2,
P_PRCHSORDR_DLVRYTO_STS IN NUMBER,
P_WRHS_ID IN NUMBER,
P_PRCHSORDR_DLVRLCTN_WRHS IN VARCHAR2,
P_PRCHSORDR_DLVRLCTN_PRJCT IN VARCHAR2,
P_PRCHSORDR_QTNNO IN VARCHAR2,
P_PRCHSORDR_QTNDATE IN DATE,
P_SUPLIR_ID IN NUMBER,
P_PRCHSORDR_VENDOR_REFNO IN VARCHAR2,
P_PRCHSORDR_VENDOR_CONTCT_ID IN NUMBER,
P_PRCHSORDR_VENDOR_CONTCTNAME IN VARCHAR2,
P_PRCHSORDR_VENDOR_ADDRSS IN VARCHAR2,
P_PRCHSORDR_VENDOR_MOBILE IN VARCHAR2,
P_PRCHSORDR_VENDOR_PHONE IN VARCHAR2,
P_PRCHSORDR_VENDOR_FAX IN VARCHAR2,
P_PRCHSORDR_VENDOR_EMAIL IN VARCHAR2,
P_PRCHSORDR_VENDOR_FUTUREUSE IN NUMBER,
P_PRCHSORDR_VENDOR_COMMNTS IN VARCHAR2,
P_CPRDIV_ID IN NUMBER,
P_PROJECT_ID IN NUMBER,
P_CSTMR_ID IN NUMBER,
P_PRCHSORDR_REQRMNTDATE IN DATE,
P_PRCHSORDR_MODOFSUPPLY IN NUMBER,
P_PRCHSORDR_PO_CONTACTPRSN_ID IN NUMBER,
P_PRCHSORDR_PO_MOBILE IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNNO IN VARCHAR2,
P_PRCHSORDR_PO_REQSTNDATE IN DATE,
P_PRCHSORDR_PO_APPRVLDATE IN DATE,
P_PRCHSORDR_PRIORTY IN NUMBER,
P_PRCHSORDR_JOBCODE IN VARCHAR2,
P_PRCHSORDR_JOBDESCRPTN IN VARCHAR2,
P_CRNCMST_ID IN DECIMAL,
P_PRCHSORDR_EXCHNG_RATE IN DECIMAL,
P_PRCHSORDR_AMNT_EXCNG IN DECIMAL,
P_PRCHSORDR_GROSS_TOTAL IN DECIMAL,
P_PRCHSORDR_TAX_TOTAL IN DECIMAL,
P_PRCHSORDR_DISCOUNT IN DECIMAL,
P_PRCHSORDR_NET_TOTAL IN DECIMAL,
P_PRCHSORDR_PAYMT_TERM IN VARCHAR2,
P_PRCHSORDR_TERM_CNDTNS IN VARCHAR2,
P_PRCHSORDR_FRGHT_TERM IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_MASTER SET
WRKFLW_ID=P_WRKFLW_ID,
PRCHSORDR_DATE=P_PRCHSORDR_DATE,
PRCHSORDR_DLVRYDT=P_PRCHSORDR_DLVRYDT,
PRCHSORDR_CLIENTNAME=P_PRCHSORDR_CLIENTNAME,
PRCHSORDR_ENDCSTMRNAME=P_PRCHSORDR_ENDCSTMRNAME,
PRCHSORDR_DLVRYTO_STS=P_PRCHSORDR_DLVRYTO_STS,
WRHS_ID=P_WRHS_ID,
PRCHSORDR_DLVRLCTN_WRHS=P_PRCHSORDR_DLVRLCTN_WRHS,
PRCHSORDR_DLVRLCTN_PRJCT=P_PRCHSORDR_DLVRLCTN_PRJCT,
PRCHSORDR_QTNNO=P_PRCHSORDR_QTNNO,
PRCHSORDR_QTNDATE=P_PRCHSORDR_QTNDATE,
SUPLIR_ID=P_SUPLIR_ID,
PRCHSORDR_VENDOR_REFNO=P_PRCHSORDR_VENDOR_REFNO,
PRCHSORDR_VENDOR_CONTCTPRSN_ID=P_PRCHSORDR_VENDOR_CONTCT_ID,
PRCHSORDR_VENDOR_CONTCTNAME=P_PRCHSORDR_VENDOR_CONTCTNAME,
PRCHSORDR_VENDOR_ADDRSS=P_PRCHSORDR_VENDOR_ADDRSS,
PRCHSORDR_VENDOR_MOBILE=P_PRCHSORDR_VENDOR_MOBILE,
PRCHSORDR_VENDOR_PHONE=P_PRCHSORDR_VENDOR_PHONE,
PRCHSORDR_VENDOR_FAX=P_PRCHSORDR_VENDOR_FAX,
PRCHSORDR_VENDOR_EMAIL=P_PRCHSORDR_VENDOR_EMAIL,
PRCHSORDR_VENDOR_FUTUREUSE=P_PRCHSORDR_VENDOR_FUTUREUSE,
PRCHSORDR_VENDOR_COMMNTS=P_PRCHSORDR_VENDOR_COMMNTS,
CPRDIV_ID=P_CPRDIV_ID,
PROJECT_ID=P_PROJECT_ID,
CSTMR_ID=P_CSTMR_ID,
PRCHSORDR_REQRMNTDATE=P_PRCHSORDR_REQRMNTDATE,
PRCHSORDR_MODOFSUPPLY=P_PRCHSORDR_MODOFSUPPLY,
PRCHSORDR_PO_CONTACTPRSN_ID=P_PRCHSORDR_PO_CONTACTPRSN_ID,
PRCHSORDR_PO_MOBILE=P_PRCHSORDR_PO_MOBILE,
PRCHSORDR_PO_REQSTNNO=P_PRCHSORDR_PO_REQSTNNO,
PRCHSORDR_PO_REQSTNDATE=P_PRCHSORDR_PO_REQSTNDATE,
PRCHSORDR_PO_APPRVLDATE=P_PRCHSORDR_PO_APPRVLDATE,
PRCHSORDR_PRIORTY=P_PRCHSORDR_PRIORTY,
PRCHSORDR_JOBCODE=P_PRCHSORDR_JOBCODE,
PRCHSORDR_JOBDESCRPTN=P_PRCHSORDR_JOBDESCRPTN,
CRNCMST_ID=P_CRNCMST_ID,
PRCHSORDR_EXCHNG_RATE=P_PRCHSORDR_EXCHNG_RATE,
PRCHSORDR_AMNT_EXCNG=P_PRCHSORDR_AMNT_EXCNG,
PRCHSORDR_GROSS_TOTAL=P_PRCHSORDR_GROSS_TOTAL,
PRCHSORDR_TAX_TOTAL=P_PRCHSORDR_TAX_TOTAL,
PRCHSORDR_DISCOUNT=P_PRCHSORDR_DISCOUNT,
PRCHSORDR_NET_TOTAL=P_PRCHSORDR_NET_TOTAL,
PRCHSORDR_PAYMT_TERM=P_PRCHSORDR_PAYMT_TERM,
PRCHSORDR_TERM_CNDTNS=P_PRCHSORDR_TERM_CNDTNS,
PRCHSORDR_FRGHT_TERM=P_PRCHSORDR_FRGHT_TERM,
PRCHSORDR_UPD_USR_ID=P_USRID,
PRCHSORDR_UPD_DATE=SYSDATE
WHERE PRCHSORDR_ID=P_ID;
END SP_UPDATE_PURCHASE_ORDER;

PROCEDURE SP_UPDATE_PRODUCT_DTLS(
P_DTLID IN NUMBER,
P_ID IN NUMBER,
P_PRCHSORDR_DTL_QNTY IN DECIMAL,
P_PRCHSORDR_DTL_RATE IN DECIMAL,
P_PRCHSORDR_DTL_TOTLAMNT IN DECIMAL,
P_PRDT_ID IN NUMBER,
P_PRCHSORDR_DTL_DISCNTPCNT IN DECIMAL,
P_PRCHSORDR_DTL_DISCNTAMT IN DECIMAL,
P_PRCHSORDR_DTL_TAXID IN NUMBER,
P_PRCHSORDR_DTL_TAXPRCNT IN DECIMAL,
P_VHCL_ID IN NUMBER,
P_PRCHSORDR_DTL_STRTDATE IN DATE,
P_PRCHSORDR_DTL_ENDDATE IN DATE,
P_USR_ID IN NUMBER,
P_PRCHSORDR_DTL_PNRNO IN VARCHAR2,
P_PRCHSORDR_DTL_SECTOR IN VARCHAR2,
P_PRCHSORDR_DTL_TRVLDATE IN DATE,
P_PRCHSORDR_DTL_REMARKS IN VARCHAR2,
P_PRCHSORDR_DTL_SLNO IN NUMBER
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_DTLS SET
PRCHSORDR_DTL_QNTY=P_PRCHSORDR_DTL_QNTY,
PRCHSORDR_DTL_RATE=P_PRCHSORDR_DTL_RATE,
PRCHSORDR_DTL_TOTLAMNT=P_PRCHSORDR_DTL_TOTLAMNT,
PRDT_ID=P_PRDT_ID,
PRCHSORDR_DTL_DISCNTPCNT=P_PRCHSORDR_DTL_DISCNTPCNT,
PRCHSORDR_DTL_DISCNTAMT=P_PRCHSORDR_DTL_DISCNTAMT,
PRCHSORDR_DTL_TAXID=P_PRCHSORDR_DTL_TAXID,
PRCHSORDR_DTL_TAXPRCNT=P_PRCHSORDR_DTL_TAXPRCNT,
VHCL_ID=P_VHCL_ID,
PRCHSORDR_DTL_STRTDATE=P_PRCHSORDR_DTL_STRTDATE,
PRCHSORDR_DTL_ENDDATE=P_PRCHSORDR_DTL_ENDDATE,
USR_ID=P_USR_ID,
PRCHSORDR_DTL_PNRNO=P_PRCHSORDR_DTL_PNRNO,
PRCHSORDR_DTL_SECTOR=P_PRCHSORDR_DTL_SECTOR,
PRCHSORDR_DTL_TRVLDATE=P_PRCHSORDR_DTL_TRVLDATE,
PRCHSORDR_DTL_REMARKS=P_PRCHSORDR_DTL_REMARKS,
PRCHSORDR_DTL_SLNO=P_PRCHSORDR_DTL_SLNO
WHERE PRCHSORDR_DTL_ID=P_DTLID;
END SP_UPDATE_PRODUCT_DTLS;

PROCEDURE SP_CANCEL_PRODUCT_DTLS_ORATTCH(
P_DTLID IN NUMBER,
P_USRID IN NUMBER,
P_MODE IN NUMBER
)AS BEGIN
IF(P_MODE=0)THEN--PRODCTDTLS
UPDATE PMS_PURCHASE_ORDER_DTLS SET
PRCHSORDR_DTL_CNCL_USRID=P_USRID
WHERE PRCHSORDR_DTL_ID=P_DTLID;
ELSIF(P_MODE=1)THEN--ATTCHMNT
UPDATE PMS_PURCHASE_ORDER_ATTCHDTLS SET
PRCHSORDRATCH_CNCL_USRID=P_USRID
WHERE PRCHSORDR_ATCHID=P_DTLID;
END IF;
END SP_CANCEL_PRODUCT_DTLS_ORATTCH;

PROCEDURE SP_CONFIRM_REOPEN_PRCHS_ORDER(
P_ID IN NUMBER,
P_STATUS IN NUMBER,
P_USRID IN NUMBER,
P_WRKFLW_ID IN NUMBER
)AS BEGIN
IF(P_STATUS=1)THEN --CONFIRM

UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_CONFRM_USR_ID=P_USRID,
PRCHSORDR_CONFRM_DATE=SYSDATE,
PRCHSORDR_CONFRM_STS=1
WHERE PRCHSORDR_ID=P_ID;

INSERT INTO PMS_APPROVAL_CONSOLE_FLOATING
(
APRVLCNSLFLT_ID,
DOC_ID,
APRVLCNSLFLT_TRANSACTN_ID,
WRKFLW_ID,
USR_ID,
CORPRT_ID,
ORG_ID,
APRVLCNSLFLT_INS_USR_ID,
APRVLCNSLFLT_INS_DATE,
APRVLCNSLFLT_REF,
APRVLCNSLFLT_DATE
)
SELECT
SEQ_PMS_APRVLCNSLFLT_ID.NEXTVAL,
1,
PRCHSORDR_ID,
WRKFLW_ID,
P_USRID,
CORPRT_ID,
ORG_ID,
PRCHSORDR_INS_USR_ID,
SYSDATE,
PRCHSORDR_REF,
PRCHSORDR_DATE
FROM PMS_PURCHASE_ORDER_MASTER
WHERE PRCHSORDR_ID=P_ID
;

ELSE              --REOPEN

UPDATE PMS_PURCHASE_ORDER_MASTER SET
PRCHSORDR_REOPN_USR_ID=P_USRID,
PRCHSORDR_REOPN_DATE=SYSDATE,
PRCHSORDR_CONFRM_STS=0
WHERE PRCHSORDR_ID=P_ID;

DELETE FROM PMS_APPROVAL_CONSOLE WHERE PRCHSORDR_ID=P_ID;
DELETE FROM PMS_APPROVAL_CONSOLE_FLOATING WHERE APRVLCNSLFLT_TRANSACTN_ID=P_ID AND APRVLCNSLFLT_STS=1;

END IF;
END SP_CONFIRM_REOPEN_PRCHS_ORDER;

PROCEDURE SP_READ_CHARGEHEADS(
P_CORPID IN NUMBER,
P_ORGID IN NUMBER,
P_CHRGHDID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
IF(P_CHRGHDID=0)THEN
OPEN P_OUT FOR
SELECT CHRGHD_ID,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_CHARGE_HEADS WHERE CHRGHD_STATUS=1 AND CHRGHD_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID;
ELSE
OPEN P_OUT FOR
SELECT CHRGHD_ID,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_CHARGE_HEADS WHERE CHRGHD_STATUS=1 AND CHRGHD_CNCL_USR_ID IS NULL
AND CORPRT_ID=P_CORPID AND ORG_ID=P_ORGID AND CHRGHD_ID=P_CHRGHDID;
END IF;
END SP_READ_CHARGEHEADS;

PROCEDURE SP_INSERT_CHARGE_HEADS(
P_ID IN NUMBER,
P_CHRGHD_ID IN NUMBER,
P_PRCHSORDR_CHRGAMNT IN DECIMAL
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_CHRGDTLS
(
PRCHSORDR_CHRGID,
PRCHSORDR_ID,
CHRGHD_ID,
PRCHSORDR_CHRGAMNT
)
VALUES
(
SEQ_PMS_PRCHSORDRCHRG_ID.NEXTVAL,
P_ID,
P_CHRGHD_ID,
P_PRCHSORDR_CHRGAMNT
);
END SP_INSERT_CHARGE_HEADS;

PROCEDURE SP_INSERT_ATTCHMNTS(
P_ID IN NUMBER,
P_PRCHSORDRATCH_FILE_NAME IN VARCHAR2,
P_PRCHSORDRATCH_FILE_ACTNM IN VARCHAR2,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_ATTCHDTLS
(
PRCHSORDR_ATCHID,
PRCHSORDR_ID,
PRCHSORDRATCH_FILE_NAME,
PRCHSORDRATCH_FILE_ACTNM,
PRCHSORDRATCH_DESCRPTN
)
VALUES
(
SEQ_PMS_PRCHSORDRATCH_ID.NEXTVAL,
P_ID,
P_PRCHSORDRATCH_FILE_NAME,
P_PRCHSORDRATCH_FILE_ACTNM,
P_PRCHSORDRATCH_DESCRPTN
);
END SP_INSERT_ATTCHMNTS;

PROCEDURE SP_DELETE_CHRGHEAD(
P_ID IN NUMBER,
P_MODE IN NUMBER
)AS BEGIN
DELETE FROM PMS_PURCHASE_ORDER_CHRGDTLS WHERE PRCHSORDR_ID=P_ID;
END SP_DELETE_CHRGHEAD;

PROCEDURE SP_READ_ATTACHMENTS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT * FROM PMS_PURCHASE_ORDER_ATTCHDTLS WHERE PRCHSORDR_ID=P_ID AND PRCHSORDRATCH_CNCL_USRID IS NULL; 
END SP_READ_ATTACHMENTS_BYID;

PROCEDURE SP_READ_CHARGEHEADS_BYID(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR)AS BEGIN
OPEN P_OUT FOR
SELECT PRCHSORDR_CHRGID,PMS_PURCHASE_ORDER_CHRGDTLS.CHRGHD_ID,PRCHSORDR_CHRGAMNT,CHRGHD_NAME,CHRGHD_CALCULATE FROM PMS_PURCHASE_ORDER_CHRGDTLS 
INNER JOIN PMS_CHARGE_HEADS ON PMS_CHARGE_HEADS.CHRGHD_ID=PMS_PURCHASE_ORDER_CHRGDTLS.CHRGHD_ID
WHERE PRCHSORDR_ID=P_ID;
END SP_READ_CHARGEHEADS_BYID;

PROCEDURE SP_UPDATE_ATTCHMNTS(
P_DTLID IN NUMBER,
P_PRCHSORDRATCH_DESCRPTN IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_ATTCHDTLS SET
PRCHSORDRATCH_DESCRPTN=P_PRCHSORDRATCH_DESCRPTN
WHERE PRCHSORDR_ATCHID=P_DTLID;
END SP_UPDATE_ATTCHMNTS;

PROCEDURE SP_INSERT_COMMENTDTLS(
P_ID IN NUMBER,
P_PRCHSORDRCMNT_VISBLSTS IN NUMBER,
P_PRCHSORDRCMNT_COMMENT IN VARCHAR2,
P_USRID IN NUMBER
)
AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_COMMENTDTLS
(
PRCHSORDR_CMNTID,
PRCHSORDR_ID,
PRCHSORDRCMNT_VISBLSTS,
PRCHSORDRCMNT_COMMENT,
PRCHSORDRCMNT_INS_USR_ID,
PRCHSORDRCMNT_INS_DATE
)
VALUES(
SEQ_PMS_PRCHSORDRCMNT_ID.NEXTVAL,
P_ID,
P_PRCHSORDRCMNT_VISBLSTS,
P_PRCHSORDRCMNT_COMMENT,
P_USRID,
CURRENT_TIMESTAMP
);
END SP_INSERT_COMMENTDTLS;


PROCEDURE SP_READ_COMMENTDTLS(
P_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
OPEN P_OUT FOR
SELECT PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDR_CMNTID,PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_VISBLSTS,
PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_COMMENT,PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_USR_ID,
PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_DATE,GN_USERS.USR_NAME||' '||GN_USERS.EMPERDTL_MNAME||' '||GN_USERS.EMPERDTL_LNAME "USR_NAME"
FROM PMS_PURCHASE_ORDER_COMMENTDTLS
INNER JOIN GN_USERS ON PMS_PURCHASE_ORDER_COMMENTDTLS.PRCHSORDRCMNT_INS_USR_ID=GN_USERS.USR_ID 
WHERE PRCHSORDR_ID=P_ID ORDER BY PRCHSORDRCMNT_INS_DATE ASC;

END SP_READ_COMMENTDTLS;

PROCEDURE SP_READ_NOTEDTLS(
P_ID IN NUMBER,
P_USRID IN NUMBER,
P_REPLYSTS IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_REPLYSTS=0)THEN
OPEN P_OUT FOR----NOT REPLIED----
SELECT PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID,PRCHSORDRNOTE_MSG,PRCHSORDRNOTE_INS_USR_ID,PRCHSORDR_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
PRCHSORDRNOTE_REPLY_MSG,PMS_PURCHASE_ORDER_NOTE_ATTACH.PRCHSORDR_NOTEID "ATTCH_NOTEID",
PRCHSORDRATCHNT_FILENM,PRCHSORDRATCHNT_FILEACTNM,PRCHSORDRATCHNT_TYPE,PRCHSORDR_REF,
PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID "REPLY_FRM_USRID",PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID "REPLY_TO_USRID"
FROM PMS_PURCHASE_ORDER_NOTEDTLS 
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_PURCHASE_ORDER_NOTE_ATTACH ON PMS_PURCHASE_ORDER_NOTE_ATTACH.PRCHSORDR_NOTEID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID AND PRCHSORDRATCHNT_TYPE=0
WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=P_ID AND PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID=P_USRID 
AND PRCHSORDRNOTE_REPLYSTS=0
UNION
SELECT PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID "PRCHSORDR_NOTEID",APRVLCNSLNOTE_MSG "PRCHSORDRNOTE_MSG",APRVLCNSLNOTE_INS_USR_ID "PRCHSORDRNOTE_INS_USR_ID",APRVLCNSL_INS_USR_ID "PRCHSORDR_INS_USR_ID",
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
APRVLCNSLNOTE_REPLY_MSG "PRCHSORDRNOTE_REPLY_MSG",PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID "ATTCH_NOTEID",
APRVLCNSLATCHNT_FILENM "PRCHSORDRATCHNT_FILENM",APRVLCNSLATCHNT_FILEACTNM "PRCHSORDRATCHNT_FILEACTNM",APRVLCNSLATCHNT_TYPE "PRCHSORDRATCHNT_TYPE",PRCHSORDR_REF,
PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID "REPLY_FRM_USRID",PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID "REPLY_TO_USRID"
FROM PMS_APPROVAL_CONSOLE_NOTEDTLS 
INNER JOIN PMS_APPROVAL_CONSOLE ON PMS_APPROVAL_CONSOLE.APRVLCNSL_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_APPROVAL_CONSOLE.PRCHSORDR_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_APPROVAL_CONSOLE_NOTEATTCH ON PMS_APPROVAL_CONSOLE_NOTEATTCH.APRVLCNSL_NOTEID=PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSLNOTE_ID AND APRVLCNSLATCHNT_TYPE=0
WHERE PMS_APPROVAL_CONSOLE_NOTEDTLS.APRVLCNSL_ID=P_ID AND PMS_APPROVAL_CONSOLE_NOTEDTLS.USR_ID=P_USRID 
AND APRVLCNSLNOTE_REPLYSTS=0
ORDER BY PRCHSORDR_NOTEID DESC;
ELSE
OPEN P_OUT FOR----REPLIED----
SELECT PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID,PRCHSORDRNOTE_MSG,PRCHSORDRNOTE_INS_USR_ID,PRCHSORDR_INS_USR_ID,
noteuser.USR_NAME||' '||noteuser.EMPERDTL_MNAME||' '||noteuser.EMPERDTL_LNAME "REPLY_FRM_USRNAME",
replyuser.USR_NAME||' '||replyuser.EMPERDTL_MNAME||' '||replyuser.EMPERDTL_LNAME "REPLY_TO_USRNAME",
PRCHSORDRNOTE_REPLY_MSG,PMS_PURCHASE_ORDER_NOTE_ATTACH.PRCHSORDR_NOTEID "ATTCH_NOTEID",
PRCHSORDRATCHNT_FILENM,PRCHSORDRATCHNT_FILEACTNM,PRCHSORDRATCHNT_TYPE,PRCHSORDR_REF,
PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID "REPLY_FRM_USRID",PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID "REPLY_TO_USRID"
FROM PMS_PURCHASE_ORDER_NOTEDTLS 
LEFT JOIN PMS_PURCHASE_ORDER_MASTER ON PMS_PURCHASE_ORDER_MASTER.PRCHSORDR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID
LEFT JOIN GN_USERS noteuser ON noteuser.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID     --REPLY_FRM_USER--
LEFT JOIN GN_USERS replyuser ON replyuser.USR_ID=PMS_PURCHASE_ORDER_NOTEDTLS.USR_ID                     --REPLY_TO_USER--
LEFT JOIN PMS_PURCHASE_ORDER_NOTE_ATTACH ON PMS_PURCHASE_ORDER_NOTE_ATTACH.PRCHSORDR_NOTEID=PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID AND PRCHSORDRATCHNT_TYPE=1
WHERE PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_ID=P_ID AND PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDRNOTE_INS_USR_ID=P_USRID
AND PRCHSORDRNOTE_REPLYSTS=1
ORDER BY PMS_PURCHASE_ORDER_NOTEDTLS.PRCHSORDR_NOTEID DESC;
END IF;
END SP_READ_NOTEDTLS;

PROCEDURE SP_INSERT_NOTE(
P_ID IN NUMBER,
P_TO_USRID IN NUMBER,
P_PRCHSORDRNOTE_MSG IN VARCHAR2,
P_FROM_USRID IN NUMBER,
P_OUT_NOTEID OUT NUMBER
)AS BEGIN
SELECT SEQ_PMS_PRCHSORDRNOTE_ID.NEXTVAL INTO P_OUT_NOTEID FROM DUAL;

INSERT INTO PMS_PURCHASE_ORDER_NOTEDTLS
(
PRCHSORDR_NOTEID,
PRCHSORDR_ID,
USR_ID,
PRCHSORDRNOTE_MSG,
PRCHSORDRNOTE_INS_USR_ID,
PRCHSORDRNOTE_INS_DATE
)
VALUES
(
P_OUT_NOTEID,
P_ID,
P_TO_USRID,
P_PRCHSORDRNOTE_MSG,
P_FROM_USRID,
SYSDATE
);
END SP_INSERT_NOTE;

PROCEDURE SP_INSERT_NOTE_ATTCH(
P_NOTEID IN NUMBER,
P_PRCHSORDRATCHNT_FILENM IN VARCHAR2,
P_PRCHSORDRATCHNT_FILEACTNM IN VARCHAR2,
P_PRCHSORDRATCHNT_TYPE IN NUMBER
)AS BEGIN
INSERT INTO PMS_PURCHASE_ORDER_NOTE_ATTACH
(
PRCHSORDR_NTATCHID,
PRCHSORDR_NOTEID,
PRCHSORDRATCHNT_FILENM,
PRCHSORDRATCHNT_FILEACTNM,
PRCHSORDRATCHNT_TYPE
)
VALUES
(
SEQ_PMS_PRCHSORDRNTATCH_ID.NEXTVAL,
P_NOTEID,
P_PRCHSORDRATCHNT_FILENM,
P_PRCHSORDRATCHNT_FILEACTNM,
P_PRCHSORDRATCHNT_TYPE
);
END SP_INSERT_NOTE_ATTCH;

PROCEDURE SP_UPDATE_REPLYNOTE(
P_NOTEID IN NUMBER,
P_PRCHSORDRNOTE_REPLY_MSG IN VARCHAR2
)AS BEGIN
UPDATE PMS_PURCHASE_ORDER_NOTEDTLS SET
PRCHSORDRNOTE_REPLYSTS=1,
PRCHSORDRNOTE_REPLY_MSG=P_PRCHSORDRNOTE_REPLY_MSG,
PRCHSORDRNOTE_REPLY_DATE=SYSDATE
WHERE PRCHSORDR_NOTEID=P_NOTEID;
END SP_UPDATE_REPLYNOTE;

PROCEDURE SP_INSERT_SUPPLIER_CONTACT(
L_SUPLIER_ID IN NUMBER,
L_CONTACTNAME IN VARCHAR2,
L_CONTACTADDRESS IN VARCHAR2,
L_CONTACTMOBILE IN VARCHAR2,
L_CONTACTPHONE IN VARCHAR2,
L_CONTACTWEBSITE IN VARCHAR2,
L_CONTACTEMAIL IN VARCHAR2,
L_ID IN NUMBER
)AS BEGIN

INSERT INTO FMS_SUPPLIER_CONTACT
(
SUPLIR_CNTCT_ID,
SUPLIR_ID,
SUPLIR_CNTCT_NAME,
SUPLIR_CNTCT_ADDRESS,
SUPLIR_CNTCT_MOBILE,
SUPLIR_CNTCT_PHONE,
SUPLIR_CNTCT_WEBSITE,
SUPLIR_CNTCT_EMAIL,
PRCHSORDR_ID
)
VALUES
(
SEQ_SUPLIR_CONTACT.NEXTVAL,
L_SUPLIER_ID,
L_CONTACTNAME,
L_CONTACTADDRESS,
L_CONTACTMOBILE,
L_CONTACTPHONE,
L_CONTACTWEBSITE,
L_CONTACTEMAIL,
L_ID
);
END SP_INSERT_SUPPLIER_CONTACT;

PROCEDURE SP_DELETE_SUPPLIER_CONTACT(
L_ID IN NUMBER
)AS BEGIN
DELETE FROM FMS_SUPPLIER_CONTACT WHERE PRCHSORDR_ID=L_ID;
END SP_DELETE_SUPPLIER_CONTACT;

PROCEDURE SP_READ_CONTACTDTLS_BYID(
P_MODE IN NUMBER, 
P_CONTACT_ID IN NUMBER,
P_OUT OUT SYS_REFCURSOR
)AS BEGIN
IF(P_MODE=0)THEN--VENDOR
OPEN P_OUT FOR
SELECT SUPLIR_CNTCT_ID "CNTCT_ID",SUPLIR_CNTCT_NAME "CNTCT_NAME",SUPLIR_CNTCT_ADDRESS "CNTCT_ADDRSS",SUPLIR_CNTCT_MOBILE "CNTCT_MOBILE",
SUPLIR_CNTCT_PHONE "CNTCT_PHONE",SUPLIR_CNTCT_WEBSITE "CNTC_WEBSITE",SUPLIR_CNTCT_EMAIL "CNTC_EMAIL"
FROM FMS_SUPPLIER_CONTACT WHERE SUPLIR_CNTCT_ID=P_CONTACT_ID;
ELSE
OPEN P_OUT FOR--CSTMR
SELECT CSTMRCNT_ID "CNTCT_ID",CSTMRCNT_NAME "CNTCT_NAME",CSTMRCNT_ADDRESS "CNTCT_ADDRSS",CSTMRCNT_MOBILE "CNTCT_MOBILE",
CSTMRCNT_PHONE "CNTCT_PHONE",CSTMRCNT_EMAIL "CNTC_EMAIL",CSTMRCNT_WEBSITE "CNTC_WEBSITE" 
FROM GN_CUSTOMER_CONTACT WHERE CSTMRCNT_ID=P_CONTACT_ID;
END IF;
END SP_READ_CONTACTDTLS_BYID;



END PMS_PURCHASE_ORDER;

/
